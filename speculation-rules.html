<!doctype html><html lang="en">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <title>Speculation Rules</title>
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <link href="https://www.w3.org/StyleSheets/TR/2021/cg-draft" rel="stylesheet">
  <meta content="Bikeshed version 7a96e07ec, updated Mon Jul 14 11:12:36 2025 -0700" name="generator">
  <link href="https://wicg.github.io/nav-speculation/speculation-rules.html" rel="canonical">
  <meta content="dark light" name="color-scheme">
  <link href="https://www.w3.org/StyleSheets/TR/2021/dark.css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css">
<style>
/* domintro from https://resources.whatwg.org/standard.css */
.domintro {
  position: relative;
  color: green;
  background: #DDFFDD;
  margin: 2.5em 0 2em 0;
  padding: 1.5em 1em 0.5em 2em;
}

.domintro dt, .domintro dt * {
  color: black;
  font-size: inherit;
}
.domintro dd {
  margin: 0.5em 0 1em 2em; padding: 0;
}
.domintro dd p {
  margin: 0.5em 0;
}
.domintro::before {
  content: 'For web developers (non-normative)';
  background: green;
  color: white;
  padding: 0.15em 0.25em;
  font-style: normal;
  position: absolute;
  top: -0.8em;
  left: -0.8em;
}

/* dl.props from https://resources.whatwg.org/standard.css */
dl.props { display: grid; grid-template-columns: max-content auto; row-gap: 0.25em; column-gap: 1em; }
dl.props > dt { grid-column-start: 1; margin: 0; }
dl.props > dd { grid-column-start: 2; margin: 0; }
p + dl.props { margin-top: -0.5em; }
</style>
<style>/* Boilerplate: style-autolinks */
.css.css, .property.property, .descriptor.descriptor {
    color: var(--a-normal-text);
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}

@media (prefers-color-scheme: dark) {
    :root {
        --selflink-text: black;
        --selflink-bg: silver;
        --selflink-hover-text: white;
    }
}
</style>
<style>/* Boilerplate: style-colors */
/* Any --*-text not paired with a --*-bg is assumed to have a transparent bg */
:root {
    color-scheme: light dark;

    --text: black;
    --bg: white;

    --unofficial-watermark: url(https://www.w3.org/StyleSheets/TR/2016/logos/UD-watermark);

    --logo-bg: #1a5e9a;
    --logo-active-bg: #c00;
    --logo-text: white;

    --tocnav-normal-text: #707070;
    --tocnav-normal-bg: var(--bg);
    --tocnav-hover-text: var(--tocnav-normal-text);
    --tocnav-hover-bg: #f8f8f8;
    --tocnav-active-text: #c00;
    --tocnav-active-bg: var(--tocnav-normal-bg);

    --tocsidebar-text: var(--text);
    --tocsidebar-bg: #f7f8f9;
    --tocsidebar-shadow: rgba(0,0,0,.1);
    --tocsidebar-heading-text: hsla(203,20%,40%,.7);

    --toclink-text: var(--text);
    --toclink-underline: #3980b5;
    --toclink-visited-text: var(--toclink-text);
    --toclink-visited-underline: #054572;

    --heading-text: #005a9c;

    --hr-text: var(--text);

    --algo-border: #def;

    --del-text: red;
    --del-bg: transparent;
    --ins-text: #080;
    --ins-bg: transparent;

    --a-normal-text: #034575;
    --a-normal-underline: #bbb;
    --a-visited-text: var(--a-normal-text);
    --a-visited-underline: #707070;
    --a-hover-bg: rgba(75%, 75%, 75%, .25);
    --a-active-text: #c00;
    --a-active-underline: #c00;

    --blockquote-border: silver;
    --blockquote-bg: transparent;
    --blockquote-text: currentcolor;

    --issue-border: #e05252;
    --issue-bg: #fbe9e9;
    --issue-text: var(--text);
    --issueheading-text: #831616;

    --example-border: #e0cb52;
    --example-bg: #fcfaee;
    --example-text: var(--text);
    --exampleheading-text: #574b0f;

    --note-border: #52e052;
    --note-bg: #e9fbe9;
    --note-text: var(--text);
    --noteheading-text: hsl(120, 70%, 30%);
    --notesummary-underline: silver;

    --assertion-border: #aaa;
    --assertion-bg: #eee;
    --assertion-text: black;

    --advisement-border: orange;
    --advisement-bg: #fec;
    --advisement-text: var(--text);
    --advisementheading-text: #b35f00;

    --warning-border: red;
    --warning-bg: hsla(40,100%,50%,0.95);
    --warning-text: var(--text);

    --amendment-border: #330099;
    --amendment-bg: #F5F0FF;
    --amendment-text: var(--text);
    --amendmentheading-text: #220066;

    --def-border: #8ccbf2;
    --def-bg: #def;
    --def-text: var(--text);
    --defrow-border: #bbd7e9;

    --datacell-border: silver;

    --indexinfo-text: #707070;

    --indextable-hover-text: black;
    --indextable-hover-bg: #f7f8f9;

    --outdatedspec-bg: rgba(0, 0, 0, .5);
    --outdatedspec-text: black;
    --outdated-bg: maroon;
    --outdated-text: white;
    --outdated-shadow: red;

    --editedrec-bg: darkorange;
}

@media (prefers-color-scheme: dark) {
    :root {
        --text: #ddd;
        --bg: black;

        --unofficial-watermark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='%23100808' transform='translate(200 200) rotate(-45) translate(-200 -200)' stroke='%23100808' stroke-width='3'%3E%3Ctext x='50%25' y='220' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EUNOFFICIAL%3C/text%3E%3Ctext x='50%25' y='305' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EDRAFT%3C/text%3E%3C/g%3E%3C/svg%3E");

        --logo-bg: #1a5e9a;
        --logo-active-bg: #c00;
        --logo-text: white;

        --tocnav-normal-text: #999;
        --tocnav-normal-bg: var(--bg);
        --tocnav-hover-text: var(--tocnav-normal-text);
        --tocnav-hover-bg: #080808;
        --tocnav-active-text: #f44;
        --tocnav-active-bg: var(--tocnav-normal-bg);

        --tocsidebar-text: var(--text);
        --tocsidebar-bg: #080808;
        --tocsidebar-shadow: rgba(255,255,255,.1);
        --tocsidebar-heading-text: hsla(203,20%,40%,.7);

        --toclink-text: var(--text);
        --toclink-underline: #6af;
        --toclink-visited-text: var(--toclink-text);
        --toclink-visited-underline: #054572;

        --heading-text: #8af;

        --hr-text: var(--text);

        --algo-border: #456;

        --del-text: #f44;
        --del-bg: transparent;
        --ins-text: #4a4;
        --ins-bg: transparent;

        --a-normal-text: #6af;
        --a-normal-underline: #555;
        --a-visited-text: var(--a-normal-text);
        --a-visited-underline: var(--a-normal-underline);
        --a-hover-bg: rgba(25%, 25%, 25%, .2);
        --a-active-text: #f44;
        --a-active-underline: var(--a-active-text);

        --borderedblock-bg: rgba(255, 255, 255, .05);

        --blockquote-border: silver;
        --blockquote-bg: var(--borderedblock-bg);
        --blockquote-text: currentcolor;

        --issue-border: #e05252;
        --issue-bg: var(--borderedblock-bg);
        --issue-text: var(--text);
        --issueheading-text: hsl(0deg, 70%, 70%);

        --example-border: hsl(50deg, 90%, 60%);
        --example-bg: var(--borderedblock-bg);
        --example-text: var(--text);
        --exampleheading-text: hsl(50deg, 70%, 70%);

        --note-border: hsl(120deg, 100%, 35%);
        --note-bg: var(--borderedblock-bg);
        --note-text: var(--text);
        --noteheading-text: hsl(120, 70%, 70%);
        --notesummary-underline: silver;

        --assertion-border: #444;
        --assertion-bg: var(--borderedblock-bg);
        --assertion-text: var(--text);

        --advisement-border: orange;
        --advisement-bg: #222218;
        --advisement-text: var(--text);
        --advisementheading-text: #f84;

        --warning-border: red;
        --warning-bg: hsla(40,100%,20%,0.95);
        --warning-text: var(--text);

        --amendment-border: #330099;
        --amendment-bg: #080010;
        --amendment-text: var(--text);
        --amendmentheading-text: #cc00ff;

        --def-border: #8ccbf2;
        --def-bg: #080818;
        --def-text: var(--text);
        --defrow-border: #136;

        --datacell-border: silver;

        --indexinfo-text: #aaa;

        --indextable-hover-text: var(--text);
        --indextable-hover-bg: #181818;

        --outdatedspec-bg: rgba(255, 255, 255, .5);
        --outdatedspec-text: black;
        --outdated-bg: maroon;
        --outdated-text: white;
        --outdated-shadow: red;

        --editedrec-bg: darkorange;
    }
    /* In case a transparent-bg image doesn't expect to be on a dark bg,
       which is quite common in practice... */
    img { background: white; }
}
</style>
<style>/* Boilerplate: style-counters */
body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example" counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}
</style>
<style>/* Boilerplate: style-dfn-panel */
:root {
    --dfnpanel-bg: #ddd;
    --dfnpanel-text: var(--text);
    --dfnpanel-target-bg: #ffc;
    --dfnpanel-target-outline: orange;
}
@media (prefers-color-scheme: dark) {
    :root {
        --dfnpanel-bg: #222;
        --dfnpanel-text: var(--text);
        --dfnpanel-target-bg: #333;
        --dfnpanel-target-outline: silver;
    }
}
.dfn-panel {
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--dfnpanel-bg);
    color: var(--dfnpanel-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: var(--dfnpanel-text); }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel a:focus {
    outline: 5px auto Highlight;
    outline: 5px auto -webkit-focus-ring-color;
}
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0 0 0 1em; list-style: none; }
.dfn-panel li a {
    max-width: calc(300px - 1.5em - 1em);
    overflow: hidden;
    text-overflow: ellipsis;
}

.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: 8px;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
    transition: left 1s ease-out, bottom 1s ease-out;
}

.dfn-panel .link-item:hover {
    text-decoration: underline;
}
.dfn-panel .link-item .copy-icon {
    opacity: 0;
}
.dfn-panel .link-item:hover .copy-icon,
.dfn-panel .link-item .copy-icon:focus {
    opacity: 1;
}

.dfn-panel .copy-icon {
    display: inline-block;
    margin-right: 0.5em;
    width: 0.85em;
    height: 1em;
    border-radius: 3px;
    background-color: #ccc;
    cursor: pointer;
}

.dfn-panel .copy-icon .icon {
    width: 100%;
    height: 100%;
    background-color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}

.dfn-panel .copy-icon .icon::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 1px solid black;
    background-color: #ccc;
    opacity: 0.25;
    transform: translate(3px, -3px);
}

.dfn-panel .copy-icon:active .icon::before {
    opacity: 1;
}

.dfn-paneled[role="button"] { cursor: help; }

.highlighted {
    animation: target-fade 3s;
}

@keyframes target-fade {
    from {
        background-color: var(--dfnpanel-target-bg);
        outline: 5px solid var(--dfnpanel-target-outline);
    }
    to {
        color: var(--a-normal-text);
        background-color: transparent;
        outline: transparent;
    }
}
</style>
<style>/* Boilerplate: style-issues */
a[href].issue-return {
    float: right;
    float: inline-end;
    color: var(--issueheading-text);
    font-weight: bold;
    text-decoration: none;
}
</style>
<style>/* Boilerplate: style-md-lists */
/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}
</style>
<style>/* Boilerplate: style-ref-hints */
:root {
    --ref-hint-bg: #ddd;
    --ref-hint-text: var(--text);
}
@media (prefers-color-scheme: dark) {
    :root {
        --ref-hint-bg: #222;
        --ref-hint-text: var(--text);
    }
}

.ref-hint {
    display: inline-block;
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.5em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--ref-hint-bg);
    color: var(--ref-hint-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}

.ref-hint * { margin: 0; padding: 0; text-indent: 0; }

.ref-hint ul { padding: 0 0 0 1em; list-style: none; }
</style>
<style>/* Boilerplate: style-selflinks */
:root {
    --selflink-text: white;
    --selflink-bg: gray;
    --selflink-hover-text: black;
}
.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
.example > a.self-link,
.note > a.self-link,
.issue > a.self-link {
    /* These blocks are overflow:auto, so positioning outside
       doesn't work. */
    left: auto;
    right: 0;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: var(--selflink-bg);
    color: var(--selflink-text);
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: var(--selflink-hover-text);
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }
</style>
<style>/* Boilerplate: style-var-click-highlighting */
/*
Colors were chosen in Lab using https://nixsensor.com/free-color-converter/
D50 2deg illuminant, L in [0,100], a and b in [-128, 128]
0 = lab(85,0,85)
1 = lab(85,80,30)
2 = lab(85,-40,40)
3 = lab(85,-50,0)
4 = lab(85,5,15)
5 = lab(85,-10,-50)
6 = lab(85,35,-15)

For darkmode:
0 = oklab(50%   0%  108%)
1 = oklab(50% -51%   51%)
2 = oklab(50% -64%  -20%)
3 = oklab(50%   6%   19%)
4 = oklab(50% -12%  -64%)
5 = oklab(50%  44%  -19%)  
6 = oklab(50% 102%   38%)
*/

[data-algorithm] var { cursor: pointer; }
var[data-var-color] { background-color: var(--var-bg); box-shadow: 0 0 0 2px var(--var-bg); }

var[data-var-color] { --var-bg: #F4D200; }
var[data-var-color="1"] { --var-bg: #FF87A2; }
var[data-var-color="2"] { --var-bg: #96E885; }
var[data-var-color="3"] { --var-bg: #3EEED2; }
var[data-var-color="4"] { --var-bg: #EACFB6; }
var[data-var-color="5"] { --var-bg: #82DDFF; }
var[data-var-color="6"] { --var-vg: #FFBCF2; }

@media (prefers-color-scheme: dark) {
	var[data-var-color] { --var-bg: #bc1a00; }
	var[data-var-color="1"] { --var-bg: #007f00; }
	var[data-var-color="2"] { --var-bg: #008698; }
	var[data-var-color="3"] { --var-bg: #7f5b2b; }
	var[data-var-color="4"] { --var-bg: #004df3; }
	var[data-var-color="5"] { --var-bg: #a1248a; }
	var[data-var-color="6"] { --var-vg: #ff0000; }
}
</style>
 <body class="h-entry">
  <div class="head">
   <h1 class="p-name no-ref" id="title">Speculation Rules</h1>
   <p id="w3c-state"><a href="https://www.w3.org/standards/types/#CG-DRAFT">Draft Community Group Report</a>,
    <time class="dt-updated" datetime="2025-07-27">27 July 2025</time></p>
   <div data-fill-with="spec-metadata">
    <dl>
     <dt>This version:
     <dd><a class="u-url" href="https://wicg.github.io/nav-speculation/speculation-rules.html">https://wicg.github.io/nav-speculation/speculation-rules.html</a>
     <dt>Issue Tracking:
     <dd><a href="https://github.com/WICG/nav-speculation/issues/">GitHub</a>
     <dt class="editor">Editors:
     <dd class="editor p-author h-card vcard"><a class="p-name fn u-email email" href="mailto:jbroman@chromium.org">Jeremy Roman</a> (<a class="p-org org" href="https://www.google.com/">Google</a>)
     <dd class="editor p-author h-card vcard"><a class="p-name fn u-email email" href="mailto:d@domenic.me">Domenic Denicola</a> (<a class="p-org org" href="https://www.google.com/">Google</a>)
    </dl>
   </div>
   <div data-fill-with="warning"></div>
   <p class="copyright" data-fill-with="copyright"><a href="https://www.w3.org/policies/#copyright">Copyright</a> © 2025 the Contributors to the Speculation Rules Specification, published by the <a href="https://www.w3.org/community/wicg/">Web Platform Incubator Community Group</a> under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a>.
A human-readable <a href="http://www.w3.org/community/about/agreements/cla-deed/">summary</a> is available.
</p>
   <hr title="Separator for header">
  </div>
  <div class="p-summary" data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>Extensions to speculation rules to support navigational prerendering.</p>
  </div>
  <div data-fill-with="at-risk"></div>
  <h2 class="no-num no-toc no-ref heading settled" id="status"><span class="content">Status of this document</span></h2>
  <div data-fill-with="status">
   <p>
  This specification was published by the <a href="https://www.w3.org/community/wicg/">Web Platform Incubator Community Group</a>.
  It is not a W3C Standard nor is it on the W3C Standards Track.

  Please note that under the
  <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a>
  there is a limited opt-out and other conditions apply.

  Learn more about
  <a href="http://www.w3.org/community/">W3C Community and Business Groups</a>.
</p>
   <p></p>
  </div>
  <div data-fill-with="at-risk"></div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li><a href="#moving-to-html"><span class="secno">1</span> <span class="content">This specification is moving to HTML</span></a>
    <li><a href="#speculation-rules-parsing"><span class="secno">2</span> <span class="content">Parsing</span></a>
    <li><a href="#speculation-rules-processing"><span class="secno">3</span> <span class="content">Processing model</span></a>
    <li>
     <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
     <ol class="toc">
      <li><a href="#index-defined-here"><span class="secno"></span> <span class="content">Terms defined by this specification</span></a>
      <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span class="content">Terms defined by reference</span></a>
     </ol>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#normative"><span class="secno"></span> <span class="content">Normative References</span></a>
     </ol>
   </ol>
  </nav>
  <main>
   <h2 class="heading settled" data-level="1" id="moving-to-html"><span class="secno">1. </span><span class="content">This specification is moving to HTML</span><a class="self-link" href="#moving-to-html"></a></h2>
   <p>The majority of this specification is being upstreamed to the HTML Standard: see <a href="https://github.com/whatwg/html/pull/11426">whatwg/html#11426</a> and <a href="https://github.com/whatwg/html/issues/11123">whatwg/html#11123</a>. The rendered specification text can currently be found at <a href="https://whatpr.org/html/11426/speculative-loading.html">this PR preview</a>.</p>
   <p>What remains in this document are some additional patches to support prerendering, which the upstreamed version does not yet cover. Once prefetch is also upstreamed, what remains in this document will likely migrate to <a data-link-type="biblio" href="#biblio-prerendering-revamped" title="Prerendering Revamped">[PRERENDERING-REVAMPED]</a>.</p>
   <h2 class="heading settled" data-level="2" id="speculation-rules-parsing"><span class="secno">2. </span><span class="content">Parsing</span><a class="self-link" href="#speculation-rules-parsing"></a></h2>
   <p>Extend the <a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#speculation-rule-set" id="ref-for-speculation-rule-set">speculation rule set</a> <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#struct" id="ref-for-struct">struct</a> with one additional <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#struct-item" id="ref-for-struct-item">item</a>:</p>
   <ul>
    <li data-md>
     <p><dfn class="dfn-paneled" data-dfn-for="speculation rule set" data-dfn-type="dfn" data-noexport id="speculation-rule-set-prerender-rules">prerender rules</dfn>, a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list">list</a> of <a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#speculation-rule" id="ref-for-speculation-rule">speculation rules</a>, initially empty</p>
   </ul>
   <p>Extend the <a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#speculation-rule" id="ref-for-speculation-rule①">speculation rule</a> <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#struct" id="ref-for-struct①">struct</a> with one additional <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#struct-item" id="ref-for-struct-item①">item</a>:</p>
   <ul>
    <li data-md>
     <p><dfn class="dfn-paneled" data-dfn-for="speculation rule" data-dfn-type="dfn" data-noexport id="speculation-rule-target-navigable-name-hint">target navigable name hint</dfn>, a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#string" id="ref-for-string">string</a> or null</p>
   </ul>
   <div class="algorithm" data-algorithm="parse a speculation rule set string">
    
  Modify <a data-link-type="dfn" data-refhint-key="50adabbe" href="https://whatpr.org/html/11426/speculative-loading.html#speculation-rule-set" id="ref-for-speculation-rule-set①">parse a speculation rule set string</a> as follows:


    <ul>
     <li data-md>
      <p>Remove the <var>typesToTreatAsPrefetch</var> construct, and instead parse <var>parsed</var>["<code>prerender</code>"] into the <a data-link-type="dfn" href="#speculation-rule-set-prerender-rules" id="ref-for-speculation-rule-set-prerender-rules">prerender rules</a> list, in an identical manner to what is done for <var>parsed</var>["<code>prefetch</code>"] and the <a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#sr-set-prefetch" id="ref-for-sr-set-prefetch">prefetch rules</a>.</p>
     <li data-md>
      <p>Discard rules parsed from <var>parsed</var>["<code>prefetch</code>"] if the <a data-link-type="dfn" href="#speculation-rule-target-navigable-name-hint" id="ref-for-speculation-rule-target-navigable-name-hint">target navigable name hint</a> is not null.</p>
    </ul>
    <p class="note" role="note">Implementations will still be allowed to treat prerender candidates as prefetches, per the modifications in <a href="#speculation-rules-processing">§ 3 Processing model</a>.</p>
   </div>
   <div class="algorithm" data-algorithm="parse a speculation rule">
    
  Modify <a data-link-type="dfn" data-refhint-key="9dbd0ebb" href="https://whatpr.org/html/11426/speculative-loading.html#speculation-rule" id="ref-for-speculation-rule②">parse a speculation rule</a> by adding the following steps:


    <ol>
     <li data-md>
      <p>Let <var>targetHint</var> be null.</p>
     <li data-md>
      <p>If <var>input</var>["<code>target_hint</code>"] <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#map-exists" id="ref-for-map-exists">exists</a>:</p>
      <ol>
       <li data-md>
        <p>If <var>input</var>["<code>target_hint</code>"] is not a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#valid-navigable-target-name-or-keyword" id="ref-for-valid-navigable-target-name-or-keyword">valid navigable target name or keyword</a>:</p>
        <ol>
         <li data-md>
          <p>The user agent may <a data-link-type="dfn" href="https://console.spec.whatwg.org/#report-a-warning-to-the-console" id="ref-for-report-a-warning-to-the-console">report a warning to the console</a> indicating that the supplied target hint was invalid.</p>
         <li data-md>
          <p>Return null.</p>
        </ol>
       <li data-md>
        <p>Set <var>targetHint</var> to <var>input</var>["<code>target_hint</code>"].</p>
      </ol>
    </ol>
    <p>and then updating the final step which returns a <a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#speculation-rule" id="ref-for-speculation-rule③">speculation rule</a> to include setting the <a data-link-type="dfn" href="#speculation-rule-target-navigable-name-hint" id="ref-for-speculation-rule-target-navigable-name-hint①">target navigable name hint</a> to <var>targetHint</var>.</p>
   </div>
   <h2 class="heading settled" data-level="3" id="speculation-rules-processing"><span class="secno">3. </span><span class="content">Processing model</span><a class="self-link" href="#speculation-rules-processing"></a></h2>
   <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="prerender-candidate">prerender candidate</dfn> is a <a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#speculative-load-candidate" id="ref-for-speculative-load-candidate">speculative load candidate</a> with the following additional <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#struct-item" id="ref-for-struct-item②">item</a>:</p>
   <ul>
    <li data-md>
     <p><dfn class="dfn-paneled" data-dfn-for="prerender candidate" data-dfn-type="dfn" data-noexport id="prerender-candidate-target-navigable-name-hint">target navigable name hint</dfn>, a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#valid-navigable-target-name-or-keyword" id="ref-for-valid-navigable-target-name-or-keyword①">valid navigable target name or keyword</a> or null</p>
   </ul>
   <div class="algorithm" data-algorithm="inner consider speculative loads steps">
    
  Update the <a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#inner-consider-speculative-loads-steps" id="ref-for-inner-consider-speculative-loads-steps">inner consider speculative loads steps</a> algorithm by appending the following steps near the beginning, after assembling <var>prefetchCandidates</var>:


    <ol>
     <li data-md>
      <p>Let <var>prerenderCandidates</var> be an empty <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list①">list</a>.</p>
     <li data-md>
      <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-iterate" id="ref-for-list-iterate">For each</a> <var>ruleSet</var> of <var>document</var>’s <a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#document-sr-sets" id="ref-for-document-sr-sets">speculation rule sets</a>:</p>
      <ol>
       <li data-md>
        <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-iterate" id="ref-for-list-iterate①">For each</a> <var>rule</var> of <var>ruleSet</var>’s <a data-link-type="dfn" href="#speculation-rule-set-prerender-rules" id="ref-for-speculation-rule-set-prerender-rules①">prerender rules</a>:</p>
        <ol>
         <li data-md>
          <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-iterate" id="ref-for-list-iterate②">For each</a> <var>url</var> of <var>rule</var>’s <a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#sr-urls" id="ref-for-sr-urls">URLs</a>:</p>
          <ol>
           <li data-md>
            <p>Let <var>referrerPolicy</var> be the result of <a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#compute-speculative-load-referrer-policy" id="ref-for-compute-speculative-load-referrer-policy">computing a speculative load referrer policy</a> given <var>rule</var> and null.</p>
           <li data-md>
            <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-append" id="ref-for-list-append">Append</a> a new <a data-link-type="dfn" href="#prerender-candidate" id="ref-for-prerender-candidate">prerender candidate</a> with</p>
            <dl class="props">
             <dt data-md><a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#sl-candidate-url" id="ref-for-sl-candidate-url">URL</a>
             <dd data-md>
              <p><var>url</var></p>
             <dt data-md><a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#sl-candidate-nvs-hint" id="ref-for-sl-candidate-nvs-hint">No-Vary-Search hint</a>
             <dd data-md>
              <p><var>rule</var>’s <a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#sr-nvs-hint" id="ref-for-sr-nvs-hint">No-Vary-Search hint</a></p>
             <dt data-md><a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#sl-candidate-eagerness" id="ref-for-sl-candidate-eagerness">eagerness</a>
             <dd data-md>
              <p><var>rule</var>’s <a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#sr-eagerness" id="ref-for-sr-eagerness">eagerness</a></p>
             <dt data-md><a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#sl-candidate-referrer-policy" id="ref-for-sl-candidate-referrer-policy">referrer policy</a>
             <dd data-md>
              <p><var>referrerPolicy</var></p>
             <dt data-md><a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#sl-candidate-tags" id="ref-for-sl-candidate-tags">tags</a>
             <dd data-md>
              <p><var>rule</var>’s <a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#sr-tags" id="ref-for-sr-tags">tags</a></p>
             <dt data-md><a data-link-type="dfn" href="#prerender-candidate-target-navigable-name-hint" id="ref-for-prerender-candidate-target-navigable-name-hint">target navigable name hint</a>
             <dd data-md>
              <p><var>rule</var>’s <a data-link-type="dfn" href="#speculation-rule-target-navigable-name-hint" id="ref-for-speculation-rule-target-navigable-name-hint②">target navigable name hint</a></p>
            </dl>
            <p>to <var>prerenderCandidates</var>.</p>
          </ol>
         <li data-md>
          <p>If <var>rule</var>’s <a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#sr-predicate" id="ref-for-sr-predicate">predicate</a> is not null, then:</p>
          <ol>
           <li data-md>
            <p>Let <var>links</var> be the result of <a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#finding-matching-links" id="ref-for-finding-matching-links">finding matching links</a> given <var>document</var> and <var>rule</var>’s <a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#sr-predicate" id="ref-for-sr-predicate①">predicate</a>.</p>
           <li data-md>
            <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-iterate" id="ref-for-list-iterate③">For each</a> <var>link</var> of <var>links</var>:</p>
            <ol>
             <li data-md>
              <p>Let <var>target</var> be <var>rule</var>’s <a data-link-type="dfn" href="#speculation-rule-target-navigable-name-hint" id="ref-for-speculation-rule-target-navigable-name-hint③">target navigable name hint</a>.</p>
             <li data-md>
              <p>If <var>target</var> is null, set it to the result of <a data-link-type="dfn" href="https://whatpr.org/html/11426/semantics.html#get-an-element&apos;s-target" id="ref-for-get-an-element&apos;s-target">getting an element’s target</a> given <var>link</var>.</p>
             <li data-md>
              <p>Let <var>referrerPolicy</var> be the result of <a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#compute-speculative-load-referrer-policy" id="ref-for-compute-speculative-load-referrer-policy①">computing a speculative load referrer policy</a> given <var>rule</var> and <var>link</var>.</p>
             <li data-md>
              <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-append" id="ref-for-list-append①">Append</a> a <a data-link-type="dfn" href="#prerender-candidate" id="ref-for-prerender-candidate①">prerender candidate</a> with</p>
              <dl class="props">
               <dt data-md><a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#sl-candidate-url" id="ref-for-sl-candidate-url①">URL</a>
               <dd data-md>
                <p><var>link</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/links.html#concept-hyperlink-url" id="ref-for-concept-hyperlink-url">url</a></p>
               <dt data-md><a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#sl-candidate-nvs-hint" id="ref-for-sl-candidate-nvs-hint①">No-Vary-Search hint</a>
               <dd data-md>
                <p><var>rule</var>’s <a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#sr-nvs-hint" id="ref-for-sr-nvs-hint①">No-Vary-Search hint</a></p>
               <dt data-md><a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#sl-candidate-eagerness" id="ref-for-sl-candidate-eagerness①">eagerness</a>
               <dd data-md>
                <p><var>rule</var>’s <a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#sr-eagerness" id="ref-for-sr-eagerness①">eagerness</a></p>
               <dt data-md><a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#sl-candidate-referrer-policy" id="ref-for-sl-candidate-referrer-policy①">referrer policy</a>
               <dd data-md>
                <p><var>referrerPolicy</var></p>
               <dt data-md><a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#sl-candidate-tags" id="ref-for-sl-candidate-tags①">tags</a>
               <dd data-md>
                <p><var>rule</var>’s <a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#sr-tags" id="ref-for-sr-tags①">tags</a></p>
               <dt data-md><a data-link-type="dfn" href="#prerender-candidate-target-navigable-name-hint" id="ref-for-prerender-candidate-target-navigable-name-hint①">target navigable name hint</a>
               <dd data-md>
                <p><var>target</var></p>
              </dl>
              <p>to <var>prerenderCandidates</var>.</p>
            </ol>
          </ol>
        </ol>
      </ol>
     <li data-md>
      <p>Let <var>speculativeLoadCandidates</var> be the union of <var>prefetchCandidates</var> and <var>prerenderCandidates</var>.</p>
    </ol>
    <p>Update subsequent steps for canceling not-still-being-speculated <a data-link-type="dfn" href="https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record" id="ref-for-prefetch-record">prefetch records</a> to operate on <var>speculativeLoadCandidates</var> instead of <var>prefetchCandidates</var>.</p>
    <p>Replace the step which performs the actual prefetching by looping over <var>prefetchCandidates</var> with the following:</p>
    <ol>
     <li data-md>
      <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-iterate" id="ref-for-list-iterate④">For each</a> <var>candidate</var> of <var>speculativeLoadCandidates</var>:</p>
      <ol>
       <li data-md>
        <p>The user agent may run the following steps:</p>
        <ol>
         <li data-md>
          <p>Let <var>tagCandidates</var> be <var>speculativeLoadCandidates</var>.</p>
         <li data-md>
          <p>If <var>candidate</var> is a <a data-link-type="dfn" href="#prerender-candidate" id="ref-for-prerender-candidate②">prerender candidate</a>, then set <var>tagCandidates</var> to <var>prerenderCandidates</var>.</p>
         <li data-md>
          <p>Let <var>tagsToSend</var> be the result of <a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#collecting-tags-for-matching-speculative-load-candidates" id="ref-for-collecting-tags-for-matching-speculative-load-candidates">collecting tags for matching speculative load candidates</a> given <var>candidate</var> and <var>tagCandidates</var>.</p>
         <li data-md>
          <p>Let <var>prefetchRecord</var> be a new <a data-link-type="dfn" href="https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record" id="ref-for-prefetch-record①">prefetch record</a> with</p>
          <dl class="props">
           <dt data-md><a data-link-type="dfn" href="https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-source" id="ref-for-prefetch-record-source">source</a>
           <dd data-md>
            <p>"<code>speculation rules</code>"</p>
           <dt data-md><a data-link-type="dfn" href="https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-url" id="ref-for-prefetch-record-url">URL</a>
           <dd data-md>
            <p><var>candidate</var>’s <a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#sl-candidate-url" id="ref-for-sl-candidate-url②">URL</a></p>
           <dt data-md><a data-link-type="dfn" href="https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-no-vary-search-hint" id="ref-for-prefetch-record-no-vary-search-hint">No-Vary-Search hint</a>
           <dd data-md>
            <p><var>candidate</var>’s <a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#sl-candidate-nvs-hint" id="ref-for-sl-candidate-nvs-hint②">No-Vary-Search hint</a></p>
           <dt data-md><a data-link-type="dfn" href="https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-referrer-policy" id="ref-for-prefetch-record-referrer-policy">referrer policy</a>
           <dd data-md>
            <p><var>candidate</var>’s <a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#sl-candidate-referrer-policy" id="ref-for-sl-candidate-referrer-policy②">referrer policy</a></p>
           <dt data-md><a data-link-type="dfn" href="https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-tags" id="ref-for-prefetch-record-tags">tags</a>
           <dd data-md>
            <p><var>tagsToSend</var></p>
          </dl>
         <li data-md>
          <p>If <var>candidate</var> is a <a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#prefetch-candidate" id="ref-for-prefetch-candidate">prefetch candidate</a>, then set <var>prefetchRecord</var>’s <a data-link-type="dfn" href="https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-anonymization-policy" id="ref-for-prefetch-record-anonymization-policy">anonymization policy</a> to <var>candidate</var>’s <a data-link-type="dfn" href="https://whatpr.org/html/11426/speculative-loading.html#sl-candidate-anonymization-policy" id="ref-for-sl-candidate-anonymization-policy">anonymization policy</a>.</p>
         <li data-md>
          <p>If <var>candidate</var> is a <a data-link-type="dfn" href="#prerender-candidate" id="ref-for-prerender-candidate③">prerender candidate</a>, then the user agent may run the following steps:</p>
          <ol>
           <li data-md>
            <p>Set <var>prefetchRecord</var>’s <a data-link-type="dfn" href="https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-prerendering-traversable" id="ref-for-prefetch-record-prerendering-traversable">prerendering traversable</a> to "<code>to be created</code>"</p>
           <li data-md>
            <p>Set <var>prefetchRecord</var>’s <a data-link-type="dfn" href="https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-prerendering-target-navigable-name-hint" id="ref-for-prefetch-record-prerendering-target-navigable-name-hint">prerendering target navigable name hint</a> to <var>candidate</var>’s <a data-link-type="dfn" href="#prerender-candidate-target-navigable-name-hint" id="ref-for-prerender-candidate-target-navigable-name-hint②">target navigable name hint</a>.</p>
           <li data-md>
            <p><a data-link-type="dfn" href="https://wicg.github.io/nav-speculation/prerendering.html#start-a-referrer-initiated-navigational-prerender" id="ref-for-start-a-referrer-initiated-navigational-prerender">Start a referrer-initiated navigational prerender</a> given <var>document</var> and <var>prefetchRecord</var>.</p>
          </ol>
         <li data-md>
          <p>If the user agent did not run the previous step, then <a data-link-type="dfn" href="https://wicg.github.io/nav-speculation/prefetch.html#start-a-referrer-initiated-navigational-prefetch" id="ref-for-start-a-referrer-initiated-navigational-prefetch">start a referrer-initiated navigational prefetch</a> given <var>document</var> and <var>prefetchRecord</var>.</p>
        </ol>
      </ol>
    </ol>
   </div>
  </main>
  <script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script>
  <h2 class="no-num no-ref heading settled" id="index"><span class="content">Index</span><a class="self-link" href="#index"></a></h2>
  <h3 class="no-num no-ref heading settled" id="index-defined-here"><span class="content">Terms defined by this specification</span><a class="self-link" href="#index-defined-here"></a></h3>
  <ul class="index">
   <li><a href="#prerender-candidate">prerender candidate</a><span>, in § 3</span>
   <li><a href="#speculation-rule-set-prerender-rules">prerender rules</a><span>, in § 2</span>
   <li>
    target navigable name hint
    <ul>
     <li><a href="#prerender-candidate-target-navigable-name-hint">dfn for prerender candidate</a><span>, in § 3</span>
     <li><a href="#speculation-rule-target-navigable-name-hint">dfn for speculation rule</a><span>, in § 2</span>
    </ul>
  </ul>
  <h3 class="no-num no-ref heading settled" id="index-defined-elsewhere"><span class="content">Terms defined by reference</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
  <ul class="index">
   <li>
    <a data-link-type="biblio">[CONSOLE]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="37e32f12">report a warning to the console</span>
    </ul>
   <li>
    <a data-link-type="biblio">[HTML]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="5a57d186">anonymization policy</span>
     <li><span class="dfn-paneled" id="6803f5d6">collecting tags for matching speculative load candidates</span>
     <li><span class="dfn-paneled" id="e535a7f6">compute a speculative load referrer policy</span>
     <li><span class="dfn-paneled" id="3637d409">eagerness <small>(for speculation rule)</small></span>
     <li><span class="dfn-paneled" id="a16866c7">eagerness <small>(for speculative load candidate)</small></span>
     <li><span class="dfn-paneled" id="c6371648">finding matching links</span>
     <li><span class="dfn-paneled" id="00064bc4">get an element's target</span>
     <li><span class="dfn-paneled" id="631182ca">inner consider speculative loads steps</span>
     <li><span class="dfn-paneled" id="482fd8d4">No-Vary-Search hint <small>(for speculation rule)</small></span>
     <li><span class="dfn-paneled" id="44ae7369">No-Vary-Search hint <small>(for speculative load candidate)</small></span>
     <li><span class="dfn-paneled" id="71b534e4">parse a speculation rule</span>
     <li><span class="dfn-paneled" id="16808e53">parse a speculation rule set string</span>
     <li><span class="dfn-paneled" id="043ab775">predicate</span>
     <li><span class="dfn-paneled" id="c8c44926">prefetch candidate</span>
     <li><span class="dfn-paneled" id="6393b8ef">prefetch rules</span>
     <li><span class="dfn-paneled" id="f64cd240">referrer policy</span>
     <li><span class="dfn-paneled" id="7684ffde">speculation rule</span>
     <li><span class="dfn-paneled" id="980dda1d">speculation rule set</span>
     <li><span class="dfn-paneled" id="a4d78a5c">speculation rule sets</span>
     <li><span class="dfn-paneled" id="c666e05d">speculative load candidate</span>
     <li><span class="dfn-paneled" id="ed08d686">tags <small>(for speculation rule)</small></span>
     <li><span class="dfn-paneled" id="5303d536">tags <small>(for speculative load candidate)</small></span>
     <li><span class="dfn-paneled" id="c7c0dde1">url <small>(for HTMLHyperlinkElementUtils)</small></span>
     <li><span class="dfn-paneled" id="b141168a">URL <small>(for speculative load candidate)</small></span>
     <li><span class="dfn-paneled" id="a20ea266">URLs</span>
     <li><span class="dfn-paneled" id="36706746">valid navigable target name or keyword</span>
    </ul>
   <li>
    <a data-link-type="biblio">[INFRA]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="53275e46">append</span>
     <li><span class="dfn-paneled" id="1243a891">exist</span>
     <li><span class="dfn-paneled" id="16d07e10">for each</span>
     <li><span class="dfn-paneled" id="c88f3887">item</span>
     <li><span class="dfn-paneled" id="649608b9">list</span>
     <li><span class="dfn-paneled" id="0698d556">string</span>
     <li><span class="dfn-paneled" id="984221ca">struct</span>
    </ul>
   <li>
    <a data-link-type="biblio">[PREFETCH]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="87c3c6f6">anonymization policy</span>
     <li><span class="dfn-paneled" id="4ce800e8">No-Vary-Search hint</span>
     <li><span class="dfn-paneled" id="99c55261">prefetch record</span>
     <li><span class="dfn-paneled" id="a47f7739">prerendering target navigable name hint</span>
     <li><span class="dfn-paneled" id="91dda5f9">prerendering traversable</span>
     <li><span class="dfn-paneled" id="4d80a6e7">referrer policy</span>
     <li><span class="dfn-paneled" id="6da138da">source</span>
     <li><span class="dfn-paneled" id="05390e01">start a referrer-initiated navigational prefetch</span>
     <li><span class="dfn-paneled" id="86e3118f">tags</span>
     <li><span class="dfn-paneled" id="5bc14177">URL</span>
    </ul>
   <li>
    <a data-link-type="biblio">[PRERENDERING-REVAMPED]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="9fe18dd3">start a referrer-initiated navigational prerender</span>
    </ul>
  </ul>
  <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="no-num no-ref heading settled" id="normative"><span class="content">Normative References</span><a class="self-link" href="#normative"></a></h3>
  <dl>
   <dt id="biblio-console">[CONSOLE]
   <dd>Dominic Farolino; Robert Kowalski; Terin Stock. <a href="https://console.spec.whatwg.org/"><cite>Console Standard</cite></a>. Living Standard. URL: <a href="https://console.spec.whatwg.org/">https://console.spec.whatwg.org/</a>
   <dt id="biblio-html">[HTML]
   <dd>Anne van Kesteren; et al. <a href="https://html.spec.whatwg.org/multipage/"><cite>HTML Standard</cite></a>. Living Standard. URL: <a href="https://html.spec.whatwg.org/multipage/">https://html.spec.whatwg.org/multipage/</a>
   <dt id="biblio-infra">[INFRA]
   <dd>Anne van Kesteren; Domenic Denicola. <a href="https://infra.spec.whatwg.org/"><cite>Infra Standard</cite></a>. Living Standard. URL: <a href="https://infra.spec.whatwg.org/">https://infra.spec.whatwg.org/</a>
   <dt id="biblio-prefetch">[PREFETCH]
   <dd><a href="https://wicg.github.io/nav-speculation/prefetch.html"><cite>Prefetch</cite></a>. Draft Community Group Report. URL: <a href="https://wicg.github.io/nav-speculation/prefetch.html">https://wicg.github.io/nav-speculation/prefetch.html</a>
   <dt id="biblio-prerendering-revamped">[PRERENDERING-REVAMPED]
   <dd><a href="https://wicg.github.io/nav-speculation/prerendering.html"><cite>Prerendering Revamped</cite></a>. Draft Community Group Report. URL: <a href="https://wicg.github.io/nav-speculation/prerendering.html">https://wicg.github.io/nav-speculation/prerendering.html</a>
  </dl>
<script>/* Boilerplate: script-dom-helper */
"use strict";
function query(sel) { return document.querySelector(sel); }

function queryAll(sel) { return [...document.querySelectorAll(sel)]; }

function iter(obj) {
	if(!obj) return [];
	var it = obj[Symbol.iterator];
	if(it) return it;
	return Object.entries(obj);
}

function mk(tagname, attrs, ...children) {
	const el = document.createElement(tagname);
	for(const [k,v] of iter(attrs)) {
		if(k.slice(0,3) == "_on") {
			const eventName = k.slice(3);
			el.addEventListener(eventName, v);
		} else if(k[0] == "_") {
			// property, not attribute
			el[k.slice(1)] = v;
		} else {
			if(v === false || v == null) {
        continue;
      } else if(v === true) {
        el.setAttribute(k, "");
        continue;
      } else {
  			el.setAttribute(k, v);
      }
		}
	}
	append(el, children);
	return el;
}

/* Create shortcuts for every known HTML element */
[
  "a",
  "abbr",
  "acronym",
  "address",
  "applet",
  "area",
  "article",
  "aside",
  "audio",
  "b",
  "base",
  "basefont",
  "bdo",
  "big",
  "blockquote",
  "body",
  "br",
  "button",
  "canvas",
  "caption",
  "center",
  "cite",
  "code",
  "col",
  "colgroup",
  "datalist",
  "dd",
  "del",
  "details",
  "dfn",
  "dialog",
  "div",
  "dl",
  "dt",
  "em",
  "embed",
  "fieldset",
  "figcaption",
  "figure",
  "font",
  "footer",
  "form",
  "frame",
  "frameset",
  "head",
  "header",
  "h1",
  "h2",
  "h3",
  "h4",
  "h5",
  "h6",
  "hr",
  "html",
  "i",
  "iframe",
  "img",
  "input",
  "ins",
  "kbd",
  "label",
  "legend",
  "li",
  "link",
  "main",
  "map",
  "mark",
  "meta",
  "meter",
  "nav",
  "nobr",
  "noscript",
  "object",
  "ol",
  "optgroup",
  "option",
  "output",
  "p",
  "param",
  "pre",
  "progress",
  "q",
  "s",
  "samp",
  "script",
  "section",
  "select",
  "small",
  "source",
  "span",
  "strike",
  "strong",
  "style",
  "sub",
  "summary",
  "sup",
  "table",
  "tbody",
  "td",
  "template",
  "textarea",
  "tfoot",
  "th",
  "thead",
  "time",
  "title",
  "tr",
  "u",
  "ul",
  "var",
  "video",
  "wbr",
  "xmp",
].forEach(tagname=>{
	mk[tagname] = (...args) => mk(tagname, ...args);
});

function* nodesFromChildList(children) {
	for(const child of children.flat(Infinity)) {
		if(child instanceof Node) {
			yield child;
		} else {
			yield new Text(child);
		}
	}
}
function append(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		if(el instanceof Node) el.appendChild(child);
		else el.push(child);
	}
	return el;
}

function insertAfter(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		el.parentNode.insertBefore(child, el.nextSibling);
	}
	return el;
}

function clearContents(el) {
	el.innerHTML = "";
	return el;
}

function parseHTML(markup) {
	if(markup.toLowerCase().trim().indexOf('<!doctype') === 0) {
		const doc = document.implementation.createHTMLDocument("");
		doc.documentElement.innerHTML = markup;
		return doc;
	} else {
		const el = mk.template({});
		el.innerHTML = markup;
		return el.content;
	}
}</script>
<script>/* Boilerplate: script-dfn-panel */
"use strict";
{
let dfnPanelData = {
"00064bc4": {"dfnID":"00064bc4","dfnText":"get an element's target","external":true,"refSections":[{"refs":[{"id":"ref-for-get-an-element's-target"}],"title":"3. Processing model"}],"url":"https://whatpr.org/html/11426/semantics.html#get-an-element's-target"},
"043ab775": {"dfnID":"043ab775","dfnText":"predicate","external":true,"refSections":[{"refs":[{"id":"ref-for-sr-predicate"},{"id":"ref-for-sr-predicate\u2460"}],"title":"3. Processing model"}],"url":"https://whatpr.org/html/11426/speculative-loading.html#sr-predicate"},
"05390e01": {"dfnID":"05390e01","dfnText":"start a referrer-initiated navigational prefetch","external":true,"refSections":[{"refs":[{"id":"ref-for-start-a-referrer-initiated-navigational-prefetch"}],"title":"3. Processing model"}],"url":"https://wicg.github.io/nav-speculation/prefetch.html#start-a-referrer-initiated-navigational-prefetch"},
"0698d556": {"dfnID":"0698d556","dfnText":"string","external":true,"refSections":[{"refs":[{"id":"ref-for-string"}],"title":"2. Parsing"}],"url":"https://infra.spec.whatwg.org/#string"},
"1243a891": {"dfnID":"1243a891","dfnText":"exist","external":true,"refSections":[{"refs":[{"id":"ref-for-map-exists"}],"title":"2. Parsing"}],"url":"https://infra.spec.whatwg.org/#map-exists"},
"16808e53": {"dfnID":"16808e53","dfnText":"parse a speculation rule set string","external":true,"refSections":[{"refs":[{"id":"ref-for-speculation-rule-set"},{"id":"ref-for-speculation-rule-set\u2460"}],"title":"2. Parsing"}],"url":"https://whatpr.org/html/11426/speculative-loading.html#speculation-rule-set"},
"16d07e10": {"dfnID":"16d07e10","dfnText":"for each","external":true,"refSections":[{"refs":[{"id":"ref-for-list-iterate"},{"id":"ref-for-list-iterate\u2460"},{"id":"ref-for-list-iterate\u2461"},{"id":"ref-for-list-iterate\u2462"},{"id":"ref-for-list-iterate\u2463"}],"title":"3. Processing model"}],"url":"https://infra.spec.whatwg.org/#list-iterate"},
"3637d409": {"dfnID":"3637d409","dfnText":"eagerness (for speculation rule)","external":true,"refSections":[{"refs":[{"id":"ref-for-sr-eagerness"},{"id":"ref-for-sr-eagerness\u2460"}],"title":"3. Processing model"}],"url":"https://whatpr.org/html/11426/speculative-loading.html#sr-eagerness"},
"36706746": {"dfnID":"36706746","dfnText":"valid navigable target name or keyword","external":true,"refSections":[{"refs":[{"id":"ref-for-valid-navigable-target-name-or-keyword"}],"title":"2. Parsing"},{"refs":[{"id":"ref-for-valid-navigable-target-name-or-keyword\u2460"}],"title":"3. Processing model"}],"url":"https://html.spec.whatwg.org/multipage/document-sequences.html#valid-navigable-target-name-or-keyword"},
"37e32f12": {"dfnID":"37e32f12","dfnText":"report a warning to the console","external":true,"refSections":[{"refs":[{"id":"ref-for-report-a-warning-to-the-console"}],"title":"2. Parsing"}],"url":"https://console.spec.whatwg.org/#report-a-warning-to-the-console"},
"44ae7369": {"dfnID":"44ae7369","dfnText":"No-Vary-Search hint (for speculative load candidate)","external":true,"refSections":[{"refs":[{"id":"ref-for-sl-candidate-nvs-hint"},{"id":"ref-for-sl-candidate-nvs-hint\u2460"},{"id":"ref-for-sl-candidate-nvs-hint\u2461"}],"title":"3. Processing model"}],"url":"https://whatpr.org/html/11426/speculative-loading.html#sl-candidate-nvs-hint"},
"482fd8d4": {"dfnID":"482fd8d4","dfnText":"No-Vary-Search hint (for speculation rule)","external":true,"refSections":[{"refs":[{"id":"ref-for-sr-nvs-hint"},{"id":"ref-for-sr-nvs-hint\u2460"}],"title":"3. Processing model"}],"url":"https://whatpr.org/html/11426/speculative-loading.html#sr-nvs-hint"},
"4ce800e8": {"dfnID":"4ce800e8","dfnText":"No-Vary-Search hint","external":true,"refSections":[{"refs":[{"id":"ref-for-prefetch-record-no-vary-search-hint"}],"title":"3. Processing model"}],"url":"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-no-vary-search-hint"},
"4d80a6e7": {"dfnID":"4d80a6e7","dfnText":"referrer policy","external":true,"refSections":[{"refs":[{"id":"ref-for-prefetch-record-referrer-policy"}],"title":"3. Processing model"}],"url":"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-referrer-policy"},
"5303d536": {"dfnID":"5303d536","dfnText":"tags (for speculative load candidate)","external":true,"refSections":[{"refs":[{"id":"ref-for-sl-candidate-tags"},{"id":"ref-for-sl-candidate-tags\u2460"}],"title":"3. Processing model"}],"url":"https://whatpr.org/html/11426/speculative-loading.html#sl-candidate-tags"},
"53275e46": {"dfnID":"53275e46","dfnText":"append","external":true,"refSections":[{"refs":[{"id":"ref-for-list-append"},{"id":"ref-for-list-append\u2460"}],"title":"3. Processing model"}],"url":"https://infra.spec.whatwg.org/#list-append"},
"5a57d186": {"dfnID":"5a57d186","dfnText":"anonymization policy","external":true,"refSections":[{"refs":[{"id":"ref-for-sl-candidate-anonymization-policy"}],"title":"3. Processing model"}],"url":"https://whatpr.org/html/11426/speculative-loading.html#sl-candidate-anonymization-policy"},
"5bc14177": {"dfnID":"5bc14177","dfnText":"URL","external":true,"refSections":[{"refs":[{"id":"ref-for-prefetch-record-url"}],"title":"3. Processing model"}],"url":"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-url"},
"631182ca": {"dfnID":"631182ca","dfnText":"inner consider speculative loads steps","external":true,"refSections":[{"refs":[{"id":"ref-for-inner-consider-speculative-loads-steps"}],"title":"3. Processing model"}],"url":"https://whatpr.org/html/11426/speculative-loading.html#inner-consider-speculative-loads-steps"},
"6393b8ef": {"dfnID":"6393b8ef","dfnText":"prefetch rules","external":true,"refSections":[{"refs":[{"id":"ref-for-sr-set-prefetch"}],"title":"2. Parsing"}],"url":"https://whatpr.org/html/11426/speculative-loading.html#sr-set-prefetch"},
"649608b9": {"dfnID":"649608b9","dfnText":"list","external":true,"refSections":[{"refs":[{"id":"ref-for-list"}],"title":"2. Parsing"},{"refs":[{"id":"ref-for-list\u2460"}],"title":"3. Processing model"}],"url":"https://infra.spec.whatwg.org/#list"},
"6803f5d6": {"dfnID":"6803f5d6","dfnText":"collecting tags for matching speculative load candidates","external":true,"refSections":[{"refs":[{"id":"ref-for-collecting-tags-for-matching-speculative-load-candidates"}],"title":"3. Processing model"}],"url":"https://whatpr.org/html/11426/speculative-loading.html#collecting-tags-for-matching-speculative-load-candidates"},
"6da138da": {"dfnID":"6da138da","dfnText":"source","external":true,"refSections":[{"refs":[{"id":"ref-for-prefetch-record-source"}],"title":"3. Processing model"}],"url":"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-source"},
"71b534e4": {"dfnID":"71b534e4","dfnText":"parse a speculation rule","external":true,"refSections":[{"refs":[{"id":"ref-for-speculation-rule"},{"id":"ref-for-speculation-rule\u2460"},{"id":"ref-for-speculation-rule\u2461"},{"id":"ref-for-speculation-rule\u2462"}],"title":"2. Parsing"}],"url":"https://whatpr.org/html/11426/speculative-loading.html#speculation-rule"},
"7684ffde": {"dfnID":"7684ffde","dfnText":"speculation rule","external":true,"refSections":[{"refs":[{"id":"ref-for-speculation-rule"},{"id":"ref-for-speculation-rule\u2460"},{"id":"ref-for-speculation-rule\u2461"},{"id":"ref-for-speculation-rule\u2462"}],"title":"2. Parsing"}],"url":"https://whatpr.org/html/11426/speculative-loading.html#speculation-rule"},
"86e3118f": {"dfnID":"86e3118f","dfnText":"tags","external":true,"refSections":[{"refs":[{"id":"ref-for-prefetch-record-tags"}],"title":"3. Processing model"}],"url":"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-tags"},
"87c3c6f6": {"dfnID":"87c3c6f6","dfnText":"anonymization policy","external":true,"refSections":[{"refs":[{"id":"ref-for-prefetch-record-anonymization-policy"}],"title":"3. Processing model"}],"url":"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-anonymization-policy"},
"91dda5f9": {"dfnID":"91dda5f9","dfnText":"prerendering traversable","external":true,"refSections":[{"refs":[{"id":"ref-for-prefetch-record-prerendering-traversable"}],"title":"3. Processing model"}],"url":"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-prerendering-traversable"},
"980dda1d": {"dfnID":"980dda1d","dfnText":"speculation rule set","external":true,"refSections":[{"refs":[{"id":"ref-for-speculation-rule-set"},{"id":"ref-for-speculation-rule-set\u2460"}],"title":"2. Parsing"}],"url":"https://whatpr.org/html/11426/speculative-loading.html#speculation-rule-set"},
"984221ca": {"dfnID":"984221ca","dfnText":"struct","external":true,"refSections":[{"refs":[{"id":"ref-for-struct"},{"id":"ref-for-struct\u2460"}],"title":"2. Parsing"}],"url":"https://infra.spec.whatwg.org/#struct"},
"99c55261": {"dfnID":"99c55261","dfnText":"prefetch record","external":true,"refSections":[{"refs":[{"id":"ref-for-prefetch-record"},{"id":"ref-for-prefetch-record\u2460"}],"title":"3. Processing model"}],"url":"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record"},
"9fe18dd3": {"dfnID":"9fe18dd3","dfnText":"start a referrer-initiated navigational prerender","external":true,"refSections":[{"refs":[{"id":"ref-for-start-a-referrer-initiated-navigational-prerender"}],"title":"3. Processing model"}],"url":"https://wicg.github.io/nav-speculation/prerendering.html#start-a-referrer-initiated-navigational-prerender"},
"a16866c7": {"dfnID":"a16866c7","dfnText":"eagerness (for speculative load candidate)","external":true,"refSections":[{"refs":[{"id":"ref-for-sl-candidate-eagerness"},{"id":"ref-for-sl-candidate-eagerness\u2460"}],"title":"3. Processing model"}],"url":"https://whatpr.org/html/11426/speculative-loading.html#sl-candidate-eagerness"},
"a20ea266": {"dfnID":"a20ea266","dfnText":"URLs","external":true,"refSections":[{"refs":[{"id":"ref-for-sr-urls"}],"title":"3. Processing model"}],"url":"https://whatpr.org/html/11426/speculative-loading.html#sr-urls"},
"a47f7739": {"dfnID":"a47f7739","dfnText":"prerendering target navigable name hint","external":true,"refSections":[{"refs":[{"id":"ref-for-prefetch-record-prerendering-target-navigable-name-hint"}],"title":"3. Processing model"}],"url":"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-prerendering-target-navigable-name-hint"},
"a4d78a5c": {"dfnID":"a4d78a5c","dfnText":"speculation rule sets","external":true,"refSections":[{"refs":[{"id":"ref-for-document-sr-sets"}],"title":"3. Processing model"}],"url":"https://whatpr.org/html/11426/speculative-loading.html#document-sr-sets"},
"b141168a": {"dfnID":"b141168a","dfnText":"URL (for speculative load candidate)","external":true,"refSections":[{"refs":[{"id":"ref-for-sl-candidate-url"},{"id":"ref-for-sl-candidate-url\u2460"},{"id":"ref-for-sl-candidate-url\u2461"}],"title":"3. Processing model"}],"url":"https://whatpr.org/html/11426/speculative-loading.html#sl-candidate-url"},
"c6371648": {"dfnID":"c6371648","dfnText":"finding matching links","external":true,"refSections":[{"refs":[{"id":"ref-for-finding-matching-links"}],"title":"3. Processing model"}],"url":"https://whatpr.org/html/11426/speculative-loading.html#finding-matching-links"},
"c666e05d": {"dfnID":"c666e05d","dfnText":"speculative load candidate","external":true,"refSections":[{"refs":[{"id":"ref-for-speculative-load-candidate"}],"title":"3. Processing model"}],"url":"https://whatpr.org/html/11426/speculative-loading.html#speculative-load-candidate"},
"c7c0dde1": {"dfnID":"c7c0dde1","dfnText":"url (for HTMLHyperlinkElementUtils)","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-hyperlink-url"}],"title":"3. Processing model"}],"url":"https://html.spec.whatwg.org/multipage/links.html#concept-hyperlink-url"},
"c88f3887": {"dfnID":"c88f3887","dfnText":"item","external":true,"refSections":[{"refs":[{"id":"ref-for-struct-item"},{"id":"ref-for-struct-item\u2460"}],"title":"2. Parsing"},{"refs":[{"id":"ref-for-struct-item\u2461"}],"title":"3. Processing model"}],"url":"https://infra.spec.whatwg.org/#struct-item"},
"c8c44926": {"dfnID":"c8c44926","dfnText":"prefetch candidate","external":true,"refSections":[{"refs":[{"id":"ref-for-prefetch-candidate"}],"title":"3. Processing model"}],"url":"https://whatpr.org/html/11426/speculative-loading.html#prefetch-candidate"},
"e535a7f6": {"dfnID":"e535a7f6","dfnText":"compute a speculative load referrer policy","external":true,"refSections":[{"refs":[{"id":"ref-for-compute-speculative-load-referrer-policy"},{"id":"ref-for-compute-speculative-load-referrer-policy\u2460"}],"title":"3. Processing model"}],"url":"https://whatpr.org/html/11426/speculative-loading.html#compute-speculative-load-referrer-policy"},
"ed08d686": {"dfnID":"ed08d686","dfnText":"tags (for speculation rule)","external":true,"refSections":[{"refs":[{"id":"ref-for-sr-tags"},{"id":"ref-for-sr-tags\u2460"}],"title":"3. Processing model"}],"url":"https://whatpr.org/html/11426/speculative-loading.html#sr-tags"},
"f64cd240": {"dfnID":"f64cd240","dfnText":"referrer policy","external":true,"refSections":[{"refs":[{"id":"ref-for-sl-candidate-referrer-policy"},{"id":"ref-for-sl-candidate-referrer-policy\u2460"},{"id":"ref-for-sl-candidate-referrer-policy\u2461"}],"title":"3. Processing model"}],"url":"https://whatpr.org/html/11426/speculative-loading.html#sl-candidate-referrer-policy"},
"prerender-candidate": {"dfnID":"prerender-candidate","dfnText":"prerender candidate","external":false,"refSections":[{"refs":[{"id":"ref-for-prerender-candidate"},{"id":"ref-for-prerender-candidate\u2460"},{"id":"ref-for-prerender-candidate\u2461"},{"id":"ref-for-prerender-candidate\u2462"}],"title":"3. Processing model"}],"url":"#prerender-candidate"},
"prerender-candidate-target-navigable-name-hint": {"dfnID":"prerender-candidate-target-navigable-name-hint","dfnText":"target navigable name hint","external":false,"refSections":[{"refs":[{"id":"ref-for-prerender-candidate-target-navigable-name-hint"},{"id":"ref-for-prerender-candidate-target-navigable-name-hint\u2460"},{"id":"ref-for-prerender-candidate-target-navigable-name-hint\u2461"}],"title":"3. Processing model"}],"url":"#prerender-candidate-target-navigable-name-hint"},
"speculation-rule-set-prerender-rules": {"dfnID":"speculation-rule-set-prerender-rules","dfnText":"prerender rules","external":false,"refSections":[{"refs":[{"id":"ref-for-speculation-rule-set-prerender-rules"}],"title":"2. Parsing"},{"refs":[{"id":"ref-for-speculation-rule-set-prerender-rules\u2460"}],"title":"3. Processing model"}],"url":"#speculation-rule-set-prerender-rules"},
"speculation-rule-target-navigable-name-hint": {"dfnID":"speculation-rule-target-navigable-name-hint","dfnText":"target navigable name hint","external":false,"refSections":[{"refs":[{"id":"ref-for-speculation-rule-target-navigable-name-hint"},{"id":"ref-for-speculation-rule-target-navigable-name-hint\u2460"}],"title":"2. Parsing"},{"refs":[{"id":"ref-for-speculation-rule-target-navigable-name-hint\u2461"},{"id":"ref-for-speculation-rule-target-navigable-name-hint\u2462"}],"title":"3. Processing model"}],"url":"#speculation-rule-target-navigable-name-hint"},
};

document.addEventListener("DOMContentLoaded", ()=>{
    genAllDfnPanels();

    document.body.addEventListener("click", (e) => {
        // If not handled already, just hide all dfn panels.
        hideAllDfnPanels();
    });
});

window.addEventListener("resize", () => {
    // Pin any visible dfn panel
    queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el=>positionDfnPanel(el));
});

function genAllDfnPanels() {
    for(const panelData of Object.values(dfnPanelData)) {
        const dfnID = panelData.dfnID;
        const dfn = document.getElementById(dfnID);
        if(!dfn) {
            console.log(`Can't find dfn#${dfnID}.`, panelData);
            continue;
        }
        dfn.panelData = panelData;
        insertDfnPopupAction(dfn);
    }
}

function genDfnPanel(dfn, { dfnID, url, dfnText, refSections, external }) {
    const dfnPanel = mk.aside({
        class: "dfn-panel on",
        id: `infopanel-for-${dfnID}`,
        "data-for": dfnID,
        "aria-labelled-by":`infopaneltitle-for-${dfnID}`,
        },
        mk.span({id:`infopaneltitle-for-${dfnID}`, style:"display:none"},
            `Info about the '${dfnText}' ${external?"external":""} reference.`),
        mk.a({href:url, class:"dfn-link"}, url),
        refSections.length == 0 ? [] :
            mk.b({}, "Referenced in:"),
            mk.ul({},
                ...refSections.map(section=>
                    mk.li({},
                        ...section.refs.map((ref, refI)=>
                            [
                                mk.a({ href: `#${ref.id}` },
                                    (refI == 0) ? section.title : `(${refI + 1})`
                                ),
                                " ",
                            ]
                        ),
                    ),
                ),
            ),
        genLinkingSyntaxes(dfn),
    );

    dfnPanel.addEventListener('click', (event) => {
        if (event.target.nodeName == 'A') {
            scrollToTargetAndHighlight(event);
            pinDfnPanel(dfnPanel);
        }
        event.stopPropagation();
        refocusOnTarget(event);
    });
    dfnPanel.addEventListener('keydown', (event) => {
        if(event.keyCode == 27) { // Escape key
            hideDfnPanel({dfnPanel});
            event.stopPropagation();
            event.preventDefault();
        }
    });

    dfnPanel.dfn = dfn;
    dfn.dfnPanel = dfnPanel;
    return dfnPanel;
}



function hideAllDfnPanels() {
    // Delete the currently-active dfn panel.
    queryAll(".dfn-panel").forEach(dfnPanel=>hideDfnPanel({dfnPanel}));
}

function showDfnPanel(dfn) {
    hideAllDfnPanels(); // Only display one at a time.

    dfn.setAttribute("aria-expanded", "true");

    const dfnPanel = genDfnPanel(dfn, dfn.panelData);

    // Give the dfn a unique tabindex, and then
    // give all the tabbable panel bits successive indexes.
    let tabIndex = 100;
    dfn.tabIndex = tabIndex++;
    const tabbable = dfnPanel.querySelectorAll(":is(a, button)");
    for (const el of tabbable) {
        el.tabIndex = tabIndex++;
    }

    append(document.body, dfnPanel);
    positionDfnPanel(dfnPanel);
}

function positionDfnPanel(dfnPanel) {
    const dfn = dfnPanel.dfn;
    const dfnPos = getBounds(dfn);
    dfnPanel.style.top = dfnPos.bottom + "px";
    dfnPanel.style.left = dfnPos.left + "px";

    const panelPos = dfnPanel.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, dfnPos.left - overflowAmount);
        dfnPanel.style.left = newLeft + "px";
    }
}

function pinDfnPanel(dfnPanel) {
    // Switch it to "activated" state, which pins it.
    dfnPanel.classList.add("activated");
    dfnPanel.style.position = "fixed";
    dfnPanel.style.left = null;
    dfnPanel.style.top = null;
}

function hideDfnPanel({dfn, dfnPanel}) {
    if(!dfnPanel) dfnPanel = dfn.dfnPanel;
    if(!dfn) dfn = dfnPanel.dfn;
    dfn.dfnPanel = undefined;
    dfnPanel.dfn = undefined;
    dfn.setAttribute("aria-expanded", "false");
    dfn.tabIndex = undefined;
    dfnPanel.remove()
}

function toggleDfnPanel(dfn) {
    if(dfn.dfnPanel) {
        hideDfnPanel(dfn);
    } else {
        showDfnPanel(dfn);
    }
}

function insertDfnPopupAction(dfn) {
    dfn.setAttribute('role', 'button');
    dfn.setAttribute('aria-expanded', 'false')
    dfn.tabIndex = 0;
    dfn.classList.add('has-dfn-panel');
    dfn.addEventListener('click', (event) => {
        toggleDfnPanel(dfn);
        event.stopPropagation();
    });
    dfn.addEventListener('keypress', (event) => {
        const kc = event.keyCode;
        // 32->Space, 13->Enter
        if(kc == 32 || kc == 13) {
            toggleDfnPanel(dfn);
            event.stopPropagation();
            event.preventDefault();
        }
    });
}

function refocusOnTarget(event) {
    const target = event.target;
    setTimeout(() => {
        // Refocus on the event.target element.
        // This is needed after browser scrolls to the destination.
        target.focus();
    });
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function scrollToTargetAndHighlight(event) {
    let hash = event.target.hash;
    if (hash) {
        hash = decodeURIComponent(hash.substring(1));
        const dest = document.getElementById(hash);
        if (dest) {
            dest.classList.add('highlighted');
            setTimeout(() => dest.classList.remove('highlighted'), 1000);
        }
    }
}

// Functions, divided by link type, that wrap an autolink's
// contents with the appropriate outer syntax.
// Alternately, a string naming another type they format
// the same as.
function needsFor(type) {
    switch(type) {
        case "descriptor":
        case "value":
        case "element-attr":
        case "attr-value":
        case "element-state":
        case "method":
        case "constructor":
        case "argument":
        case "attribute":
        case "const":
        case "dict-member":
        case "event":
        case "enum-value":
        case "stringifier":
        case "serializer":
        case "iterator":
        case "maplike":
        case "setlike":
        case "state":
        case "mode":
        case "context":
        case "facet": return true;

        default: return false;
    }
}
function refusesFor(type) {
    switch(type) {
        case "property":
        case "element":
        case "interface":
        case "namespace":
        case "callback":
        case "dictionary":
        case "enum":
        case "exception":
        case "typedef":
        case "http-header":
        case "permission": return true;

        default: return false;
    }
}
function linkFormatterFromType(type) {
    switch(type) {
        case 'scheme':
        case 'permission':
        case 'dfn': return (text) => `[=${text}=]`;

        case 'abstract-op': return (text) => `[\$${text}\$]`;

        case 'function':
        case 'at-rule':
        case 'selector':
        case 'value': return (text) => `''${text}''`;

        case 'http-header': return (text) => `[:${text}:]`;

        case 'interface':
        case 'constructor':
        case 'method':
        case 'argument':
        case 'attribute':
        case 'callback':
        case 'dictionary':
        case 'dict-member':
        case 'enum':
        case 'enum-value':
        case 'exception':
        case 'const':
        case 'typedef':
        case 'stringifier':
        case 'serializer':
        case 'iterator':
        case 'maplike':
        case 'setlike':
        case 'extended-attribute':
        case 'event':
        case 'idl': return (text) => `{{${text}}}`;

        case 'element-state':
        case 'element-attr':
        case 'attr-value':
        case 'element': return (element) => `<{${element}}>`;

        case 'grammar': return (text) => `${text} (within a <pre class=prod>)`;

        case 'type': return (text)=> `<<${text}>>`;

        case 'descriptor':
        case 'property': return (text) => `'${text}'`;

        default: return;
    };
};

function genLinkingSyntaxes(dfn) {
    if(dfn.tagName != "DFN") return;

    const type = dfn.getAttribute('data-dfn-type');
    if(!type) {
        console.log(`<dfn> doesn't have a data-dfn-type:`, dfn);
        return [];
    }

    // Return a function that wraps link text based on the type
    const linkFormatter = linkFormatterFromType(type);
    if(!linkFormatter) {
        console.log(`<dfn> has an unknown data-dfn-type:`, dfn);
        return [];
    }

    let ltAlts;
    if(dfn.hasAttribute('data-lt')) {
        ltAlts = dfn.getAttribute('data-lt')
            .split("|")
            .map(x=>x.trim());
    } else {
        ltAlts = [dfn.textContent.trim()];
    }
    if(type == "type") {
        // lt of "<foo>", but "foo" is the interior;
        // <<foo/bar>> is how you write it with a for,
        // not <foo/<bar>> or whatever.
        for(var i = 0; i < ltAlts.length; i++) {
            const lt = ltAlts[i];
            const match = /<(.*)>/.exec(lt);
            if(match) { ltAlts[i] = match[1]; }
        }
    }

    let forAlts;
    if(dfn.hasAttribute('data-dfn-for')) {
        forAlts = dfn.getAttribute('data-dfn-for')
            .split(",")
            .map(x=>x.trim());
    } else {
        forAlts = [''];
    }

    let linkingSyntaxes = [];
    if(!needsFor(type)) {
        for(const lt of ltAlts) {
            linkingSyntaxes.push(linkFormatter(lt));
        }
    }
    if(!refusesFor(type)) {
        for(const f of forAlts) {
            linkingSyntaxes.push(linkFormatter(`${f}/${ltAlts[0]}`))
        }
    }
    return [
        mk.b({}, 'Possible linking syntaxes:'),
        mk.ul({},
            ...linkingSyntaxes.map(link => {
                const copyLink = async () =>
                    await navigator.clipboard.writeText(link);
                return mk.li({},
                    mk.div({ class: 'link-item' },
                        mk.button({
                            class: 'copy-icon', title: 'Copy',
                            type: 'button',
                            _onclick: copyLink,
                            tabindex: 0,
                        }, mk.span({ class: 'icon' }) ),
                        mk.span({}, link)
                    )
                );
            })
        )
    ];
}
}
</script>
<script>/* Boilerplate: script-ref-hints */
"use strict";
{
let refsData = {
"#prerender-candidate": {"displayText":"prerender candidate","export":true,"for_":[],"level":"1","normative":true,"shortname":"speculation-rules","spec":"speculation-rules-1","status":"local","text":"prerender candidate","type":"dfn","url":"#prerender-candidate"},
"#prerender-candidate-target-navigable-name-hint": {"displayText":"target navigable name hint","export":true,"for_":["prerender candidate"],"level":"1","normative":true,"shortname":"speculation-rules","spec":"speculation-rules-1","status":"local","text":"target navigable name hint","type":"dfn","url":"#prerender-candidate-target-navigable-name-hint"},
"#speculation-rule-set-prerender-rules": {"displayText":"prerender rules","export":true,"for_":["speculation rule set"],"level":"1","normative":true,"shortname":"speculation-rules","spec":"speculation-rules-1","status":"local","text":"prerender rules","type":"dfn","url":"#speculation-rule-set-prerender-rules"},
"#speculation-rule-target-navigable-name-hint": {"displayText":"target navigable name hint","export":true,"for_":["speculation rule"],"level":"1","normative":true,"shortname":"speculation-rules","spec":"speculation-rules-1","status":"local","text":"target navigable name hint","type":"dfn","url":"#speculation-rule-target-navigable-name-hint"},
"50adabbe_https://whatpr.org/html/11426/speculative-loading.html#speculation-rule-set": {"displayText":"parse a speculation rule set string","export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"parse a speculation rule set string","type":"dfn","url":"https://whatpr.org/html/11426/speculative-loading.html#speculation-rule-set"},
"9dbd0ebb_https://whatpr.org/html/11426/speculative-loading.html#speculation-rule": {"displayText":"parse a speculation rule","export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"parse a speculation rule","type":"dfn","url":"https://whatpr.org/html/11426/speculative-loading.html#speculation-rule"},
"https://console.spec.whatwg.org/#report-a-warning-to-the-console": {"displayText":"report a warning to the console","export":true,"for_":[],"level":"1","normative":true,"shortname":"console","spec":"console","status":"current","text":"report a warning to the console","type":"dfn","url":"https://console.spec.whatwg.org/#report-a-warning-to-the-console"},
"https://html.spec.whatwg.org/multipage/document-sequences.html#valid-navigable-target-name-or-keyword": {"displayText":"valid navigable target name or keyword","export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"valid navigable target name or keyword","type":"dfn","url":"https://html.spec.whatwg.org/multipage/document-sequences.html#valid-navigable-target-name-or-keyword"},
"https://html.spec.whatwg.org/multipage/links.html#concept-hyperlink-url": {"displayText":"url","export":true,"for_":["HTMLHyperlinkElementUtils"],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"url","type":"dfn","url":"https://html.spec.whatwg.org/multipage/links.html#concept-hyperlink-url"},
"https://infra.spec.whatwg.org/#list": {"displayText":"list","export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"list","type":"dfn","url":"https://infra.spec.whatwg.org/#list"},
"https://infra.spec.whatwg.org/#list-append": {"displayText":"append","export":true,"for_":["list"],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"append","type":"dfn","url":"https://infra.spec.whatwg.org/#list-append"},
"https://infra.spec.whatwg.org/#list-iterate": {"displayText":"for each","export":true,"for_":["list","set"],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"for each","type":"dfn","url":"https://infra.spec.whatwg.org/#list-iterate"},
"https://infra.spec.whatwg.org/#map-exists": {"displayText":"exist","export":true,"for_":["map"],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"exist","type":"dfn","url":"https://infra.spec.whatwg.org/#map-exists"},
"https://infra.spec.whatwg.org/#string": {"displayText":"string","export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"string","type":"dfn","url":"https://infra.spec.whatwg.org/#string"},
"https://infra.spec.whatwg.org/#struct": {"displayText":"struct","export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"struct","type":"dfn","url":"https://infra.spec.whatwg.org/#struct"},
"https://infra.spec.whatwg.org/#struct-item": {"displayText":"item","export":true,"for_":["struct","tuple"],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"item","type":"dfn","url":"https://infra.spec.whatwg.org/#struct-item"},
"https://whatpr.org/html/11426/semantics.html#get-an-element's-target": {"displayText":"get an element's target","export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"get an element's target","type":"dfn","url":"https://whatpr.org/html/11426/semantics.html#get-an-element's-target"},
"https://whatpr.org/html/11426/speculative-loading.html#collecting-tags-for-matching-speculative-load-candidates": {"displayText":"collecting tags for matching speculative load candidates","export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"collecting tags for matching speculative load candidates","type":"dfn","url":"https://whatpr.org/html/11426/speculative-loading.html#collecting-tags-for-matching-speculative-load-candidates"},
"https://whatpr.org/html/11426/speculative-loading.html#compute-speculative-load-referrer-policy": {"displayText":"compute a speculative load referrer policy","export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"compute a speculative load referrer policy","type":"dfn","url":"https://whatpr.org/html/11426/speculative-loading.html#compute-speculative-load-referrer-policy"},
"https://whatpr.org/html/11426/speculative-loading.html#document-sr-sets": {"displayText":"speculation rule sets","export":true,"for_":["Document"],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"speculation rule sets","type":"dfn","url":"https://whatpr.org/html/11426/speculative-loading.html#document-sr-sets"},
"https://whatpr.org/html/11426/speculative-loading.html#finding-matching-links": {"displayText":"finding matching links","export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"finding matching links","type":"dfn","url":"https://whatpr.org/html/11426/speculative-loading.html#finding-matching-links"},
"https://whatpr.org/html/11426/speculative-loading.html#inner-consider-speculative-loads-steps": {"displayText":"inner consider speculative loads steps","export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"inner consider speculative loads steps","type":"dfn","url":"https://whatpr.org/html/11426/speculative-loading.html#inner-consider-speculative-loads-steps"},
"https://whatpr.org/html/11426/speculative-loading.html#prefetch-candidate": {"displayText":"prefetch candidate","export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"prefetch candidate","type":"dfn","url":"https://whatpr.org/html/11426/speculative-loading.html#prefetch-candidate"},
"https://whatpr.org/html/11426/speculative-loading.html#sl-candidate-anonymization-policy": {"displayText":"anonymization policy","export":true,"for_":["prefetch candidate"],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"anonymization policy","type":"dfn","url":"https://whatpr.org/html/11426/speculative-loading.html#sl-candidate-anonymization-policy"},
"https://whatpr.org/html/11426/speculative-loading.html#sl-candidate-eagerness": {"displayText":"eagerness","export":true,"for_":["speculative load candidate"],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"eagerness","type":"dfn","url":"https://whatpr.org/html/11426/speculative-loading.html#sl-candidate-eagerness"},
"https://whatpr.org/html/11426/speculative-loading.html#sl-candidate-nvs-hint": {"displayText":"No-Vary-Search hint","export":true,"for_":["speculative load candidate"],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"no-vary-search hint","type":"dfn","url":"https://whatpr.org/html/11426/speculative-loading.html#sl-candidate-nvs-hint"},
"https://whatpr.org/html/11426/speculative-loading.html#sl-candidate-referrer-policy": {"displayText":"referrer policy","export":true,"for_":["speculative load candidate"],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"referrer policy","type":"dfn","url":"https://whatpr.org/html/11426/speculative-loading.html#sl-candidate-referrer-policy"},
"https://whatpr.org/html/11426/speculative-loading.html#sl-candidate-tags": {"displayText":"tags","export":true,"for_":["speculative load candidate"],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"tags","type":"dfn","url":"https://whatpr.org/html/11426/speculative-loading.html#sl-candidate-tags"},
"https://whatpr.org/html/11426/speculative-loading.html#sl-candidate-url": {"displayText":"URL","export":true,"for_":["speculative load candidate"],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"url","type":"dfn","url":"https://whatpr.org/html/11426/speculative-loading.html#sl-candidate-url"},
"https://whatpr.org/html/11426/speculative-loading.html#speculation-rule": {"displayText":"speculation rule","export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"speculation rule","type":"dfn","url":"https://whatpr.org/html/11426/speculative-loading.html#speculation-rule"},
"https://whatpr.org/html/11426/speculative-loading.html#speculation-rule-set": {"displayText":"speculation rule set","export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"speculation rule set","type":"dfn","url":"https://whatpr.org/html/11426/speculative-loading.html#speculation-rule-set"},
"https://whatpr.org/html/11426/speculative-loading.html#speculative-load-candidate": {"displayText":"speculative load candidate","export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"speculative load candidate","type":"dfn","url":"https://whatpr.org/html/11426/speculative-loading.html#speculative-load-candidate"},
"https://whatpr.org/html/11426/speculative-loading.html#sr-eagerness": {"displayText":"eagerness","export":true,"for_":["speculation rule"],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"eagerness","type":"dfn","url":"https://whatpr.org/html/11426/speculative-loading.html#sr-eagerness"},
"https://whatpr.org/html/11426/speculative-loading.html#sr-nvs-hint": {"displayText":"No-Vary-Search hint","export":true,"for_":["speculation rule"],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"no-vary-search hint","type":"dfn","url":"https://whatpr.org/html/11426/speculative-loading.html#sr-nvs-hint"},
"https://whatpr.org/html/11426/speculative-loading.html#sr-predicate": {"displayText":"predicate","export":true,"for_":["speculation rule"],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"predicate","type":"dfn","url":"https://whatpr.org/html/11426/speculative-loading.html#sr-predicate"},
"https://whatpr.org/html/11426/speculative-loading.html#sr-set-prefetch": {"displayText":"prefetch rules","export":true,"for_":["speculation rule set"],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"prefetch rules","type":"dfn","url":"https://whatpr.org/html/11426/speculative-loading.html#sr-set-prefetch"},
"https://whatpr.org/html/11426/speculative-loading.html#sr-tags": {"displayText":"tags","export":true,"for_":["speculation rule"],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"tags","type":"dfn","url":"https://whatpr.org/html/11426/speculative-loading.html#sr-tags"},
"https://whatpr.org/html/11426/speculative-loading.html#sr-urls": {"displayText":"URLs","export":true,"for_":["speculation rule"],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"urls","type":"dfn","url":"https://whatpr.org/html/11426/speculative-loading.html#sr-urls"},
"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record": {"displayText":"prefetch record","export":true,"for_":[],"level":"1","normative":true,"shortname":"prefetch","spec":"prefetch","status":"current","text":"prefetch record","type":"dfn","url":"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record"},
"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-anonymization-policy": {"displayText":"anonymization policy","export":true,"for_":["prefetch record"],"level":"1","normative":true,"shortname":"prefetch","spec":"prefetch","status":"current","text":"anonymization policy","type":"dfn","url":"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-anonymization-policy"},
"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-no-vary-search-hint": {"displayText":"No-Vary-Search hint","export":true,"for_":["prefetch record"],"level":"1","normative":true,"shortname":"prefetch","spec":"prefetch","status":"current","text":"no-vary-search hint","type":"dfn","url":"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-no-vary-search-hint"},
"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-prerendering-target-navigable-name-hint": {"displayText":"prerendering target navigable name hint","export":true,"for_":["prefetch record"],"level":"1","normative":true,"shortname":"prefetch","spec":"prefetch","status":"current","text":"prerendering target navigable name hint","type":"dfn","url":"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-prerendering-target-navigable-name-hint"},
"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-prerendering-traversable": {"displayText":"prerendering traversable","export":true,"for_":["prefetch record"],"level":"1","normative":true,"shortname":"prefetch","spec":"prefetch","status":"current","text":"prerendering traversable","type":"dfn","url":"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-prerendering-traversable"},
"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-referrer-policy": {"displayText":"referrer policy","export":true,"for_":["prefetch record"],"level":"1","normative":true,"shortname":"prefetch","spec":"prefetch","status":"current","text":"referrer policy","type":"dfn","url":"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-referrer-policy"},
"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-source": {"displayText":"source","export":true,"for_":["prefetch record"],"level":"","normative":true,"shortname":"prefetch","spec":"prefetch","status":"anchor-block","text":"source","type":"dfn","url":"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-source"},
"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-tags": {"displayText":"tags","export":true,"for_":["prefetch record"],"level":"1","normative":true,"shortname":"prefetch","spec":"prefetch","status":"current","text":"tags","type":"dfn","url":"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-tags"},
"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-url": {"displayText":"URL","export":true,"for_":["prefetch record"],"level":"1","normative":true,"shortname":"prefetch","spec":"prefetch","status":"current","text":"url","type":"dfn","url":"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-url"},
"https://wicg.github.io/nav-speculation/prefetch.html#start-a-referrer-initiated-navigational-prefetch": {"displayText":"start a referrer-initiated navigational prefetch","export":true,"for_":[],"level":"","normative":true,"shortname":"prefetch","spec":"prefetch","status":"anchor-block","text":"start a referrer-initiated navigational prefetch","type":"dfn","url":"https://wicg.github.io/nav-speculation/prefetch.html#start-a-referrer-initiated-navigational-prefetch"},
"https://wicg.github.io/nav-speculation/prerendering.html#start-a-referrer-initiated-navigational-prerender": {"displayText":"start a referrer-initiated navigational prerender","export":true,"for_":[],"level":"","normative":true,"shortname":"prerendering-revamped","spec":"prerendering-revamped","status":"anchor-block","text":"start a referrer-initiated navigational prerender","type":"dfn","url":"https://wicg.github.io/nav-speculation/prerendering.html#start-a-referrer-initiated-navigational-prerender"},
};

function mkRefHint(link, ref) {
    const linkText = link.textContent;
    let dfnTextElements = '';
    if (ref.displayText.toLowerCase() != linkText.toLowerCase()) {
        // Give the original term if it's being displayed in a different way.
        // But allow casing differences, they're insignificant.
        dfnTextElements =
            mk.li({},
                mk.b({}, "Term: "),
                mk.span({}, ref.displayText)
            );
    }
    const forList = ref.for_;
    let forListElements;
    if(forList.length == 0) {
        forListElements = [];
    } else if(forList.length == 1) {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.span({}, forList[0]),
        );
    } else {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.ul({},
                ...forList.map(forItem =>
                    mk.li({},
                        mk.span({}, forItem)
                    ),
                ),
            ),
        );
    }
    const url = ref.url;
    const safeUrl = encodeURIComponent(url);
    const hintPanel = mk.aside({
        class: "ref-hint",
        id: `ref-hint-for-${safeUrl}`,
        "data-for": url,
        "aria-labelled-by": `ref-hint-for-${safeUrl}`,
    },
        mk.ul({},
            dfnTextElements,
            mk.li({},
                mk.b({}, "URL: "),
                mk.a({ href: url, class: "ref" }, url),
            ),
            mk.li({},
                mk.b({}, "Type: "),
                mk.span({}, `${ref.type}`),
            ),
            mk.li({},
                mk.b({}, "Spec: "),
                mk.span({}, `${ref.spec ? ref.spec : ''}`),
            ),
            forListElements
        ),
    );
    hintPanel.forLink = link;
    setupRefHintEventListeners(link, hintPanel);
    return hintPanel;
}

function hideAllRefHints() {
    queryAll(".ref-hint").forEach(el=>hideRefHint(el));
}

function hideRefHint(refHint) {
    const link = refHint.forLink;
    link.setAttribute("aria-expanded", "false");
    if(refHint.teardownEventListeners) {
        refHint.teardownEventListeners();
    }
    refHint.remove();
}

function showRefHint(link) {
    if(link.classList.contains("dfn-link")) return;
    const url = link.getAttribute("href");
    const refHintKey = link.getAttribute("data-refhint-key");
    let key = url;
    if(refHintKey) {
        key = refHintKey + "_" + url;
    }
    const ref = refsData[key];
    if(!ref) return;

    hideAllRefHints(); // Only display one at this time.

    const refHint = mkRefHint(link, ref);
    append(document.body, refHint);
    link.setAttribute("aria-expanded", "true");
    positionRefHint(refHint);
}

function setupRefHintEventListeners(link, refHint) {
    if (refHint.teardownEventListeners) return;
    // Add event handlers to hide the refHint after the user moves away
    // from both the link and refHint, if not hovering either within one second.
    let timeout = null;
    const startHidingRefHint = (event) => {
        if (timeout) {
            clearTimeout(timeout);
        }
        timeout = setTimeout(() => {
            hideRefHint(refHint);
        }, 1000);
    }
    const resetHidingRefHint = (event) => {
        if (timeout) clearTimeout(timeout);
        timeout = null;
    };
    link.addEventListener("mouseleave", startHidingRefHint);
    link.addEventListener("mouseenter", resetHidingRefHint);
    link.addEventListener("blur", startHidingRefHint);
    link.addEventListener("focus", resetHidingRefHint);
    refHint.addEventListener("mouseleave", startHidingRefHint);
    refHint.addEventListener("mouseenter", resetHidingRefHint);
    refHint.addEventListener("blur", startHidingRefHint);
    refHint.addEventListener("focus", resetHidingRefHint);

    refHint.teardownEventListeners = () => {
        // remove event listeners
        resetHidingRefHint();
        link.removeEventListener("mouseleave", startHidingRefHint);
        link.removeEventListener("mouseenter", resetHidingRefHint);
        link.removeEventListener("blur", startHidingRefHint);
        link.removeEventListener("focus", resetHidingRefHint);
        refHint.removeEventListener("mouseleave", startHidingRefHint);
        refHint.removeEventListener("mouseenter", resetHidingRefHint);
        refHint.removeEventListener("blur", startHidingRefHint);
        refHint.removeEventListener("focus", resetHidingRefHint);
    };
}

function positionRefHint(refHint) {
    const link = refHint.forLink;
    const linkPos = getBounds(link);
    refHint.style.top = linkPos.bottom + "px";
    refHint.style.left = linkPos.left + "px";

    const panelPos = refHint.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, linkPos.left - overflowAmount);
        refHint.style.left = newLeft + "px";
    }
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function showRefHintListener(e) {
    // If the target isn't in a link (or is a link),
    // just ignore it.
    let link = e.target.closest("a");
    if(!link) return;

    // If the target is in a ref-hint panel
    // (aka a link in the already-open one),
    // also just ignore it.
    if(link.closest(".ref-hint")) return;

    // Otherwise, show the panel for the link.
    showRefHint(link);
}

function hideAllHintsListener(e) {
    // If the click is inside a ref-hint panel, ignore it.
    if(e.target.closest(".ref-hint")) return;
    // Otherwise, close all the current panels.
    hideAllRefHints();
}

document.addEventListener("DOMContentLoaded", () => {
    document.body.addEventListener("mousedown", showRefHintListener);
    document.body.addEventListener("focus", showRefHintListener);

    document.body.addEventListener("click", hideAllHintsListener);
});

window.addEventListener("resize", () => {
    // Hide any open ref hint.
    hideAllRefHints();
});
}
</script>
<script>/* Boilerplate: script-var-click-highlighting */
"use strict";
{
/*
Color-choosing design:

* Colors are ordered by goodness.
* On clicking a var, give it the earliest color
    with the lowest usage in the algorithm.
* On re-clicking, re-use the var's most recent color
    if that's not currently being used elsewhere.
*/

const COLOR_COUNT = 7;

document.addEventListener("click", e=>{
    if(e.target.nodeName == "VAR") {
        highlightSameAlgoVars(e.target);
    }
});

function highlightSameAlgoVars(v) {
    // Find the algorithm container.
    let algoContainer = findAlgoContainer(v);

    // Not highlighting document-global vars,
    // too likely to be unrelated.
    if(algoContainer == null) return;

    const varName = nameFromVar(v);
    if(!v.hasAttribute("data-var-color")) {
        const newColor = chooseHighlightColor(algoContainer, v);
        for(const el of algoContainer.querySelectorAll("var")) {
            if(nameFromVar(el) == varName) {
                el.setAttribute("data-var-color", newColor);
                el.setAttribute("data-var-last-color", newColor);
            }
        }
    } else {
        for(const el of algoContainer.querySelectorAll("var")) {
            if(nameFromVar(el) == varName) {
                el.removeAttribute("data-var-color");
            }
        }
    }
}
function findAlgoContainer(el) {
    while(el != document.body) {
        if(el.hasAttribute("data-algorithm")) return el;
        el = el.parentNode;
    }
    return null;
}
function nameFromVar(el) {
    return el.textContent.replace(/(\s|\xa0)+/g, " ").trim();
}
function colorCountsFromContainer(container) {
    const namesFromColor = Array.from({length:COLOR_COUNT}, x=>new Set());
    for(let v of container.querySelectorAll("var[data-var-color]")) {
        let color = +v.getAttribute("data-var-color");
        namesFromColor[color].add(nameFromVar(v));
    }

    return namesFromColor.map(x=>x.size);
}
function leastUsedColor(colors) {
    // Find the earliest color with the lowest count.
    let minCount = Infinity;
    let minColor = null;
    for(var i = 0; i < colors.length; i++) {
        if(colors[i] < minCount) {
            minColor = i;
            minCount = colors[i];
        }
    }
    return minColor;
}
function chooseHighlightColor(container, v) {
    const colorCounts = colorCountsFromContainer(container);
    if(v.hasAttribute("data-var-last-color")) {
        let color = +v.getAttribute("data-var-last-color");
        if(colorCounts[color] == 0) return color;
    }
    return leastUsedColor(colorCounts);
}
}
</script>