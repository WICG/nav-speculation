<!doctype html><html lang="en">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <title>No-Vary-Search</title>
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <link href="https://www.w3.org/StyleSheets/TR/2021/cg-draft" rel="stylesheet">
  <meta content="Bikeshed version 44fb9b41e, updated Mon Oct 21 15:57:35 2024 -0700" name="generator">
  <link href="https://wicg.github.io/nav-speculation/no-vary-search.html" rel="canonical">
  <meta content="dark light" name="color-scheme">
  <link href="https://www.w3.org/StyleSheets/TR/2021/dark.css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css">
<style>
#example-equivalence-canonicalization table {
  border-collapse: collapse;
}

#example-equivalence-canonicalization table :is(td, th):first-of-type {
  border-right: 1px solid black;
  padding-right: 20px;
}

#example-equivalence-canonicalization table :is(td, th):nth-of-type(2) {
  padding-left: 5px;
}

#example-equivalence-canonicalization table tr.group {
  border-top: 1px solid black;
}
</style>
<style>/* Boilerplate: style-autolinks */
.css.css, .property.property, .descriptor.descriptor {
    color: var(--a-normal-text);
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}

@media (prefers-color-scheme: dark) {
    :root {
        --selflink-text: black;
        --selflink-bg: silver;
        --selflink-hover-text: white;
    }
}
</style>
<style>/* Boilerplate: style-colors */
/* Any --*-text not paired with a --*-bg is assumed to have a transparent bg */
:root {
    color-scheme: light dark;

    --text: black;
    --bg: white;

    --unofficial-watermark: url(https://www.w3.org/StyleSheets/TR/2016/logos/UD-watermark);

    --logo-bg: #1a5e9a;
    --logo-active-bg: #c00;
    --logo-text: white;

    --tocnav-normal-text: #707070;
    --tocnav-normal-bg: var(--bg);
    --tocnav-hover-text: var(--tocnav-normal-text);
    --tocnav-hover-bg: #f8f8f8;
    --tocnav-active-text: #c00;
    --tocnav-active-bg: var(--tocnav-normal-bg);

    --tocsidebar-text: var(--text);
    --tocsidebar-bg: #f7f8f9;
    --tocsidebar-shadow: rgba(0,0,0,.1);
    --tocsidebar-heading-text: hsla(203,20%,40%,.7);

    --toclink-text: var(--text);
    --toclink-underline: #3980b5;
    --toclink-visited-text: var(--toclink-text);
    --toclink-visited-underline: #054572;

    --heading-text: #005a9c;

    --hr-text: var(--text);

    --algo-border: #def;

    --del-text: red;
    --del-bg: transparent;
    --ins-text: #080;
    --ins-bg: transparent;

    --a-normal-text: #034575;
    --a-normal-underline: #bbb;
    --a-visited-text: var(--a-normal-text);
    --a-visited-underline: #707070;
    --a-hover-bg: rgba(75%, 75%, 75%, .25);
    --a-active-text: #c00;
    --a-active-underline: #c00;

    --blockquote-border: silver;
    --blockquote-bg: transparent;
    --blockquote-text: currentcolor;

    --issue-border: #e05252;
    --issue-bg: #fbe9e9;
    --issue-text: var(--text);
    --issueheading-text: #831616;

    --example-border: #e0cb52;
    --example-bg: #fcfaee;
    --example-text: var(--text);
    --exampleheading-text: #574b0f;

    --note-border: #52e052;
    --note-bg: #e9fbe9;
    --note-text: var(--text);
    --noteheading-text: hsl(120, 70%, 30%);
    --notesummary-underline: silver;

    --assertion-border: #aaa;
    --assertion-bg: #eee;
    --assertion-text: black;

    --advisement-border: orange;
    --advisement-bg: #fec;
    --advisement-text: var(--text);
    --advisementheading-text: #b35f00;

    --warning-border: red;
    --warning-bg: hsla(40,100%,50%,0.95);
    --warning-text: var(--text);

    --amendment-border: #330099;
    --amendment-bg: #F5F0FF;
    --amendment-text: var(--text);
    --amendmentheading-text: #220066;

    --def-border: #8ccbf2;
    --def-bg: #def;
    --def-text: var(--text);
    --defrow-border: #bbd7e9;

    --datacell-border: silver;

    --indexinfo-text: #707070;

    --indextable-hover-text: black;
    --indextable-hover-bg: #f7f8f9;

    --outdatedspec-bg: rgba(0, 0, 0, .5);
    --outdatedspec-text: black;
    --outdated-bg: maroon;
    --outdated-text: white;
    --outdated-shadow: red;

    --editedrec-bg: darkorange;
}

@media (prefers-color-scheme: dark) {
    :root {
        --text: #ddd;
        --bg: black;

        --unofficial-watermark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='%23100808' transform='translate(200 200) rotate(-45) translate(-200 -200)' stroke='%23100808' stroke-width='3'%3E%3Ctext x='50%25' y='220' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EUNOFFICIAL%3C/text%3E%3Ctext x='50%25' y='305' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EDRAFT%3C/text%3E%3C/g%3E%3C/svg%3E");

        --logo-bg: #1a5e9a;
        --logo-active-bg: #c00;
        --logo-text: white;

        --tocnav-normal-text: #999;
        --tocnav-normal-bg: var(--bg);
        --tocnav-hover-text: var(--tocnav-normal-text);
        --tocnav-hover-bg: #080808;
        --tocnav-active-text: #f44;
        --tocnav-active-bg: var(--tocnav-normal-bg);

        --tocsidebar-text: var(--text);
        --tocsidebar-bg: #080808;
        --tocsidebar-shadow: rgba(255,255,255,.1);
        --tocsidebar-heading-text: hsla(203,20%,40%,.7);

        --toclink-text: var(--text);
        --toclink-underline: #6af;
        --toclink-visited-text: var(--toclink-text);
        --toclink-visited-underline: #054572;

        --heading-text: #8af;

        --hr-text: var(--text);

        --algo-border: #456;

        --del-text: #f44;
        --del-bg: transparent;
        --ins-text: #4a4;
        --ins-bg: transparent;

        --a-normal-text: #6af;
        --a-normal-underline: #555;
        --a-visited-text: var(--a-normal-text);
        --a-visited-underline: var(--a-normal-underline);
        --a-hover-bg: rgba(25%, 25%, 25%, .2);
        --a-active-text: #f44;
        --a-active-underline: var(--a-active-text);

        --borderedblock-bg: rgba(255, 255, 255, .05);

        --blockquote-border: silver;
        --blockquote-bg: var(--borderedblock-bg);
        --blockquote-text: currentcolor;

        --issue-border: #e05252;
        --issue-bg: var(--borderedblock-bg);
        --issue-text: var(--text);
        --issueheading-text: hsl(0deg, 70%, 70%);

        --example-border: hsl(50deg, 90%, 60%);
        --example-bg: var(--borderedblock-bg);
        --example-text: var(--text);
        --exampleheading-text: hsl(50deg, 70%, 70%);

        --note-border: hsl(120deg, 100%, 35%);
        --note-bg: var(--borderedblock-bg);
        --note-text: var(--text);
        --noteheading-text: hsl(120, 70%, 70%);
        --notesummary-underline: silver;

        --assertion-border: #444;
        --assertion-bg: var(--borderedblock-bg);
        --assertion-text: var(--text);

        --advisement-border: orange;
        --advisement-bg: #222218;
        --advisement-text: var(--text);
        --advisementheading-text: #f84;

        --warning-border: red;
        --warning-bg: hsla(40,100%,20%,0.95);
        --warning-text: var(--text);

        --amendment-border: #330099;
        --amendment-bg: #080010;
        --amendment-text: var(--text);
        --amendmentheading-text: #cc00ff;

        --def-border: #8ccbf2;
        --def-bg: #080818;
        --def-text: var(--text);
        --defrow-border: #136;

        --datacell-border: silver;

        --indexinfo-text: #aaa;

        --indextable-hover-text: var(--text);
        --indextable-hover-bg: #181818;

        --outdatedspec-bg: rgba(255, 255, 255, .5);
        --outdatedspec-text: black;
        --outdated-bg: maroon;
        --outdated-text: white;
        --outdated-shadow: red;

        --editedrec-bg: darkorange;
    }
    /* In case a transparent-bg image doesn't expect to be on a dark bg,
       which is quite common in practice... */
    img { background: white; }
}
</style>
<style>/* Boilerplate: style-counters */
body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example" counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}
</style>
<style>/* Boilerplate: style-dfn-panel */
:root {
    --dfnpanel-bg: #ddd;
    --dfnpanel-text: var(--text);
    --dfnpanel-target-bg: #ffc;
    --dfnpanel-target-outline: orange;
}
@media (prefers-color-scheme: dark) {
    :root {
        --dfnpanel-bg: #222;
        --dfnpanel-text: var(--text);
        --dfnpanel-target-bg: #333;
        --dfnpanel-target-outline: silver;
    }
}
.dfn-panel {
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--dfnpanel-bg);
    color: var(--dfnpanel-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: var(--dfnpanel-text); }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel a:focus {
    outline: 5px auto Highlight;
    outline: 5px auto -webkit-focus-ring-color;
}
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0 0 0 1em; list-style: none; }
.dfn-panel li a {
    max-width: calc(300px - 1.5em - 1em);
    overflow: hidden;
    text-overflow: ellipsis;
}

.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: 8px;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
    transition: left 1s ease-out, bottom 1s ease-out;
}

.dfn-panel .link-item:hover {
    text-decoration: underline;
}
.dfn-panel .link-item .copy-icon {
    opacity: 0;
}
.dfn-panel .link-item:hover .copy-icon,
.dfn-panel .link-item .copy-icon:focus {
    opacity: 1;
}

.dfn-panel .copy-icon {
    display: inline-block;
    margin-right: 0.5em;
    width: 0.85em;
    height: 1em;
    border-radius: 3px;
    background-color: #ccc;
    cursor: pointer;
}

.dfn-panel .copy-icon .icon {
    width: 100%;
    height: 100%;
    background-color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}

.dfn-panel .copy-icon .icon::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 1px solid black;
    background-color: #ccc;
    opacity: 0.25;
    transform: translate(3px, -3px);
}

.dfn-panel .copy-icon:active .icon::before {
    opacity: 1;
}

.dfn-paneled[role="button"] { cursor: help; }

.highlighted {
    animation: target-fade 3s;
}

@keyframes target-fade {
    from {
        background-color: var(--dfnpanel-target-bg);
        outline: 5px solid var(--dfnpanel-target-outline);
    }
    to {
        color: var(--a-normal-text);
        background-color: transparent;
        outline: transparent;
    }
}
</style>
<style>/* Boilerplate: style-issues */
a[href].issue-return {
    float: right;
    float: inline-end;
    color: var(--issueheading-text);
    font-weight: bold;
    text-decoration: none;
}
</style>
<style>/* Boilerplate: style-md-lists */
/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}
</style>
<style>/* Boilerplate: style-ref-hints */
:root {
    --ref-hint-bg: #ddd;
    --ref-hint-text: var(--text);
}
@media (prefers-color-scheme: dark) {
    :root {
        --ref-hint-bg: #222;
        --ref-hint-text: var(--text);
    }
}

.ref-hint {
    display: inline-block;
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.5em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--ref-hint-bg);
    color: var(--ref-hint-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}

.ref-hint * { margin: 0; padding: 0; text-indent: 0; }

.ref-hint ul { padding: 0 0 0 1em; list-style: none; }
</style>
<style>/* Boilerplate: style-selflinks */
:root {
    --selflink-text: white;
    --selflink-bg: gray;
    --selflink-hover-text: black;
}
.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
.example > a.self-link,
.note > a.self-link,
.issue > a.self-link {
    /* These blocks are overflow:auto, so positioning outside
       doesn't work. */
    left: auto;
    right: 0;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: var(--selflink-bg);
    color: var(--selflink-text);
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: var(--selflink-hover-text);
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }
</style>
<style>/* Boilerplate: style-syntax-highlighting */
code.highlight { padding: .1em; border-radius: .3em; }
pre.highlight, pre > code.highlight { display: block; padding: 1em; margin: .5em 0; overflow: auto; border-radius: 0; }

.highlight:not(.idl) { background: rgba(0, 0, 0, .03); }
c-[a] { color: #990055 } /* Keyword.Declaration */
c-[b] { color: #990055 } /* Keyword.Type */
c-[c] { color: #708090 } /* Comment */
c-[d] { color: #708090 } /* Comment.Multiline */
c-[e] { color: #0077aa } /* Name.Attribute */
c-[f] { color: #669900 } /* Name.Tag */
c-[g] { color: #222222 } /* Name.Variable */
c-[k] { color: #990055 } /* Keyword */
c-[l] { color: #000000 } /* Literal */
c-[m] { color: #000000 } /* Literal.Number */
c-[n] { color: #0077aa } /* Name */
c-[o] { color: #999999 } /* Operator */
c-[p] { color: #999999 } /* Punctuation */
c-[s] { color: #a67f59 } /* Literal.String */
c-[t] { color: #a67f59 } /* Literal.String.Single */
c-[u] { color: #a67f59 } /* Literal.String.Double */
c-[cp] { color: #708090 } /* Comment.Preproc */
c-[c1] { color: #708090 } /* Comment.Single */
c-[cs] { color: #708090 } /* Comment.Special */
c-[kc] { color: #990055 } /* Keyword.Constant */
c-[kn] { color: #990055 } /* Keyword.Namespace */
c-[kp] { color: #990055 } /* Keyword.Pseudo */
c-[kr] { color: #990055 } /* Keyword.Reserved */
c-[ld] { color: #000000 } /* Literal.Date */
c-[nc] { color: #0077aa } /* Name.Class */
c-[no] { color: #0077aa } /* Name.Constant */
c-[nd] { color: #0077aa } /* Name.Decorator */
c-[ni] { color: #0077aa } /* Name.Entity */
c-[ne] { color: #0077aa } /* Name.Exception */
c-[nf] { color: #0077aa } /* Name.Function */
c-[nl] { color: #0077aa } /* Name.Label */
c-[nn] { color: #0077aa } /* Name.Namespace */
c-[py] { color: #0077aa } /* Name.Property */
c-[ow] { color: #999999 } /* Operator.Word */
c-[mb] { color: #000000 } /* Literal.Number.Bin */
c-[mf] { color: #000000 } /* Literal.Number.Float */
c-[mh] { color: #000000 } /* Literal.Number.Hex */
c-[mi] { color: #000000 } /* Literal.Number.Integer */
c-[mo] { color: #000000 } /* Literal.Number.Oct */
c-[sb] { color: #a67f59 } /* Literal.String.Backtick */
c-[sc] { color: #a67f59 } /* Literal.String.Char */
c-[sd] { color: #a67f59 } /* Literal.String.Doc */
c-[se] { color: #a67f59 } /* Literal.String.Escape */
c-[sh] { color: #a67f59 } /* Literal.String.Heredoc */
c-[si] { color: #a67f59 } /* Literal.String.Interpol */
c-[sx] { color: #a67f59 } /* Literal.String.Other */
c-[sr] { color: #a67f59 } /* Literal.String.Regex */
c-[ss] { color: #a67f59 } /* Literal.String.Symbol */
c-[vc] { color: #0077aa } /* Name.Variable.Class */
c-[vg] { color: #0077aa } /* Name.Variable.Global */
c-[vi] { color: #0077aa } /* Name.Variable.Instance */
c-[il] { color: #000000 } /* Literal.Number.Integer.Long */

@media (prefers-color-scheme: dark) {
    .highlight:not(.idl) { background: rgba(255, 255, 255, .05); }

    c-[a] { color: #d33682 } /* Keyword.Declaration */
    c-[b] { color: #d33682 } /* Keyword.Type */
    c-[c] { color: #2aa198 } /* Comment */
    c-[d] { color: #2aa198 } /* Comment.Multiline */
    c-[e] { color: #268bd2 } /* Name.Attribute */
    c-[f] { color: #b58900 } /* Name.Tag */
    c-[g] { color: #cb4b16 } /* Name.Variable */
    c-[k] { color: #d33682 } /* Keyword */
    c-[l] { color: #657b83 } /* Literal */
    c-[m] { color: #657b83 } /* Literal.Number */
    c-[n] { color: #268bd2 } /* Name */
    c-[o] { color: #657b83 } /* Operator */
    c-[p] { color: #657b83 } /* Punctuation */
    c-[s] { color: #6c71c4 } /* Literal.String */
    c-[t] { color: #6c71c4 } /* Literal.String.Single */
    c-[u] { color: #6c71c4 } /* Literal.String.Double */
    c-[ch] { color: #2aa198 } /* Comment.Hashbang */
    c-[cp] { color: #2aa198 } /* Comment.Preproc */
    c-[cpf] { color: #2aa198 } /* Comment.PreprocFile */
    c-[c1] { color: #2aa198 } /* Comment.Single */
    c-[cs] { color: #2aa198 } /* Comment.Special */
    c-[kc] { color: #d33682 } /* Keyword.Constant */
    c-[kn] { color: #d33682 } /* Keyword.Namespace */
    c-[kp] { color: #d33682 } /* Keyword.Pseudo */
    c-[kr] { color: #d33682 } /* Keyword.Reserved */
    c-[ld] { color: #657b83 } /* Literal.Date */
    c-[nc] { color: #268bd2 } /* Name.Class */
    c-[no] { color: #268bd2 } /* Name.Constant */
    c-[nd] { color: #268bd2 } /* Name.Decorator */
    c-[ni] { color: #268bd2 } /* Name.Entity */
    c-[ne] { color: #268bd2 } /* Name.Exception */
    c-[nf] { color: #268bd2 } /* Name.Function */
    c-[nl] { color: #268bd2 } /* Name.Label */
    c-[nn] { color: #268bd2 } /* Name.Namespace */
    c-[py] { color: #268bd2 } /* Name.Property */
    c-[ow] { color: #657b83 } /* Operator.Word */
    c-[mb] { color: #657b83 } /* Literal.Number.Bin */
    c-[mf] { color: #657b83 } /* Literal.Number.Float */
    c-[mh] { color: #657b83 } /* Literal.Number.Hex */
    c-[mi] { color: #657b83 } /* Literal.Number.Integer */
    c-[mo] { color: #657b83 } /* Literal.Number.Oct */
    c-[sa] { color: #6c71c4 } /* Literal.String.Affix */
    c-[sb] { color: #6c71c4 } /* Literal.String.Backtick */
    c-[sc] { color: #6c71c4 } /* Literal.String.Char */
    c-[dl] { color: #6c71c4 } /* Literal.String.Delimiter */
    c-[sd] { color: #6c71c4 } /* Literal.String.Doc */
    c-[se] { color: #6c71c4 } /* Literal.String.Escape */
    c-[sh] { color: #6c71c4 } /* Literal.String.Heredoc */
    c-[si] { color: #6c71c4 } /* Literal.String.Interpol */
    c-[sx] { color: #6c71c4 } /* Literal.String.Other */
    c-[sr] { color: #6c71c4 } /* Literal.String.Regex */
    c-[ss] { color: #6c71c4 } /* Literal.String.Symbol */
    c-[fm] { color: #268bd2 } /* Name.Function.Magic */
    c-[vc] { color: #cb4b16 } /* Name.Variable.Class */
    c-[vg] { color: #cb4b16 } /* Name.Variable.Global */
    c-[vi] { color: #cb4b16 } /* Name.Variable.Instance */
    c-[vm] { color: #cb4b16 } /* Name.Variable.Magic */
    c-[il] { color: #657b83 } /* Literal.Number.Integer.Long */
}
</style>
<style>/* Boilerplate: style-var-click-highlighting */
/*
Colors were chosen in Lab using https://nixsensor.com/free-color-converter/
D50 2deg illuminant, L in [0,100], a and b in [-128, 128]
0 = lab(85,0,85)
1 = lab(85,80,30)
2 = lab(85,-40,40)
3 = lab(85,-50,0)
4 = lab(85,5,15)
5 = lab(85,-10,-50)
6 = lab(85,35,-15)

For darkmode:
0 = oklab(50%   0%  108%)
1 = oklab(50% -51%   51%)
2 = oklab(50% -64%  -20%)
3 = oklab(50%   6%   19%)
4 = oklab(50% -12%  -64%)
5 = oklab(50%  44%  -19%)  
6 = oklab(50% 102%   38%)
*/

[data-algorithm] var { cursor: pointer; }
var[data-var-color] { background-color: var(--var-bg); box-shadow: 0 0 0 2px var(--var-bg); }

var[data-var-color] { --var-bg: #F4D200; }
var[data-var-color="1"] { --var-bg: #FF87A2; }
var[data-var-color="2"] { --var-bg: #96E885; }
var[data-var-color="3"] { --var-bg: #3EEED2; }
var[data-var-color="4"] { --var-bg: #EACFB6; }
var[data-var-color="5"] { --var-bg: #82DDFF; }
var[data-var-color="6"] { --var-vg: #FFBCF2; }

@media (prefers-color-scheme: dark) {
	var[data-var-color] { --var-bg: #bc1a00; }
	var[data-var-color="1"] { --var-bg: #007f00; }
	var[data-var-color="2"] { --var-bg: #008698; }
	var[data-var-color="3"] { --var-bg: #7f5b2b; }
	var[data-var-color="4"] { --var-bg: #004df3; }
	var[data-var-color="5"] { --var-bg: #a1248a; }
	var[data-var-color="6"] { --var-vg: #ff0000; }
}
</style>
 <body class="h-entry">
  <div class="head">
   <p data-fill-with="logo"><a class="logo" href="https://www.w3.org/"> <img alt="W3C" height="48" src="https://www.w3.org/StyleSheets/TR/2021/logos/W3C" width="72"> </a> </p>
   <h1 class="p-name no-ref" id="title">No-Vary-Search</h1>
   <p id="w3c-state"><a href="https://www.w3.org/standards/types/#CG-DRAFT">Draft Community Group Report</a>, <time class="dt-updated" datetime="2024-10-22">22 October 2024</time></p>
   <div data-fill-with="spec-metadata">
    <dl>
     <dt>This version:
     <dd><a class="u-url" href="https://wicg.github.io/nav-speculation/no-vary-search.html">https://wicg.github.io/nav-speculation/no-vary-search.html</a>
     <dt>Issue Tracking:
     <dd><a href="https://github.com/WICG/nav-speculation/issues/">GitHub</a>
     <dt class="editor">Editor:
     <dd class="editor p-author h-card vcard"><a class="p-name fn u-email email" href="mailto:d@domenic.me">Domenic Denicola</a> (<a class="p-org org" href="https://www.google.com/">Google</a>)
    </dl>
   </div>
   <div data-fill-with="warning"></div>
   <p class="copyright" data-fill-with="copyright"><a href="https://www.w3.org/policies/#copyright">Copyright</a> © 2024 the Contributors to the No-Vary-Search Specification, published by the <a href="https://www.w3.org/community/wicg/">Web Platform Incubator Community Group</a> under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a>.
A human-readable <a href="http://www.w3.org/community/about/agreements/cla-deed/">summary</a> is available. </p>
   <hr title="Separator for header">
  </div>
  <div class="p-summary" data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>A proposed HTTP header field for changing how URL search parameters impact caching</p>
  </div>
  <div data-fill-with="at-risk"></div>
  <h2 class="no-num no-toc no-ref heading settled" id="status"><span class="content">Status of this document</span></h2>
  <div data-fill-with="status">
   <p> This specification was published by the <a href="https://www.w3.org/community/wicg/">Web Platform Incubator Community Group</a>.
  It is not a W3C Standard nor is it on the W3C Standards Track.

  Please note that under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a> there is a limited opt-out and other conditions apply.

  Learn more about <a href="http://www.w3.org/community/">W3C Community and Business Groups</a>. </p>
   <p></p>
  </div>
  <div data-fill-with="at-risk"></div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li><a href="#status-and-venue"><span class="secno">1</span> <span class="content">Status and venue note</span></a>
    <li><a href="#header-definition"><span class="secno">2</span> <span class="content">HTTP header field definition</span></a>
    <li><a href="#model"><span class="secno">3</span> <span class="content">Data model</span></a>
    <li><a href="#parsing"><span class="secno">4</span> <span class="content">Parsing</span></a>
    <li><a href="#comparing"><span class="secno">5</span> <span class="content">Comparing</span></a>
    <li><a href="#security-considerations"><span class="secno">6</span> <span class="content">Security considerations</span></a>
    <li><a href="#privacy-considerations"><span class="secno">7</span> <span class="content">Privacy considerations</span></a>
    <li>
     <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
     <ol class="toc">
      <li><a href="#index-defined-here"><span class="secno"></span> <span class="content">Terms defined by this specification</span></a>
      <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span class="content">Terms defined by reference</span></a>
     </ol>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#normative"><span class="secno"></span> <span class="content">Normative References</span></a>
      <li><a href="#informative"><span class="secno"></span> <span class="content">Informative References</span></a>
     </ol>
   </ol>
  </nav>
  <main>
   <h2 class="heading settled" data-level="1" id="status-and-venue"><span class="secno">1. </span><span class="content">Status and venue note</span><a class="self-link" href="#status-and-venue"></a></h2>
   <p>This document is being written as a web-style specification in the WICG for now, because that’s the tooling and venue the author is familiar with. Its purpose is to nail down some details of the processing model in order to make writing and testing prototypes easier.</p>
   <p>In the longer term, we envision this header being specified in a HTTPWG RFC, alongside whatever portion of the processing model can be shared among its various consumers. (That is, between both web platform specifications such as <a data-link-type="biblio" href="#biblio-fetch" title="Fetch Standard">[FETCH]</a>, and HTTP specifications such as future modifications to <a data-link-type="biblio" href="#biblio-rfc9111" title="HTTP Caching">[RFC9111]</a>.) It’s just incubating in WICG for now.</p>
   <h2 class="heading settled" data-level="2" id="header-definition"><span class="secno">2. </span><span class="content">HTTP header field definition</span><a class="self-link" href="#header-definition"></a></h2>
   <p>The `<dfn class="dfn-paneled" data-dfn-type="http-header" data-export id="http-headerdef-no-vary-search"><code>No-Vary-Search</code></dfn>` HTTP header field is a <a data-link-type="dfn" href="https://www.rfc-editor.org/rfc/rfc8941.html#section-1" id="ref-for-section-1">structured header</a> whose value must be a <a data-link-type="dfn" href="https://www.rfc-editor.org/rfc/rfc8941.html#name-dictionaries" id="ref-for-name-dictionaries">dictionary</a>.</p>
   <p>TODO: probably give some more introductory non-normative text. Look at what other HTTP field defintions do.</p>
   <p>It has the following authoring conformance requirements:</p>
   <ul>
    <li data-md>
     <p>If present, the <code>key-order</code> entry’s value must be a <a data-link-type="dfn" href="https://www.rfc-editor.org/rfc/rfc8941.html#name-boolean" id="ref-for-name-boolean">boolean</a>.</p>
    <li data-md>
     <p>If present, the <code>params</code> entry’s value must be either a <a data-link-type="dfn" href="https://www.rfc-editor.org/rfc/rfc8941.html#name-boolean" id="ref-for-name-boolean①">boolean</a> or an <a data-link-type="dfn" href="https://www.rfc-editor.org/rfc/rfc8941.html#name-inner-lists" id="ref-for-name-inner-lists">inner list</a>.</p>
    <li data-md>
     <p>If present, the <code>except</code> entry’s value must be a <a data-link-type="dfn" href="https://www.rfc-editor.org/rfc/rfc8941.html#name-inner-lists" id="ref-for-name-inner-lists①">inner list</a>.</p>
    <li data-md>
     <p>The <code>except</code> entry must only be present if the <code>params</code> entry is also present, and the <code>params</code> entry’s value is the boolean value true.</p>
   </ul>
   <p>The dictionary may contain entries whose keys are not one of <code>key-order</code>, <code>params</code>, and <code>except</code>, but their meaning is not defined by this specification. Implementations of this specification will ignore such entries (but future documents may assign meaning to such entries).</p>
   <p class="note" role="note">As always, the authoring conformance requirements are not binding on implementations. Implementations instead need to implement the processing model given by the <a data-link-type="dfn" href="#obtain-a-url-search-variance" id="ref-for-obtain-a-url-search-variance">obtain a URL search variance</a> algorithm. </p>
   <h2 class="heading settled" data-level="3" id="model"><span class="secno">3. </span><span class="content">Data model</span><a class="self-link" href="#model"></a></h2>
   <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="url-search-variance">URL search variance</dfn> is a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#struct" id="ref-for-struct">struct</a> whose <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#struct-item" id="ref-for-struct-item">items</a> are the following:</p>
   <ul>
    <li data-md>
     <p><dfn class="dfn-paneled" data-dfn-for="URL search variance" data-dfn-type="dfn" data-noexport id="url-search-variance-no-vary-params">no-vary params</dfn>, either the special value <dfn class="dfn-paneled" data-dfn-for="URL search variance/no-vary params" data-dfn-type="dfn" data-noexport id="url-search-variance-no-vary-params-wildcard">wildcard</dfn> or a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list">list</a> of <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#string" id="ref-for-string">strings</a></p>
    <li data-md>
     <p><dfn class="dfn-paneled" data-dfn-for="URL search variance" data-dfn-type="dfn" data-noexport id="url-search-variance-vary-params">vary params</dfn>, either the special value <dfn class="dfn-paneled" data-dfn-for="URL search variance/vary params" data-dfn-type="dfn" data-noexport id="url-search-variance-vary-params-wildcard">wildcard</dfn> or a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list①">list</a> of <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#string" id="ref-for-string①">strings</a></p>
    <li data-md>
     <p><dfn class="dfn-paneled" data-dfn-for="URL search variance" data-dfn-type="dfn" data-noexport id="url-search-variance-vary-on-key-order">vary on key order</dfn>, a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#boolean" id="ref-for-boolean">boolean</a></p>
   </ul>
   <p>The <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="default-url-search-variance">default URL search variance</dfn> is a <a data-link-type="dfn" href="#url-search-variance" id="ref-for-url-search-variance">URL search variance</a> whose <a data-link-type="dfn" href="#url-search-variance-no-vary-params" id="ref-for-url-search-variance-no-vary-params">no-vary params</a> is an empty list, <a data-link-type="dfn" href="#url-search-variance-vary-params" id="ref-for-url-search-variance-vary-params">vary params</a> is <a data-link-type="dfn" href="#url-search-variance-vary-params-wildcard" id="ref-for-url-search-variance-vary-params-wildcard">wildcard</a>, and <a data-link-type="dfn" href="#url-search-variance-vary-on-key-order" id="ref-for-url-search-variance-vary-on-key-order">vary on key order</a> is true.</p>
   <p>The <a data-link-type="dfn" href="#obtain-a-url-search-variance" id="ref-for-obtain-a-url-search-variance①">obtain a URL search variance</a> algorithm ensures that all <a data-link-type="dfn" href="#url-search-variance" id="ref-for-url-search-variance①">URL search variances</a> obey the following constraints:</p>
   <ul>
    <li data-md>
     <p><a data-link-type="dfn" href="#url-search-variance-vary-params" id="ref-for-url-search-variance-vary-params①">vary params</a> is a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list②">list</a> if and only if the <a data-link-type="dfn" href="#url-search-variance-no-vary-params" id="ref-for-url-search-variance-no-vary-params①">no-vary params</a> is <a data-link-type="dfn" href="#url-search-variance-no-vary-params-wildcard" id="ref-for-url-search-variance-no-vary-params-wildcard">wildcard</a>; and</p>
    <li data-md>
     <p><a data-link-type="dfn" href="#url-search-variance-no-vary-params" id="ref-for-url-search-variance-no-vary-params②">no-vary params</a> is a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list③">list</a> if and only if the <a data-link-type="dfn" href="#url-search-variance-vary-params" id="ref-for-url-search-variance-vary-params②">vary params</a> is <a data-link-type="dfn" href="#url-search-variance-vary-params-wildcard" id="ref-for-url-search-variance-vary-params-wildcard①">wildcard</a>.</p>
   </ul>
   <h2 class="heading settled" data-level="4" id="parsing"><span class="secno">4. </span><span class="content">Parsing</span><a class="self-link" href="#parsing"></a></h2>
   <div class="algorithm" data-algorithm="parse a URL search variance">
     To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="parse-a-url-search-variance">parse a URL search variance</dfn> given a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#ordered-map" id="ref-for-ordered-map">map</a> <var>value</var>: 
    <ol>
     <li data-md>
      <p>If <var>value</var> is null, then return the <a data-link-type="dfn" href="#default-url-search-variance" id="ref-for-default-url-search-variance">default URL search variance</a>.</p>
     <li data-md>
      <p>If <var>value</var>’s <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#map-getting-the-keys" id="ref-for-map-getting-the-keys">keys</a> <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-contain" id="ref-for-list-contain">contains</a> anything other than "<code>key-order</code>", "<code>params</code>", or "<code>except</code>", then return the <a data-link-type="dfn" href="#default-url-search-variance" id="ref-for-default-url-search-variance①">default URL search variance</a>.</p>
     <li data-md>
      <p>Let <var>result</var> be a new <a data-link-type="dfn" href="#url-search-variance" id="ref-for-url-search-variance②">URL search variance</a>.</p>
     <li data-md>
      <p>Set <var>result</var>’s <a data-link-type="dfn" href="#url-search-variance-vary-on-key-order" id="ref-for-url-search-variance-vary-on-key-order①">vary on key order</a> to true.</p>
     <li data-md>
      <p>If <var>value</var>["<code>key-order</code>"] <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#map-exists" id="ref-for-map-exists">exists</a>:</p>
      <ol>
       <li data-md>
        <p>If <var>value</var>["<code>key-order</code>"] is not a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#boolean" id="ref-for-boolean①">boolean</a>, then return the <a data-link-type="dfn" href="#default-url-search-variance" id="ref-for-default-url-search-variance②">default URL search variance</a>.</p>
       <li data-md>
        <p>Set <var>result</var>’s <a data-link-type="dfn" href="#url-search-variance-vary-on-key-order" id="ref-for-url-search-variance-vary-on-key-order②">vary on key order</a> to the boolean negation of <var>value</var>["<code>key-order</code>"].</p>
      </ol>
     <li data-md>
      <p>If <var>value</var>["<code>params</code>"] <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#map-exists" id="ref-for-map-exists①">exists</a>:</p>
      <ol>
       <li data-md>
        <p>If <var>value</var>["<code>params</code>"] is a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#boolean" id="ref-for-boolean②">boolean</a>:</p>
        <ol>
         <li data-md>
          <p>If <var>value</var>["<code>params</code>"] is true, then:</p>
          <ol>
           <li data-md>
            <p>Set <var>result</var>’s <a data-link-type="dfn" href="#url-search-variance-no-vary-params" id="ref-for-url-search-variance-no-vary-params③">no-vary params</a> to <a data-link-type="dfn" href="#url-search-variance-no-vary-params-wildcard" id="ref-for-url-search-variance-no-vary-params-wildcard①">wildcard</a>.</p>
           <li data-md>
            <p>Set <var>result</var>’s <a data-link-type="dfn" href="#url-search-variance-vary-params" id="ref-for-url-search-variance-vary-params③">vary params</a> to the empty list.</p>
          </ol>
         <li data-md>
          <p>Otherwise:</p>
          <ol>
           <li data-md>
            <p>Set <var>result</var>’s <a data-link-type="dfn" href="#url-search-variance-no-vary-params" id="ref-for-url-search-variance-no-vary-params④">no-vary params</a> to the empty list.</p>
           <li data-md>
            <p>Set <var>result</var>’s <a data-link-type="dfn" href="#url-search-variance-vary-params" id="ref-for-url-search-variance-vary-params④">vary params</a> to <a data-link-type="dfn" href="#url-search-variance-no-vary-params-wildcard" id="ref-for-url-search-variance-no-vary-params-wildcard②">wildcard</a>.</p>
          </ol>
        </ol>
       <li data-md>
        <p>Otherwise, if <var>value</var>["<code>params</code>"] is a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list④">list</a>:</p>
        <ol>
         <li data-md>
          <p>If any <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-item" id="ref-for-list-item">item</a> in <var>value</var>["<code>params</code>"] is not a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#string" id="ref-for-string②">string</a>, then return the <a data-link-type="dfn" href="#default-url-search-variance" id="ref-for-default-url-search-variance③">default URL search variance</a>.</p>
         <li data-md>
          <p>Set <var>result</var>’s <a data-link-type="dfn" href="#url-search-variance-no-vary-params" id="ref-for-url-search-variance-no-vary-params⑤">no-vary params</a> to the result of applying <a data-link-type="dfn" href="#parse-a-key" id="ref-for-parse-a-key">parse a key</a> to each <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-item" id="ref-for-list-item①">item</a> in <var>value</var>["<code>params</code>"].</p>
         <li data-md>
          <p>Set <var>result</var>’s <a data-link-type="dfn" href="#url-search-variance-vary-params" id="ref-for-url-search-variance-vary-params⑤">vary params</a> to <a data-link-type="dfn" href="#url-search-variance-no-vary-params-wildcard" id="ref-for-url-search-variance-no-vary-params-wildcard③">wildcard</a>.</p>
        </ol>
       <li data-md>
        <p>Otherwise, return the <a data-link-type="dfn" href="#default-url-search-variance" id="ref-for-default-url-search-variance④">default URL search variance</a>.</p>
      </ol>
     <li data-md>
      <p>If <var>value</var>["<code>except</code>"] <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#map-exists" id="ref-for-map-exists②">exists</a>:</p>
      <ol>
       <li data-md>
        <p>If <var>value</var>["<code>params</code>"] is not true, then return the <a data-link-type="dfn" href="#default-url-search-variance" id="ref-for-default-url-search-variance⑤">default URL search variance</a>.</p>
       <li data-md>
        <p>If <var>value</var>["<code>except</code>"] is not a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list⑤">list</a>, then return the <a data-link-type="dfn" href="#default-url-search-variance" id="ref-for-default-url-search-variance⑥">default URL search variance</a>.</p>
       <li data-md>
        <p>If any <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-item" id="ref-for-list-item②">item</a> in <var>value</var>["<code>except</code>"] is not a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#string" id="ref-for-string③">string</a>, then return the <a data-link-type="dfn" href="#default-url-search-variance" id="ref-for-default-url-search-variance⑦">default URL search variance</a>.</p>
       <li data-md>
        <p>Set <var>result</var>’s <a data-link-type="dfn" href="#url-search-variance-vary-params" id="ref-for-url-search-variance-vary-params⑥">vary params</a> to the result of applying <a data-link-type="dfn" href="#parse-a-key" id="ref-for-parse-a-key①">parse a key</a> to each <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-item" id="ref-for-list-item③">item</a> in <var>value</var>["<code>except</code>"].</p>
      </ol>
     <li data-md>
      <p>Return <var>result</var>.</p>
    </ol>
    <div class="note" role="note">
     <p>In general, this algorithm is strict and tends to return the <a data-link-type="dfn" href="#default-url-search-variance" id="ref-for-default-url-search-variance⑧">default URL search variance</a> whenever it sees something it doesn’t recognize. This is because the <a data-link-type="dfn" href="#default-url-search-variance" id="ref-for-default-url-search-variance⑨">default URL search variance</a> behavior will just cause fewer cache hits, which is an acceptable fallback behavior.</p>
     <p>However, unrecognized keys at the top level are ignored, to make it easier to extend this specification in the future. To avoid misbehavior with existing client software, such extensions will likely expand, rather than reduce, the set of requests that a cached response can match.</p>
    </div>
   </div>
   <div class="algorithm" data-algorithm="obtain a URL search variance">
     To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="obtain-a-url-search-variance">obtain a URL search variance</dfn> given a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response" id="ref-for-concept-response">response</a> <var>response</var>: 
    <ol>
     <li data-md>
      <p>Let <var>fieldValue</var> be the result of <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-header-list-get-structured-header" id="ref-for-concept-header-list-get-structured-header">getting a structured field value</a> given <span>`<code><a data-link-type="http-header" href="#http-headerdef-no-vary-search" id="ref-for-http-headerdef-no-vary-search">No-Vary-Search</a></code>`</span> and "<code>dictionary</code>" from <var>response</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-header-list" id="ref-for-concept-response-header-list">header list</a>.</p>
     <li data-md>
      <p>Return the result of <a data-link-type="dfn" href="#parse-a-url-search-variance" id="ref-for-parse-a-url-search-variance">parsing a URL search variance</a> given <var>fieldValue</var>.</p>
    </ol>
   </div>
   <div class="example" id="example-parsing-vary-vs-no-vary">
    <a class="self-link" href="#example-parsing-vary-vs-no-vary"></a> The following illustrates how various inputs are parsed, in terms of their impacting on the resulting <a data-link-type="dfn" href="#url-search-variance-no-vary-params" id="ref-for-url-search-variance-no-vary-params⑥">no-vary params</a> and <a data-link-type="dfn" href="#url-search-variance-vary-params" id="ref-for-url-search-variance-vary-params⑦">vary params</a>: 
    <table class="data">
     <thead>
      <tr>
       <th>Input
       <th>Result
     <tbody>
      <tr>
       <td>
<pre class="highlight">No-Vary-Search: params</pre>
       <td>
        <ul>
         <li data-md>
          <p><a data-link-type="dfn" href="#url-search-variance-no-vary-params" id="ref-for-url-search-variance-no-vary-params⑦">no-vary params</a>: <a data-link-type="dfn" href="#url-search-variance-no-vary-params-wildcard" id="ref-for-url-search-variance-no-vary-params-wildcard④">wildcard</a></p>
         <li data-md>
          <p><a data-link-type="dfn" href="#url-search-variance-vary-params" id="ref-for-url-search-variance-vary-params⑧">vary params</a>: (empty list)</p>
        </ul>
      <tr>
       <td>
<pre class="highlight">No-Vary-Search: params=("a")</pre>
       <td>
        <ul>
         <li data-md>
          <p><a data-link-type="dfn" href="#url-search-variance-no-vary-params" id="ref-for-url-search-variance-no-vary-params⑧">no-vary params</a>: « "<code>a</code>" »</p>
         <li data-md>
          <p><a data-link-type="dfn" href="#url-search-variance-vary-params" id="ref-for-url-search-variance-vary-params⑨">vary params</a>: <a data-link-type="dfn" href="#url-search-variance-vary-params-wildcard" id="ref-for-url-search-variance-vary-params-wildcard②">wildcard</a></p>
        </ul>
      <tr>
       <td>
<pre class="highlight">No-Vary-Search: params, except=("x")</pre>
       <td>
        <ul>
         <li data-md>
          <p><a data-link-type="dfn" href="#url-search-variance-no-vary-params" id="ref-for-url-search-variance-no-vary-params⑨">no-vary params</a>: <a data-link-type="dfn" href="#url-search-variance-no-vary-params-wildcard" id="ref-for-url-search-variance-no-vary-params-wildcard⑤">wildcard</a></p>
         <li data-md>
          <p><a data-link-type="dfn" href="#url-search-variance-vary-params" id="ref-for-url-search-variance-vary-params①⓪">vary params</a>: « "<code>x</code>" »</p>
        </ul>
    </table>
   </div>
   <div class="example" id="example-parsing-invalid">
    <a class="self-link" href="#example-parsing-invalid"></a> The following inputs are all invalid and will cause the <a data-link-type="dfn" href="#default-url-search-variance" id="ref-for-default-url-search-variance①⓪">default URL search variance</a> to be returned: 
    <ul>
     <li data-md>
      <p><code>No-Vary-Search: unknown-key</code></p>
     <li data-md>
      <p><code>No-Vary-Search: key-order="not a boolean"</code></p>
     <li data-md>
      <p><code>No-Vary-Search: params="not a boolean or inner list"</code></p>
     <li data-md>
      <p><code>No-Vary-Search: params=(not-a-string)</code></p>
     <li data-md>
      <p><code>No-Vary-Search: params=("a"), except=("x")</code></p>
     <li data-md>
      <p><code>No-Vary-Search: params=(), except=()</code></p>
     <li data-md>
      <p><code>No-Vary-Search: params=?0, except=("x")</code></p>
     <li data-md>
      <p><code>No-Vary-Search: params, except=(not-a-string)</code></p>
     <li data-md>
      <p><code>No-Vary-Search: params, except="not an inner list"</code></p>
     <li data-md>
      <p><code>No-Vary-Search: params, except=?1</code></p>
     <li data-md>
      <p><code>No-Vary-Search: except=("x")</code></p>
     <li data-md>
      <p><code>No-Vary-Search: except=()</code></p>
    </ul>
   </div>
   <div class="example" id="example-parsing-unconventional">
    <a class="self-link" href="#example-parsing-unconventional"></a> The following inputs are valid, but somewhat unconventional. They are shown alongside their more conventional form. 
    <table>
     <thead>
      <tr>
       <th>Input 
       <th>Conventional form 
     <tbody>
      <tr>
       <td>
<pre class="highlight">No-Vary-Search: params=?1</pre>
       <td>
<pre class="highlight">No-Vary-Search: params</pre>
      <tr>
       <td>
<pre class="highlight">No-Vary-Search: key-order=?1</pre>
       <td>
<pre class="highlight">No-Vary-Search: key-order</pre>
      <tr>
       <td>
<pre class="highlight">No-Vary-Search: params, key-order, except=("x")</pre>
       <td>
<pre class="highlight">No-Vary-Search: key-order, params, except=("x")</pre>
      <tr>
       <td>
<pre class="highlight">No-Vary-Search: params=?0</pre>
       <td>(omit the header) 
      <tr>
       <td>
<pre class="highlight">No-Vary-Search: params=()</pre>
       <td>(omit the header) 
      <tr>
       <td>
<pre class="highlight">No-Vary-Search: key-order=?0</pre>
       <td>(omit the header) 
    </table>
   </div>
   <div class="algorithm" data-algorithm="obtain a URL search variance hint">
     To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="obtain-a-url-search-variance-hint">obtain a URL search variance hint</dfn> given a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#string" id="ref-for-string④">string</a> <var>hintValue</var>: 
    <ol>
     <li data-md>
      <p>Let <var>fieldValue</var> be the result of <a data-link-type="dfn" href="https://www.rfc-editor.org/rfc/rfc8941.html#text-parse" id="ref-for-text-parse">parsing structured fields</a> given <var>hintValue</var> and "<code>dictionary</code>".</p>
     <li data-md>
      <p>If parsing failed, then return the <a data-link-type="dfn" href="#default-url-search-variance" id="ref-for-default-url-search-variance①①">default URL search variance</a>.</p>
     <li data-md>
      <p>Return the result of <a data-link-type="dfn" href="#parse-a-url-search-variance" id="ref-for-parse-a-url-search-variance①">parsing a URL search variance</a> given <var>fieldValue</var>.</p>
    </ol>
   </div>
   <div class="algorithm" data-algorithm="parse a key">
     To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="parse-a-key">parse a key</dfn> given an <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#ascii-string" id="ref-for-ascii-string">ASCII string</a> <var>keyString</var>: 
    <ol>
     <li data-md>
      <p>Let <var>keyBytes</var> be the <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#isomorphic-encode" id="ref-for-isomorphic-encode">isomorphic encoding</a> of <var>keyString</var>.</p>
     <li data-md>
      <p>Replace any 0x2B (+) in <var>keyBytes</var> with 0x20 (SP).</p>
     <li data-md>
      <p>Let <var>keyBytesDecoded</var> be the <a data-link-type="dfn" href="https://url.spec.whatwg.org/#percent-decode" id="ref-for-percent-decode">percent-decoding</a> of <var>keyBytes</var>.</p>
     <li data-md>
      <p>Let <var>keyStringDecoded</var> be the <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#utf-8-decode-without-bom" id="ref-for-utf-8-decode-without-bom">UTF-8 decoding without BOM</a> of <var>keyBytesDecoded</var>.</p>
     <li data-md>
      <p>Return <var>keyStringDecoded</var>.</p>
    </ol>
   </div>
   <div class="example" id="example-parse-a-key">
    <a class="self-link" href="#example-parse-a-key"></a> The <a data-link-type="dfn" href="#parse-a-key" id="ref-for-parse-a-key②">parse a key</a> algorithm allows encoding non-ASCII key strings in the ASCII structured header format, similar to how the <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-urlencoded" id="ref-for-concept-urlencoded"><code>application/x-www-form-urlencoded</code></a> format allows encoding an entire entry list of keys and values in ASCII URL format. For example, 
<pre class="highlight">No-Vary-Search: params=("%C3%A9+%E6%B0%97")</pre>
    <p>will result in a <a data-link-type="dfn" href="#url-search-variance" id="ref-for-url-search-variance③">URL search variance</a> whose <a data-link-type="dfn" href="#url-search-variance-vary-params" id="ref-for-url-search-variance-vary-params①①">vary params</a> are « "<code>é 気</code>" ». As explained in <a href="#example-equivalence-canonicalization">a later example</a>, the canonicalization process during <a data-link-type="dfn" href="#equivalent-modulo-search-variance" id="ref-for-equivalent-modulo-search-variance">equivalence testing</a> means this will treat as equivalent URL strings such as:</p>
    <ul>
     <li data-md>
      <p><code>https://example.com/?é 気=1</code></p>
     <li data-md>
      <p><code>https://example.com/?é+気=2</code></p>
     <li data-md>
      <p><code>https://example.com/?%C3%A9%20気=3</code></p>
     <li data-md>
      <p><code>https://example.com/?%C3%A9+%E6%B0%97=4</code></p>
    </ul>
    <p>and so on, since they all are <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-urlencoded-parser" id="ref-for-concept-urlencoded-parser">parsed</a> to having the same key "<code>é 気</code>".</p>
   </div>
   <h2 class="heading settled" data-level="5" id="comparing"><span class="secno">5. </span><span class="content">Comparing</span><a class="self-link" href="#comparing"></a></h2>
   <p>Two <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url" id="ref-for-concept-url">URLs</a> <var>urlA</var> and <var>urlB</var> are <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="equivalent-modulo-search-variance">equivalent modulo search variance</dfn> given a <a data-link-type="dfn" href="#url-search-variance" id="ref-for-url-search-variance④">URL search variance</a> <var>searchVariance</var> if the following algorithm returns true:</p>
   <ol>
    <li data-md>
     <p>If the <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-scheme" id="ref-for-concept-url-scheme">scheme</a>, <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-username" id="ref-for-concept-url-username">username</a>, <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-password" id="ref-for-concept-url-password">password</a>, <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-host" id="ref-for-concept-url-host">host</a>, <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-port" id="ref-for-concept-url-port">port</a>, or <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-path" id="ref-for-concept-url-path">path</a> of <var>urlA</var> and <var>urlB</var> differ, then return false.</p>
    <li data-md>
     <p>If <var>searchVariance</var> is equivalent to the <a data-link-type="dfn" href="#default-url-search-variance" id="ref-for-default-url-search-variance①②">default URL search variance</a>, then:</p>
     <ol>
      <li data-md>
       <p>If <var>urlA</var>’s <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-query" id="ref-for-concept-url-query">query</a> equals <var>urlB</var>’s <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-query" id="ref-for-concept-url-query①">query</a>, then return true.</p>
      <li data-md>
       <p>Return false.</p>
     </ol>
     <p class="note" role="note">In this case, even <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url" id="ref-for-concept-url①">URL</a> pairs that might appear the same after running the <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-urlencoded-parser" id="ref-for-concept-urlencoded-parser①">application/x-www-form-urlencoded parser</a> on their <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-query" id="ref-for-concept-url-query②">queries</a>, such as <code>https://example.com/a</code> and <code>https://example.com/a?</code>, or <code>https://example.com/foo?a=b&amp;&amp;&amp;c</code> and <code>https://example.com/foo?a=b&amp;c=</code>, will be treated as inequivalent. </p>
    <li data-md>
     <p>Let <var>searchParamsA</var> and <var>searchParamsB</var> be empty <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list⑥">lists</a>.</p>
    <li data-md>
     <p>If <var>urlA</var>’s <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-query" id="ref-for-concept-url-query③">query</a> is not null, then set <var>searchParamsA</var> to the result of running the <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-urlencoded-parser" id="ref-for-concept-urlencoded-parser②">application/x-www-form-urlencoded parser</a> given the <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#isomorphic-encode" id="ref-for-isomorphic-encode①">isomorphic encoding</a> of <var>urlA</var>’s <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-query" id="ref-for-concept-url-query④">query</a>.</p>
    <li data-md>
     <p>If <var>urlB</var>’s <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-query" id="ref-for-concept-url-query⑤">query</a> is not null, then set <var>searchParamsB</var> to the result of running the <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-urlencoded-parser" id="ref-for-concept-urlencoded-parser③">application/x-www-form-urlencoded parser</a> given the <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#isomorphic-encode" id="ref-for-isomorphic-encode②">isomorphic encoding</a> of <var>urlB</var>’s <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-query" id="ref-for-concept-url-query⑥">query</a>.</p>
    <li data-md>
     <p>If <var>searchVariance</var>’s <a data-link-type="dfn" href="#url-search-variance-no-vary-params" id="ref-for-url-search-variance-no-vary-params①⓪">no-vary params</a> is a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list⑦">list</a>, then:</p>
     <ol>
      <li data-md>
       <p>Set <var>searchParamsA</var> to a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list⑧">list</a> containing those <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-item" id="ref-for-list-item④">items</a> <var>pair</var> in <var>searchParamsA</var> where <var>searchVariance</var>’s <a data-link-type="dfn" href="#url-search-variance-no-vary-params" id="ref-for-url-search-variance-no-vary-params①①">no-vary params</a> does not <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-contain" id="ref-for-list-contain①">contain</a> <var>pair</var>[0].</p>
      <li data-md>
       <p>Set <var>searchParamsB</var> to a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list⑨">list</a> containing those <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-item" id="ref-for-list-item⑤">items</a> <var>pair</var> in <var>searchParamsB</var> where <var>searchVariance</var>’s <a data-link-type="dfn" href="#url-search-variance-no-vary-params" id="ref-for-url-search-variance-no-vary-params①②">no-vary params</a> does not <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-contain" id="ref-for-list-contain②">contain</a> <var>pair</var>[0].</p>
     </ol>
    <li data-md>
     <p>Otherwise, if <var>searchVariance</var>’s <a data-link-type="dfn" href="#url-search-variance-vary-params" id="ref-for-url-search-variance-vary-params①②">vary params</a> is a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list①⓪">list</a>, then:</p>
     <ol>
      <li data-md>
       <p>Set <var>searchParamsA</var> to a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list①①">list</a> containing those <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-item" id="ref-for-list-item⑥">items</a> <var>pair</var> in <var>searchParamsA</var> where <var>searchVariance</var>’s <a data-link-type="dfn" href="#url-search-variance-vary-params" id="ref-for-url-search-variance-vary-params①③">vary params</a> <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-contain" id="ref-for-list-contain③">contains</a> <var>pair</var>[0].</p>
      <li data-md>
       <p>Set <var>searchParamsB</var> to a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list①②">list</a> containing those <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-item" id="ref-for-list-item⑦">items</a> <var>pair</var> in <var>searchParamsB</var> where <var>searchVariance</var>’s <a data-link-type="dfn" href="#url-search-variance-vary-params" id="ref-for-url-search-variance-vary-params①④">vary params</a> <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-contain" id="ref-for-list-contain④">contains</a> <var>pair</var>[0].</p>
     </ol>
    <li data-md>
     <p>If <var>searchVariance</var>’s <a data-link-type="dfn" href="#url-search-variance-vary-on-key-order" id="ref-for-url-search-variance-vary-on-key-order③">vary on key order</a> is false, then:</p>
     <ol>
      <li data-md>
       <p>Let <var>keyLessThan</var> be an algorithm taking as inputs two pairs (<var>keyA</var>, <var>valueA</var>) and (<var>keyB</var>, <var>valueB</var>), which returns whether <var>keyA</var> is <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#code-unit-less-than" id="ref-for-code-unit-less-than">code unit less than</a> <var>keyB</var>.</p>
      <li data-md>
       <p>Set <var>searchParamsA</var> to the result of <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-sort-in-ascending-order" id="ref-for-list-sort-in-ascending-order">sorting in ascending order</a> <var>searchParamsA</var>, with <var>keyLessThan</var>.</p>
      <li data-md>
       <p>Set <var>searchParamsB</var> to the result of <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-sort-in-ascending-order" id="ref-for-list-sort-in-ascending-order①">sorting in ascending order</a> <var>searchParamsB</var>, with <var>keyLessThan</var>.</p>
     </ol>
    <li data-md>
     <p>If <var>searchParamsA</var>’s <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-size" id="ref-for-list-size">size</a> is not equal to <var>searchParamsB</var>’s <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-size" id="ref-for-list-size①">size</a>, then return false.</p>
    <li data-md>
     <p>Let <var>i</var> be 0.</p>
    <li data-md>
     <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#iteration-while" id="ref-for-iteration-while">While</a> <var>i</var> &lt; <var>searchParamsA</var>’s <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-size" id="ref-for-list-size②">size</a>:</p>
     <ol>
      <li data-md>
       <p>If <var>searchParamsA</var>[<var>i</var>][0] does not equal <var>searchParamsB</var>[<var>i</var>][0], then return false.</p>
      <li data-md>
       <p>If <var>searchParamsA</var>[<var>i</var>][1] does not equal <var>searchParamsB</var>[<var>i</var>][1], then return false.</p>
      <li data-md>
       <p>Set <var>i</var> to <var>i</var> + 1.</p>
     </ol>
    <li data-md>
     <p>Return true.</p>
   </ol>
   <div class="example" id="example-equivalence-canonicalization">
    <a class="self-link" href="#example-equivalence-canonicalization"></a> Due to how the <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-urlencoded-parser" id="ref-for-concept-urlencoded-parser④">application/x-www-form-urlencoded parser</a> canonicalizes query strings, there are some cases where query strings which do not appear obviously equivalent, will end up being treated as equivalent after parsing. 
    <p>So, for example, given any non-default value for <code>No-Vary-Search</code>, such as <code>No-Vary-Search: key-order</code>, we will have the following equivalences:</p>
    <table>
     <thead>
      <tr>
       <th>Equivalent URL strings 
       <th>Explanation 
     <tbody>
      <tr class="group">
       <td><code>https://example.com/</code> 
       <td rowspan="2">A null <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-query" id="ref-for-concept-url-query⑦">query</a> is parsed the same as an empty string query 
      <tr>
       <td><code>https://example.com/?</code> 
      <tr class="group">
       <td><code>https://example.com/?a=x</code> 
       <td rowspan="2">Parsing performs percent-decoding 
      <tr>
       <td><code>https://example.com/?%61=%78</code> 
      <tr class="group">
       <td><code>https://example.com/?a=é</code> 
       <td rowspan="2">Parsing performs percent-decoding 
      <tr>
       <td><code>https://example.com/?a=%C3%A9</code> 
      <tr class="group">
       <td><code>https://example.com/?a=%f6</code> 
       <td rowspan="2">Both values are parsed as U+FFFD (�) 
      <tr>
       <td><code>https://example.com/?a=%ef%bf%bd</code> 
      <tr class="group">
       <td><code>https://example.com/?a=x&amp;&amp;&amp;&amp;</code> 
       <td rowspan="2">Parsing splits on <code>&amp;</code> and discards empty strings 
      <tr>
       <td><code>https://example.com/?a=x</code> 
      <tr class="group">
       <td><code>https://example.com/?a=</code> 
       <td rowspan="2">Both parse as having an empty string value for <code>a</code> 
      <tr>
       <td><code>https://example.com/?a</code> 
      <tr class="group">
       <td><code>https://example.com/?a=%20</code> 
       <td rowspan="3"><code>+</code> and <code>%20</code> are both parsed as U+0020 SPACE 
      <tr>
       <td><code>https://example.com/?a=+</code> 
      <tr>
       <td><code>https://example.com/?a= &amp;</code> 
    </table>
   </div>
   <h2 class="heading settled" data-level="6" id="security-considerations"><span class="secno">6. </span><span class="content">Security considerations</span><a class="self-link" href="#security-considerations"></a></h2>
    The main risk to be aware of is the impact of mismatched URLs. In particular, this could cause the user to see a response that was originally fetched from a URL different from the one displayed when they hovered a link, or the URL displayed in the URL bar. 
   <p>However, since the impact is limited to query parameters, this does not cross the relevant security boundary, which is the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin">origin</a>. (Or perhaps just the <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-host" id="ref-for-concept-url-host①">host</a>, from <a href="https://url.spec.whatwg.org/#url-rendering-simplification">the perspective of security UI</a>.) Indeed, we have already given origins complete control over how they present the (URL, reponse body) pair, including on the client side via technology such as <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/nav-history-apis.html#dom-history-replacestate" id="ref-for-dom-history-replacestate">history.replaceState()</a></code> or service workers.</p>
   <h2 class="heading settled" data-level="7" id="privacy-considerations"><span class="secno">7. </span><span class="content">Privacy considerations</span><a class="self-link" href="#privacy-considerations"></a></h2>
   <p>This proposal is adjacent to the highly-privacy-relevant space of <a href="https://privacycg.github.io/nav-tracking-mitigations/#terminology">navigational tracking</a>, which often uses query parameters to pass along user identifiers. However, we believe this proposal itself does not have privacy impacts. It does not interfere with <a href="https://privacycg.github.io/nav-tracking-mitigations/#deployed-mitigations">existing navigational tracking mitigations</a>, or any known future ones being contemplated. Indeed, if a page were to encode user identifiers in its URL, the only ability this proposal gives is to <em>reduce</em> such user tracking by preventing server processing of such user IDs (since the server is bypassed in favor of the cache).</p>
  </main>
  <script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script>
  <h2 class="no-num no-ref heading settled" id="index"><span class="content">Index</span><a class="self-link" href="#index"></a></h2>
  <h3 class="no-num no-ref heading settled" id="index-defined-here"><span class="content">Terms defined by this specification</span><a class="self-link" href="#index-defined-here"></a></h3>
  <ul class="index">
   <li><a href="#default-url-search-variance">default URL search variance</a><span>, in § 3</span>
   <li><a href="#equivalent-modulo-search-variance">equivalent modulo search variance</a><span>, in § 5</span>
   <li><a href="#url-search-variance-no-vary-params">no-vary params</a><span>, in § 3</span>
   <li><a href="#http-headerdef-no-vary-search">No-Vary-Search</a><span>, in § 2</span>
   <li><a href="#obtain-a-url-search-variance">obtain a URL search variance</a><span>, in § 4</span>
   <li><a href="#obtain-a-url-search-variance-hint">obtain a URL search variance hint</a><span>, in § 4</span>
   <li><a href="#parse-a-key">parse a key</a><span>, in § 4</span>
   <li><a href="#parse-a-url-search-variance">parse a URL search variance</a><span>, in § 4</span>
   <li><a href="#url-search-variance">URL search variance</a><span>, in § 3</span>
   <li><a href="#url-search-variance-vary-on-key-order">vary on key order</a><span>, in § 3</span>
   <li><a href="#url-search-variance-vary-params">vary params</a><span>, in § 3</span>
   <li>
    wildcard
    <ul>
     <li><a href="#url-search-variance-no-vary-params-wildcard">dfn for URL search variance/no-vary params</a><span>, in § 3</span>
     <li><a href="#url-search-variance-vary-params-wildcard">dfn for URL search variance/vary params</a><span>, in § 3</span>
    </ul>
  </ul>
  <h3 class="no-num no-ref heading settled" id="index-defined-elsewhere"><span class="content">Terms defined by reference</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
  <ul class="index">
   <li>
    <a data-link-type="biblio">[ENCODING]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="a3033be5">utf-8 decode without bom</span>
    </ul>
   <li>
    <a data-link-type="biblio">[FETCH]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="5c66de35">get a structured field value</span>
     <li><span class="dfn-paneled" id="f7b00a8b">header list</span>
     <li><span class="dfn-paneled" id="ee7bba09">response</span>
    </ul>
   <li>
    <a data-link-type="biblio">[HTML]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="086e3aff">origin</span>
     <li><span class="dfn-paneled" id="66fd1e11">replaceState(data, unused, url)</span>
    </ul>
   <li>
    <a data-link-type="biblio">[INFRA]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="2d5a2765">ascii string</span>
     <li><span class="dfn-paneled" id="36858240">boolean</span>
     <li><span class="dfn-paneled" id="4135591f">code unit less than</span>
     <li><span class="dfn-paneled" id="ae8def21">contain</span>
     <li><span class="dfn-paneled" id="1243a891">exist</span>
     <li><span class="dfn-paneled" id="16b1470a">isomorphic encode</span>
     <li><span class="dfn-paneled" id="5afbefcd">item <small>(for list)</small></span>
     <li><span class="dfn-paneled" id="c88f3887">item <small>(for struct)</small></span>
     <li><span class="dfn-paneled" id="31db57e6">keys</span>
     <li><span class="dfn-paneled" id="649608b9">list</span>
     <li><span class="dfn-paneled" id="3fca5a9e">map</span>
     <li><span class="dfn-paneled" id="0204d188">size</span>
     <li><span class="dfn-paneled" id="bccbabba">sorting in ascending order</span>
     <li><span class="dfn-paneled" id="0698d556">string</span>
     <li><span class="dfn-paneled" id="984221ca">struct</span>
     <li><span class="dfn-paneled" id="cbdc89b4">while</span>
    </ul>
   <li>
    <a data-link-type="biblio">[RFC8941]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="d65c1d68">boolean</span>
     <li><span class="dfn-paneled" id="d71d1eda">dictionary</span>
     <li><span class="dfn-paneled" id="2892a577">inner list</span>
     <li><span class="dfn-paneled" id="a44bca31">parsing structured fields</span>
     <li><span class="dfn-paneled" id="928a0e65">structured header</span>
    </ul>
   <li>
    <a data-link-type="biblio">[URL]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="36265cc4">application/x-www-form-urlencoded</span>
     <li><span class="dfn-paneled" id="b85ee3be">host</span>
     <li><span class="dfn-paneled" id="a1288f2a">password</span>
     <li><span class="dfn-paneled" id="c0868016">path</span>
     <li><span class="dfn-paneled" id="5abf08c8">percent-decode</span>
     <li><span class="dfn-paneled" id="852ada56">port</span>
     <li><span class="dfn-paneled" id="3ab2ec8b">query</span>
     <li><span class="dfn-paneled" id="3a711be7">scheme</span>
     <li><span class="dfn-paneled" id="dcffbccd">url</span>
     <li><span class="dfn-paneled" id="10d9e2a0">urlencoded parser</span>
     <li><span class="dfn-paneled" id="218c9455">username</span>
    </ul>
  </ul>
  <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="no-num no-ref heading settled" id="normative"><span class="content">Normative References</span><a class="self-link" href="#normative"></a></h3>
  <dl>
   <dt id="biblio-encoding">[ENCODING]
   <dd>Anne van Kesteren. <a href="https://encoding.spec.whatwg.org/"><cite>Encoding Standard</cite></a>. Living Standard. URL: <a href="https://encoding.spec.whatwg.org/">https://encoding.spec.whatwg.org/</a>
   <dt id="biblio-fetch">[FETCH]
   <dd>Anne van Kesteren. <a href="https://fetch.spec.whatwg.org/"><cite>Fetch Standard</cite></a>. Living Standard. URL: <a href="https://fetch.spec.whatwg.org/">https://fetch.spec.whatwg.org/</a>
   <dt id="biblio-html">[HTML]
   <dd>Anne van Kesteren; et al. <a href="https://html.spec.whatwg.org/multipage/"><cite>HTML Standard</cite></a>. Living Standard. URL: <a href="https://html.spec.whatwg.org/multipage/">https://html.spec.whatwg.org/multipage/</a>
   <dt id="biblio-infra">[INFRA]
   <dd>Anne van Kesteren; Domenic Denicola. <a href="https://infra.spec.whatwg.org/"><cite>Infra Standard</cite></a>. Living Standard. URL: <a href="https://infra.spec.whatwg.org/">https://infra.spec.whatwg.org/</a>
   <dt id="biblio-nav-tracking-mitigations">[NAV-TRACKING-MITIGATIONS]
   <dd><a href="https://privacycg.github.io/nav-tracking-mitigations/"><cite>Navigational-Tracking Mitigations</cite></a>. Editor's Draft. URL: <a href="https://privacycg.github.io/nav-tracking-mitigations/">https://privacycg.github.io/nav-tracking-mitigations/</a>
   <dt id="biblio-rfc8941">[RFC8941]
   <dd>M. Nottingham; P-H. Kamp. <a href="https://httpwg.org/specs/rfc8941.html"><cite>Structured Field Values for HTTP</cite></a>. February 2021. Proposed Standard. URL: <a href="https://httpwg.org/specs/rfc8941.html">https://httpwg.org/specs/rfc8941.html</a>
   <dt id="biblio-url">[URL]
   <dd>Anne van Kesteren. <a href="https://url.spec.whatwg.org/"><cite>URL Standard</cite></a>. Living Standard. URL: <a href="https://url.spec.whatwg.org/">https://url.spec.whatwg.org/</a>
  </dl>
  <h3 class="no-num no-ref heading settled" id="informative"><span class="content">Informative References</span><a class="self-link" href="#informative"></a></h3>
  <dl>
   <dt id="biblio-rfc9111">[RFC9111]
   <dd>R. Fielding, Ed.; M. Nottingham, Ed.; J. Reschke, Ed.. <a href="https://httpwg.org/specs/rfc9111.html"><cite>HTTP Caching</cite></a>. June 2022. Internet Standard. URL: <a href="https://httpwg.org/specs/rfc9111.html">https://httpwg.org/specs/rfc9111.html</a>
  </dl>
<script>/* Boilerplate: script-dom-helper */
"use strict";
function query(sel) { return document.querySelector(sel); }

function queryAll(sel) { return [...document.querySelectorAll(sel)]; }

function iter(obj) {
	if(!obj) return [];
	var it = obj[Symbol.iterator];
	if(it) return it;
	return Object.entries(obj);
}

function mk(tagname, attrs, ...children) {
	const el = document.createElement(tagname);
	for(const [k,v] of iter(attrs)) {
		if(k.slice(0,3) == "_on") {
			const eventName = k.slice(3);
			el.addEventListener(eventName, v);
		} else if(k[0] == "_") {
			// property, not attribute
			el[k.slice(1)] = v;
		} else {
			if(v === false || v == null) {
        continue;
      } else if(v === true) {
        el.setAttribute(k, "");
        continue;
      } else {
  			el.setAttribute(k, v);
      }
		}
	}
	append(el, children);
	return el;
}

/* Create shortcuts for every known HTML element */
[
  "a",
  "abbr",
  "acronym",
  "address",
  "applet",
  "area",
  "article",
  "aside",
  "audio",
  "b",
  "base",
  "basefont",
  "bdo",
  "big",
  "blockquote",
  "body",
  "br",
  "button",
  "canvas",
  "caption",
  "center",
  "cite",
  "code",
  "col",
  "colgroup",
  "datalist",
  "dd",
  "del",
  "details",
  "dfn",
  "dialog",
  "div",
  "dl",
  "dt",
  "em",
  "embed",
  "fieldset",
  "figcaption",
  "figure",
  "font",
  "footer",
  "form",
  "frame",
  "frameset",
  "head",
  "header",
  "h1",
  "h2",
  "h3",
  "h4",
  "h5",
  "h6",
  "hr",
  "html",
  "i",
  "iframe",
  "img",
  "input",
  "ins",
  "kbd",
  "label",
  "legend",
  "li",
  "link",
  "main",
  "map",
  "mark",
  "meta",
  "meter",
  "nav",
  "nobr",
  "noscript",
  "object",
  "ol",
  "optgroup",
  "option",
  "output",
  "p",
  "param",
  "pre",
  "progress",
  "q",
  "s",
  "samp",
  "script",
  "section",
  "select",
  "small",
  "source",
  "span",
  "strike",
  "strong",
  "style",
  "sub",
  "summary",
  "sup",
  "table",
  "tbody",
  "td",
  "template",
  "textarea",
  "tfoot",
  "th",
  "thead",
  "time",
  "title",
  "tr",
  "u",
  "ul",
  "var",
  "video",
  "wbr",
  "xmp",
].forEach(tagname=>{
	mk[tagname] = (...args) => mk(tagname, ...args);
});

function* nodesFromChildList(children) {
	for(const child of children.flat(Infinity)) {
		if(child instanceof Node) {
			yield child;
		} else {
			yield new Text(child);
		}
	}
}
function append(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		if(el instanceof Node) el.appendChild(child);
		else el.push(child);
	}
	return el;
}

function insertAfter(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		el.parentNode.insertBefore(child, el.nextSibling);
	}
	return el;
}

function clearContents(el) {
	el.innerHTML = "";
	return el;
}

function parseHTML(markup) {
	if(markup.toLowerCase().trim().indexOf('<!doctype') === 0) {
		const doc = document.implementation.createHTMLDocument("");
		doc.documentElement.innerHTML = markup;
		return doc;
	} else {
		const el = mk.template({});
		el.innerHTML = markup;
		return el.content;
	}
}</script>
<script>/* Boilerplate: script-dfn-panel */
"use strict";
{
let dfnPanelData = {
"0204d188": {"dfnID":"0204d188","dfnText":"size","external":true,"refSections":[{"refs":[{"id":"ref-for-list-size"},{"id":"ref-for-list-size\u2460"},{"id":"ref-for-list-size\u2461"}],"title":"5. Comparing"}],"url":"https://infra.spec.whatwg.org/#list-size"},
"0698d556": {"dfnID":"0698d556","dfnText":"string","external":true,"refSections":[{"refs":[{"id":"ref-for-string"},{"id":"ref-for-string\u2460"}],"title":"3. Data model"},{"refs":[{"id":"ref-for-string\u2461"},{"id":"ref-for-string\u2462"},{"id":"ref-for-string\u2463"}],"title":"4. Parsing"}],"url":"https://infra.spec.whatwg.org/#string"},
"086e3aff": {"dfnID":"086e3aff","dfnText":"origin","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-origin"}],"title":"6. Security considerations"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin"},
"10d9e2a0": {"dfnID":"10d9e2a0","dfnText":"urlencoded parser","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-urlencoded-parser"}],"title":"4. Parsing"},{"refs":[{"id":"ref-for-concept-urlencoded-parser\u2460"},{"id":"ref-for-concept-urlencoded-parser\u2461"},{"id":"ref-for-concept-urlencoded-parser\u2462"},{"id":"ref-for-concept-urlencoded-parser\u2463"}],"title":"5. Comparing"}],"url":"https://url.spec.whatwg.org/#concept-urlencoded-parser"},
"1243a891": {"dfnID":"1243a891","dfnText":"exist","external":true,"refSections":[{"refs":[{"id":"ref-for-map-exists"},{"id":"ref-for-map-exists\u2460"},{"id":"ref-for-map-exists\u2461"}],"title":"4. Parsing"}],"url":"https://infra.spec.whatwg.org/#map-exists"},
"16b1470a": {"dfnID":"16b1470a","dfnText":"isomorphic encode","external":true,"refSections":[{"refs":[{"id":"ref-for-isomorphic-encode"}],"title":"4. Parsing"},{"refs":[{"id":"ref-for-isomorphic-encode\u2460"},{"id":"ref-for-isomorphic-encode\u2461"}],"title":"5. Comparing"}],"url":"https://infra.spec.whatwg.org/#isomorphic-encode"},
"218c9455": {"dfnID":"218c9455","dfnText":"username","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-url-username"}],"title":"5. Comparing"}],"url":"https://url.spec.whatwg.org/#concept-url-username"},
"2892a577": {"dfnID":"2892a577","dfnText":"inner list","external":true,"refSections":[{"refs":[{"id":"ref-for-name-inner-lists"},{"id":"ref-for-name-inner-lists\u2460"}],"title":"2. HTTP header field definition"}],"url":"https://www.rfc-editor.org/rfc/rfc8941.html#name-inner-lists"},
"2d5a2765": {"dfnID":"2d5a2765","dfnText":"ascii string","external":true,"refSections":[{"refs":[{"id":"ref-for-ascii-string"}],"title":"4. Parsing"}],"url":"https://infra.spec.whatwg.org/#ascii-string"},
"31db57e6": {"dfnID":"31db57e6","dfnText":"keys","external":true,"refSections":[{"refs":[{"id":"ref-for-map-getting-the-keys"}],"title":"4. Parsing"}],"url":"https://infra.spec.whatwg.org/#map-getting-the-keys"},
"36265cc4": {"dfnID":"36265cc4","dfnText":"application/x-www-form-urlencoded","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-urlencoded"}],"title":"4. Parsing"}],"url":"https://url.spec.whatwg.org/#concept-urlencoded"},
"36858240": {"dfnID":"36858240","dfnText":"boolean","external":true,"refSections":[{"refs":[{"id":"ref-for-boolean"}],"title":"3. Data model"},{"refs":[{"id":"ref-for-boolean\u2460"},{"id":"ref-for-boolean\u2461"}],"title":"4. Parsing"}],"url":"https://infra.spec.whatwg.org/#boolean"},
"3a711be7": {"dfnID":"3a711be7","dfnText":"scheme","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-url-scheme"}],"title":"5. Comparing"}],"url":"https://url.spec.whatwg.org/#concept-url-scheme"},
"3ab2ec8b": {"dfnID":"3ab2ec8b","dfnText":"query","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-url-query"},{"id":"ref-for-concept-url-query\u2460"},{"id":"ref-for-concept-url-query\u2461"},{"id":"ref-for-concept-url-query\u2462"},{"id":"ref-for-concept-url-query\u2463"},{"id":"ref-for-concept-url-query\u2464"},{"id":"ref-for-concept-url-query\u2465"},{"id":"ref-for-concept-url-query\u2466"}],"title":"5. Comparing"}],"url":"https://url.spec.whatwg.org/#concept-url-query"},
"3fca5a9e": {"dfnID":"3fca5a9e","dfnText":"map","external":true,"refSections":[{"refs":[{"id":"ref-for-ordered-map"}],"title":"4. Parsing"}],"url":"https://infra.spec.whatwg.org/#ordered-map"},
"4135591f": {"dfnID":"4135591f","dfnText":"code unit less than","external":true,"refSections":[{"refs":[{"id":"ref-for-code-unit-less-than"}],"title":"5. Comparing"}],"url":"https://infra.spec.whatwg.org/#code-unit-less-than"},
"5abf08c8": {"dfnID":"5abf08c8","dfnText":"percent-decode","external":true,"refSections":[{"refs":[{"id":"ref-for-percent-decode"}],"title":"4. Parsing"}],"url":"https://url.spec.whatwg.org/#percent-decode"},
"5afbefcd": {"dfnID":"5afbefcd","dfnText":"item (for list)","external":true,"refSections":[{"refs":[{"id":"ref-for-list-item"},{"id":"ref-for-list-item\u2460"},{"id":"ref-for-list-item\u2461"},{"id":"ref-for-list-item\u2462"}],"title":"4. Parsing"},{"refs":[{"id":"ref-for-list-item\u2463"},{"id":"ref-for-list-item\u2464"},{"id":"ref-for-list-item\u2465"},{"id":"ref-for-list-item\u2466"}],"title":"5. Comparing"}],"url":"https://infra.spec.whatwg.org/#list-item"},
"5c66de35": {"dfnID":"5c66de35","dfnText":"get a structured field value","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-header-list-get-structured-header"}],"title":"4. Parsing"}],"url":"https://fetch.spec.whatwg.org/#concept-header-list-get-structured-header"},
"649608b9": {"dfnID":"649608b9","dfnText":"list","external":true,"refSections":[{"refs":[{"id":"ref-for-list"},{"id":"ref-for-list\u2460"},{"id":"ref-for-list\u2461"},{"id":"ref-for-list\u2462"}],"title":"3. Data model"},{"refs":[{"id":"ref-for-list\u2463"},{"id":"ref-for-list\u2464"}],"title":"4. Parsing"},{"refs":[{"id":"ref-for-list\u2465"},{"id":"ref-for-list\u2466"},{"id":"ref-for-list\u2467"},{"id":"ref-for-list\u2468"},{"id":"ref-for-list\u2460\u24ea"},{"id":"ref-for-list\u2460\u2460"},{"id":"ref-for-list\u2460\u2461"}],"title":"5. Comparing"}],"url":"https://infra.spec.whatwg.org/#list"},
"66fd1e11": {"dfnID":"66fd1e11","dfnText":"replaceState(data, unused, url)","external":true,"refSections":[{"refs":[{"id":"ref-for-dom-history-replacestate"}],"title":"6. Security considerations"}],"url":"https://html.spec.whatwg.org/multipage/nav-history-apis.html#dom-history-replacestate"},
"852ada56": {"dfnID":"852ada56","dfnText":"port","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-url-port"}],"title":"5. Comparing"}],"url":"https://url.spec.whatwg.org/#concept-url-port"},
"928a0e65": {"dfnID":"928a0e65","dfnText":"structured header","external":true,"refSections":[{"refs":[{"id":"ref-for-section-1"}],"title":"2. HTTP header field definition"}],"url":"https://www.rfc-editor.org/rfc/rfc8941.html#section-1"},
"984221ca": {"dfnID":"984221ca","dfnText":"struct","external":true,"refSections":[{"refs":[{"id":"ref-for-struct"}],"title":"3. Data model"}],"url":"https://infra.spec.whatwg.org/#struct"},
"a1288f2a": {"dfnID":"a1288f2a","dfnText":"password","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-url-password"}],"title":"5. Comparing"}],"url":"https://url.spec.whatwg.org/#concept-url-password"},
"a3033be5": {"dfnID":"a3033be5","dfnText":"utf-8 decode without bom","external":true,"refSections":[{"refs":[{"id":"ref-for-utf-8-decode-without-bom"}],"title":"4. Parsing"}],"url":"https://encoding.spec.whatwg.org/#utf-8-decode-without-bom"},
"a44bca31": {"dfnID":"a44bca31","dfnText":"parsing structured fields","external":true,"refSections":[{"refs":[{"id":"ref-for-text-parse"}],"title":"4. Parsing"}],"url":"https://www.rfc-editor.org/rfc/rfc8941.html#text-parse"},
"ae8def21": {"dfnID":"ae8def21","dfnText":"contain","external":true,"refSections":[{"refs":[{"id":"ref-for-list-contain"}],"title":"4. Parsing"},{"refs":[{"id":"ref-for-list-contain\u2460"},{"id":"ref-for-list-contain\u2461"},{"id":"ref-for-list-contain\u2462"},{"id":"ref-for-list-contain\u2463"}],"title":"5. Comparing"}],"url":"https://infra.spec.whatwg.org/#list-contain"},
"b85ee3be": {"dfnID":"b85ee3be","dfnText":"host","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-url-host"}],"title":"5. Comparing"},{"refs":[{"id":"ref-for-concept-url-host\u2460"}],"title":"6. Security considerations"}],"url":"https://url.spec.whatwg.org/#concept-url-host"},
"bccbabba": {"dfnID":"bccbabba","dfnText":"sorting in ascending order","external":true,"refSections":[{"refs":[{"id":"ref-for-list-sort-in-ascending-order"},{"id":"ref-for-list-sort-in-ascending-order\u2460"}],"title":"5. Comparing"}],"url":"https://infra.spec.whatwg.org/#list-sort-in-ascending-order"},
"c0868016": {"dfnID":"c0868016","dfnText":"path","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-url-path"}],"title":"5. Comparing"}],"url":"https://url.spec.whatwg.org/#concept-url-path"},
"c88f3887": {"dfnID":"c88f3887","dfnText":"item (for struct)","external":true,"refSections":[{"refs":[{"id":"ref-for-struct-item"}],"title":"3. Data model"}],"url":"https://infra.spec.whatwg.org/#struct-item"},
"cbdc89b4": {"dfnID":"cbdc89b4","dfnText":"while","external":true,"refSections":[{"refs":[{"id":"ref-for-iteration-while"}],"title":"5. Comparing"}],"url":"https://infra.spec.whatwg.org/#iteration-while"},
"d65c1d68": {"dfnID":"d65c1d68","dfnText":"boolean","external":true,"refSections":[{"refs":[{"id":"ref-for-name-boolean"},{"id":"ref-for-name-boolean\u2460"}],"title":"2. HTTP header field definition"}],"url":"https://www.rfc-editor.org/rfc/rfc8941.html#name-boolean"},
"d71d1eda": {"dfnID":"d71d1eda","dfnText":"dictionary","external":true,"refSections":[{"refs":[{"id":"ref-for-name-dictionaries"}],"title":"2. HTTP header field definition"}],"url":"https://www.rfc-editor.org/rfc/rfc8941.html#name-dictionaries"},
"dcffbccd": {"dfnID":"dcffbccd","dfnText":"url","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-url"},{"id":"ref-for-concept-url\u2460"}],"title":"5. Comparing"}],"url":"https://url.spec.whatwg.org/#concept-url"},
"default-url-search-variance": {"dfnID":"default-url-search-variance","dfnText":"default URL search variance","external":false,"refSections":[{"refs":[{"id":"ref-for-default-url-search-variance"},{"id":"ref-for-default-url-search-variance\u2460"},{"id":"ref-for-default-url-search-variance\u2461"},{"id":"ref-for-default-url-search-variance\u2462"},{"id":"ref-for-default-url-search-variance\u2463"},{"id":"ref-for-default-url-search-variance\u2464"},{"id":"ref-for-default-url-search-variance\u2465"},{"id":"ref-for-default-url-search-variance\u2466"},{"id":"ref-for-default-url-search-variance\u2467"},{"id":"ref-for-default-url-search-variance\u2468"},{"id":"ref-for-default-url-search-variance\u2460\u24ea"},{"id":"ref-for-default-url-search-variance\u2460\u2460"}],"title":"4. Parsing"},{"refs":[{"id":"ref-for-default-url-search-variance\u2460\u2461"}],"title":"5. Comparing"}],"url":"#default-url-search-variance"},
"ee7bba09": {"dfnID":"ee7bba09","dfnText":"response","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-response"}],"title":"4. Parsing"}],"url":"https://fetch.spec.whatwg.org/#concept-response"},
"equivalent-modulo-search-variance": {"dfnID":"equivalent-modulo-search-variance","dfnText":"equivalent modulo search variance","external":false,"refSections":[{"refs":[{"id":"ref-for-equivalent-modulo-search-variance"}],"title":"4. Parsing"}],"url":"#equivalent-modulo-search-variance"},
"f7b00a8b": {"dfnID":"f7b00a8b","dfnText":"header list","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-response-header-list"}],"title":"4. Parsing"}],"url":"https://fetch.spec.whatwg.org/#concept-response-header-list"},
"http-headerdef-no-vary-search": {"dfnID":"http-headerdef-no-vary-search","dfnText":"No-Vary-Search","external":false,"refSections":[{"refs":[{"id":"ref-for-http-headerdef-no-vary-search"}],"title":"4. Parsing"}],"url":"#http-headerdef-no-vary-search"},
"obtain-a-url-search-variance": {"dfnID":"obtain-a-url-search-variance","dfnText":"obtain a URL search variance","external":false,"refSections":[{"refs":[{"id":"ref-for-obtain-a-url-search-variance"}],"title":"2. HTTP header field definition"},{"refs":[{"id":"ref-for-obtain-a-url-search-variance\u2460"}],"title":"3. Data model"}],"url":"#obtain-a-url-search-variance"},
"obtain-a-url-search-variance-hint": {"dfnID":"obtain-a-url-search-variance-hint","dfnText":"obtain a URL search variance hint","external":false,"refSections":[],"url":"#obtain-a-url-search-variance-hint"},
"parse-a-key": {"dfnID":"parse-a-key","dfnText":"parse a key","external":false,"refSections":[{"refs":[{"id":"ref-for-parse-a-key"},{"id":"ref-for-parse-a-key\u2460"},{"id":"ref-for-parse-a-key\u2461"}],"title":"4. Parsing"}],"url":"#parse-a-key"},
"parse-a-url-search-variance": {"dfnID":"parse-a-url-search-variance","dfnText":"parse a URL search variance","external":false,"refSections":[{"refs":[{"id":"ref-for-parse-a-url-search-variance"},{"id":"ref-for-parse-a-url-search-variance\u2460"}],"title":"4. Parsing"}],"url":"#parse-a-url-search-variance"},
"url-search-variance": {"dfnID":"url-search-variance","dfnText":"URL search variance","external":false,"refSections":[{"refs":[{"id":"ref-for-url-search-variance"},{"id":"ref-for-url-search-variance\u2460"}],"title":"3. Data model"},{"refs":[{"id":"ref-for-url-search-variance\u2461"},{"id":"ref-for-url-search-variance\u2462"}],"title":"4. Parsing"},{"refs":[{"id":"ref-for-url-search-variance\u2463"}],"title":"5. Comparing"}],"url":"#url-search-variance"},
"url-search-variance-no-vary-params": {"dfnID":"url-search-variance-no-vary-params","dfnText":"no-vary params","external":false,"refSections":[{"refs":[{"id":"ref-for-url-search-variance-no-vary-params"},{"id":"ref-for-url-search-variance-no-vary-params\u2460"},{"id":"ref-for-url-search-variance-no-vary-params\u2461"}],"title":"3. Data model"},{"refs":[{"id":"ref-for-url-search-variance-no-vary-params\u2462"},{"id":"ref-for-url-search-variance-no-vary-params\u2463"},{"id":"ref-for-url-search-variance-no-vary-params\u2464"},{"id":"ref-for-url-search-variance-no-vary-params\u2465"},{"id":"ref-for-url-search-variance-no-vary-params\u2466"},{"id":"ref-for-url-search-variance-no-vary-params\u2467"},{"id":"ref-for-url-search-variance-no-vary-params\u2468"}],"title":"4. Parsing"},{"refs":[{"id":"ref-for-url-search-variance-no-vary-params\u2460\u24ea"},{"id":"ref-for-url-search-variance-no-vary-params\u2460\u2460"},{"id":"ref-for-url-search-variance-no-vary-params\u2460\u2461"}],"title":"5. Comparing"}],"url":"#url-search-variance-no-vary-params"},
"url-search-variance-no-vary-params-wildcard": {"dfnID":"url-search-variance-no-vary-params-wildcard","dfnText":"wildcard","external":false,"refSections":[{"refs":[{"id":"ref-for-url-search-variance-no-vary-params-wildcard"}],"title":"3. Data model"},{"refs":[{"id":"ref-for-url-search-variance-no-vary-params-wildcard\u2460"},{"id":"ref-for-url-search-variance-no-vary-params-wildcard\u2461"},{"id":"ref-for-url-search-variance-no-vary-params-wildcard\u2462"},{"id":"ref-for-url-search-variance-no-vary-params-wildcard\u2463"},{"id":"ref-for-url-search-variance-no-vary-params-wildcard\u2464"}],"title":"4. Parsing"}],"url":"#url-search-variance-no-vary-params-wildcard"},
"url-search-variance-vary-on-key-order": {"dfnID":"url-search-variance-vary-on-key-order","dfnText":"vary on key order","external":false,"refSections":[{"refs":[{"id":"ref-for-url-search-variance-vary-on-key-order"}],"title":"3. Data model"},{"refs":[{"id":"ref-for-url-search-variance-vary-on-key-order\u2460"},{"id":"ref-for-url-search-variance-vary-on-key-order\u2461"}],"title":"4. Parsing"},{"refs":[{"id":"ref-for-url-search-variance-vary-on-key-order\u2462"}],"title":"5. Comparing"}],"url":"#url-search-variance-vary-on-key-order"},
"url-search-variance-vary-params": {"dfnID":"url-search-variance-vary-params","dfnText":"vary params","external":false,"refSections":[{"refs":[{"id":"ref-for-url-search-variance-vary-params"},{"id":"ref-for-url-search-variance-vary-params\u2460"},{"id":"ref-for-url-search-variance-vary-params\u2461"}],"title":"3. Data model"},{"refs":[{"id":"ref-for-url-search-variance-vary-params\u2462"},{"id":"ref-for-url-search-variance-vary-params\u2463"},{"id":"ref-for-url-search-variance-vary-params\u2464"},{"id":"ref-for-url-search-variance-vary-params\u2465"},{"id":"ref-for-url-search-variance-vary-params\u2466"},{"id":"ref-for-url-search-variance-vary-params\u2467"},{"id":"ref-for-url-search-variance-vary-params\u2468"},{"id":"ref-for-url-search-variance-vary-params\u2460\u24ea"},{"id":"ref-for-url-search-variance-vary-params\u2460\u2460"}],"title":"4. Parsing"},{"refs":[{"id":"ref-for-url-search-variance-vary-params\u2460\u2461"},{"id":"ref-for-url-search-variance-vary-params\u2460\u2462"},{"id":"ref-for-url-search-variance-vary-params\u2460\u2463"}],"title":"5. Comparing"}],"url":"#url-search-variance-vary-params"},
"url-search-variance-vary-params-wildcard": {"dfnID":"url-search-variance-vary-params-wildcard","dfnText":"wildcard","external":false,"refSections":[{"refs":[{"id":"ref-for-url-search-variance-vary-params-wildcard"},{"id":"ref-for-url-search-variance-vary-params-wildcard\u2460"}],"title":"3. Data model"},{"refs":[{"id":"ref-for-url-search-variance-vary-params-wildcard\u2461"}],"title":"4. Parsing"}],"url":"#url-search-variance-vary-params-wildcard"},
};

document.addEventListener("DOMContentLoaded", ()=>{
    genAllDfnPanels();

    document.body.addEventListener("click", (e) => {
        // If not handled already, just hide all dfn panels.
        hideAllDfnPanels();
    });
});

window.addEventListener("resize", () => {
    // Pin any visible dfn panel
    queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el=>positionDfnPanel(el));
});

function genAllDfnPanels() {
    for(const panelData of Object.values(dfnPanelData)) {
        const dfnID = panelData.dfnID;
        const dfn = document.getElementById(dfnID);
        if(!dfn) {
            console.log(`Can't find dfn#${dfnID}.`, panelData);
            continue;
        }
        dfn.panelData = panelData;
        insertDfnPopupAction(dfn);
    }
}

function genDfnPanel(dfn, { dfnID, url, dfnText, refSections, external }) {
    const dfnPanel = mk.aside({
        class: "dfn-panel on",
        id: `infopanel-for-${dfnID}`,
        "data-for": dfnID,
        "aria-labelled-by":`infopaneltitle-for-${dfnID}`,
        },
        mk.span({id:`infopaneltitle-for-${dfnID}`, style:"display:none"},
            `Info about the '${dfnText}' ${external?"external":""} reference.`),
        mk.a({href:url, class:"dfn-link"}, url),
        refSections.length == 0 ? [] :
            mk.b({}, "Referenced in:"),
            mk.ul({},
                ...refSections.map(section=>
                    mk.li({},
                        ...section.refs.map((ref, refI)=>
                            [
                                mk.a({ href: `#${ref.id}` },
                                    (refI == 0) ? section.title : `(${refI + 1})`
                                ),
                                " ",
                            ]
                        ),
                    ),
                ),
            ),
        genLinkingSyntaxes(dfn),
    );

    dfnPanel.addEventListener('click', (event) => {
        if (event.target.nodeName == 'A') {
            scrollToTargetAndHighlight(event);
            pinDfnPanel(dfnPanel);
        }
        event.stopPropagation();
        refocusOnTarget(event);
    });
    dfnPanel.addEventListener('keydown', (event) => {
        if(event.keyCode == 27) { // Escape key
            hideDfnPanel({dfnPanel});
            event.stopPropagation();
            event.preventDefault();
        }
    });

    dfnPanel.dfn = dfn;
    dfn.dfnPanel = dfnPanel;
    return dfnPanel;
}



function hideAllDfnPanels() {
    // Delete the currently-active dfn panel.
    queryAll(".dfn-panel").forEach(dfnPanel=>hideDfnPanel({dfnPanel}));
}

function showDfnPanel(dfn) {
    hideAllDfnPanels(); // Only display one at a time.

    dfn.setAttribute("aria-expanded", "true");

    const dfnPanel = genDfnPanel(dfn, dfn.panelData);

    // Give the dfn a unique tabindex, and then
    // give all the tabbable panel bits successive indexes.
    let tabIndex = 100;
    dfn.tabIndex = tabIndex++;
    const tabbable = dfnPanel.querySelectorAll(":is(a, button)");
    for (const el of tabbable) {
        el.tabIndex = tabIndex++;
    }

    append(document.body, dfnPanel);
    positionDfnPanel(dfnPanel);
}

function positionDfnPanel(dfnPanel) {
    const dfn = dfnPanel.dfn;
    const dfnPos = getBounds(dfn);
    dfnPanel.style.top = dfnPos.bottom + "px";
    dfnPanel.style.left = dfnPos.left + "px";

    const panelPos = dfnPanel.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, dfnPos.left - overflowAmount);
        dfnPanel.style.left = newLeft + "px";
    }
}

function pinDfnPanel(dfnPanel) {
    // Switch it to "activated" state, which pins it.
    dfnPanel.classList.add("activated");
    dfnPanel.style.position = "fixed";
    dfnPanel.style.left = null;
    dfnPanel.style.top = null;
}

function hideDfnPanel({dfn, dfnPanel}) {
    if(!dfnPanel) dfnPanel = dfn.dfnPanel;
    if(!dfn) dfn = dfnPanel.dfn;
    dfn.dfnPanel = undefined;
    dfnPanel.dfn = undefined;
    dfn.setAttribute("aria-expanded", "false");
    dfn.tabIndex = undefined;
    dfnPanel.remove()
}

function toggleDfnPanel(dfn) {
    if(dfn.dfnPanel) {
        hideDfnPanel(dfn);
    } else {
        showDfnPanel(dfn);
    }
}

function insertDfnPopupAction(dfn) {
    dfn.setAttribute('role', 'button');
    dfn.setAttribute('aria-expanded', 'false')
    dfn.tabIndex = 0;
    dfn.classList.add('has-dfn-panel');
    dfn.addEventListener('click', (event) => {
        toggleDfnPanel(dfn);
        event.stopPropagation();
    });
    dfn.addEventListener('keypress', (event) => {
        const kc = event.keyCode;
        // 32->Space, 13->Enter
        if(kc == 32 || kc == 13) {
            toggleDfnPanel(dfn);
            event.stopPropagation();
            event.preventDefault();
        }
    });
}

function refocusOnTarget(event) {
    const target = event.target;
    setTimeout(() => {
        // Refocus on the event.target element.
        // This is needed after browser scrolls to the destination.
        target.focus();
    });
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function scrollToTargetAndHighlight(event) {
    let hash = event.target.hash;
    if (hash) {
        hash = decodeURIComponent(hash.substring(1));
        const dest = document.getElementById(hash);
        if (dest) {
            dest.classList.add('highlighted');
            setTimeout(() => dest.classList.remove('highlighted'), 1000);
        }
    }
}

// Functions, divided by link type, that wrap an autolink's
// contents with the appropriate outer syntax.
// Alternately, a string naming another type they format
// the same as.
function needsFor(type) {
    switch(type) {
        case "descriptor":
        case "value":
        case "element-attr":
        case "attr-value":
        case "element-state":
        case "method":
        case "constructor":
        case "argument":
        case "attribute":
        case "const":
        case "dict-member":
        case "event":
        case "enum-value":
        case "stringifier":
        case "serializer":
        case "iterator":
        case "maplike":
        case "setlike":
        case "state":
        case "mode":
        case "context":
        case "facet": return true;

        default: return false;
    }
}
function refusesFor(type) {
    switch(type) {
        case "property":
        case "element":
        case "interface":
        case "namespace":
        case "callback":
        case "dictionary":
        case "enum":
        case "exception":
        case "typedef":
        case "http-header":
        case "permission": return true;

        default: return false;
    }
}
function linkFormatterFromType(type) {
    switch(type) {
        case 'scheme':
        case 'permission':
        case 'dfn': return (text) => `[=${text}=]`;

        case 'abstract-op': return (text) => `[\$${text}\$]`;

        case 'function':
        case 'at-rule':
        case 'selector':
        case 'value': return (text) => `''${text}''`;

        case 'http-header': return (text) => `[:${text}:]`;

        case 'interface':
        case 'constructor':
        case 'method':
        case 'argument':
        case 'attribute':
        case 'callback':
        case 'dictionary':
        case 'dict-member':
        case 'enum':
        case 'enum-value':
        case 'exception':
        case 'const':
        case 'typedef':
        case 'stringifier':
        case 'serializer':
        case 'iterator':
        case 'maplike':
        case 'setlike':
        case 'extended-attribute':
        case 'event':
        case 'idl': return (text) => `{{${text}}}`;

        case 'element-state':
        case 'element-attr':
        case 'attr-value':
        case 'element': return (element) => `<{${element}}>`;

        case 'grammar': return (text) => `${text} (within a <pre class=prod>)`;

        case 'type': return (text)=> `<<${text}>>`;

        case 'descriptor':
        case 'property': return (text) => `'${text}'`;

        default: return;
    };
};

function genLinkingSyntaxes(dfn) {
    if(dfn.tagName != "DFN") return;

    const type = dfn.getAttribute('data-dfn-type');
    if(!type) {
        console.log(`<dfn> doesn't have a data-dfn-type:`, dfn);
        return [];
    }

    // Return a function that wraps link text based on the type
    const linkFormatter = linkFormatterFromType(type);
    if(!linkFormatter) {
        console.log(`<dfn> has an unknown data-dfn-type:`, dfn);
        return [];
    }

    let ltAlts;
    if(dfn.hasAttribute('data-lt')) {
        ltAlts = dfn.getAttribute('data-lt')
            .split("|")
            .map(x=>x.trim());
    } else {
        ltAlts = [dfn.textContent.trim()];
    }
    if(type == "type") {
        // lt of "<foo>", but "foo" is the interior;
        // <<foo/bar>> is how you write it with a for,
        // not <foo/<bar>> or whatever.
        for(var i = 0; i < ltAlts.length; i++) {
            const lt = ltAlts[i];
            const match = /<(.*)>/.exec(lt);
            if(match) { ltAlts[i] = match[1]; }
        }
    }

    let forAlts;
    if(dfn.hasAttribute('data-dfn-for')) {
        forAlts = dfn.getAttribute('data-dfn-for')
            .split(",")
            .map(x=>x.trim());
    } else {
        forAlts = [''];
    }

    let linkingSyntaxes = [];
    if(!needsFor(type)) {
        for(const lt of ltAlts) {
            linkingSyntaxes.push(linkFormatter(lt));
        }
    }
    if(!refusesFor(type)) {
        for(const f of forAlts) {
            linkingSyntaxes.push(linkFormatter(`${f}/${ltAlts[0]}`))
        }
    }
    return [
        mk.b({}, 'Possible linking syntaxes:'),
        mk.ul({},
            ...linkingSyntaxes.map(link => {
                const copyLink = async () =>
                    await navigator.clipboard.writeText(link);
                return mk.li({},
                    mk.div({ class: 'link-item' },
                        mk.button({
                            class: 'copy-icon', title: 'Copy',
                            type: 'button',
                            _onclick: copyLink,
                            tabindex: 0,
                        }, mk.span({ class: 'icon' }) ),
                        mk.span({}, link)
                    )
                );
            })
        )
    ];
}
}
</script>
<script>/* Boilerplate: script-ref-hints */
"use strict";
{
let refsData = {
"#default-url-search-variance": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"no-vary-search","spec":"no-vary-search-1","status":"local","text":"default url search variance","type":"dfn","url":"#default-url-search-variance"},
"#equivalent-modulo-search-variance": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"no-vary-search","spec":"no-vary-search-1","status":"local","text":"equivalent modulo search variance","type":"dfn","url":"#equivalent-modulo-search-variance"},
"#http-headerdef-no-vary-search": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"no-vary-search","spec":"no-vary-search-1","status":"local","text":"no-vary-search","type":"http-header","url":"#http-headerdef-no-vary-search"},
"#obtain-a-url-search-variance": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"no-vary-search","spec":"no-vary-search-1","status":"local","text":"obtain a url search variance","type":"dfn","url":"#obtain-a-url-search-variance"},
"#parse-a-key": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"no-vary-search","spec":"no-vary-search-1","status":"local","text":"parse a key","type":"dfn","url":"#parse-a-key"},
"#parse-a-url-search-variance": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"no-vary-search","spec":"no-vary-search-1","status":"local","text":"parse a url search variance","type":"dfn","url":"#parse-a-url-search-variance"},
"#url-search-variance": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"no-vary-search","spec":"no-vary-search-1","status":"local","text":"url search variance","type":"dfn","url":"#url-search-variance"},
"#url-search-variance-no-vary-params": {"export":true,"for_":["URL search variance"],"level":"1","normative":true,"shortname":"no-vary-search","spec":"no-vary-search-1","status":"local","text":"no-vary params","type":"dfn","url":"#url-search-variance-no-vary-params"},
"#url-search-variance-no-vary-params-wildcard": {"export":true,"for_":["URL search variance/no-vary params"],"level":"1","normative":true,"shortname":"no-vary-search","spec":"no-vary-search-1","status":"local","text":"wildcard","type":"dfn","url":"#url-search-variance-no-vary-params-wildcard"},
"#url-search-variance-vary-on-key-order": {"export":true,"for_":["URL search variance"],"level":"1","normative":true,"shortname":"no-vary-search","spec":"no-vary-search-1","status":"local","text":"vary on key order","type":"dfn","url":"#url-search-variance-vary-on-key-order"},
"#url-search-variance-vary-params": {"export":true,"for_":["URL search variance"],"level":"1","normative":true,"shortname":"no-vary-search","spec":"no-vary-search-1","status":"local","text":"vary params","type":"dfn","url":"#url-search-variance-vary-params"},
"#url-search-variance-vary-params-wildcard": {"export":true,"for_":["URL search variance/vary params"],"level":"1","normative":true,"shortname":"no-vary-search","spec":"no-vary-search-1","status":"local","text":"wildcard","type":"dfn","url":"#url-search-variance-vary-params-wildcard"},
"https://encoding.spec.whatwg.org/#utf-8-decode-without-bom": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"encoding","spec":"encoding","status":"current","text":"utf-8 decode without bom","type":"dfn","url":"https://encoding.spec.whatwg.org/#utf-8-decode-without-bom"},
"https://fetch.spec.whatwg.org/#concept-header-list-get-structured-header": {"export":true,"for_":["header list"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"get a structured field value","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-header-list-get-structured-header"},
"https://fetch.spec.whatwg.org/#concept-response": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"response","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-response"},
"https://fetch.spec.whatwg.org/#concept-response-header-list": {"export":true,"for_":["response"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"header list","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-response-header-list"},
"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"origin","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin"},
"https://html.spec.whatwg.org/multipage/nav-history-apis.html#dom-history-replacestate": {"export":true,"for_":["History"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"replaceState(data, unused, url)","type":"method","url":"https://html.spec.whatwg.org/multipage/nav-history-apis.html#dom-history-replacestate"},
"https://infra.spec.whatwg.org/#ascii-string": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"ascii string","type":"dfn","url":"https://infra.spec.whatwg.org/#ascii-string"},
"https://infra.spec.whatwg.org/#boolean": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"boolean","type":"dfn","url":"https://infra.spec.whatwg.org/#boolean"},
"https://infra.spec.whatwg.org/#code-unit-less-than": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"code unit less than","type":"dfn","url":"https://infra.spec.whatwg.org/#code-unit-less-than"},
"https://infra.spec.whatwg.org/#isomorphic-encode": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"isomorphic encode","type":"dfn","url":"https://infra.spec.whatwg.org/#isomorphic-encode"},
"https://infra.spec.whatwg.org/#iteration-while": {"export":true,"for_":["iteration"],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"while","type":"dfn","url":"https://infra.spec.whatwg.org/#iteration-while"},
"https://infra.spec.whatwg.org/#list": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"list","type":"dfn","url":"https://infra.spec.whatwg.org/#list"},
"https://infra.spec.whatwg.org/#list-contain": {"export":true,"for_":["list","stack","queue","set"],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"contain","type":"dfn","url":"https://infra.spec.whatwg.org/#list-contain"},
"https://infra.spec.whatwg.org/#list-item": {"export":true,"for_":["list","stack","queue","set"],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"item","type":"dfn","url":"https://infra.spec.whatwg.org/#list-item"},
"https://infra.spec.whatwg.org/#list-size": {"export":true,"for_":["list","stack","queue","set"],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"size","type":"dfn","url":"https://infra.spec.whatwg.org/#list-size"},
"https://infra.spec.whatwg.org/#list-sort-in-ascending-order": {"export":true,"for_":["list","stack","queue","set"],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"sorting in ascending order","type":"dfn","url":"https://infra.spec.whatwg.org/#list-sort-in-ascending-order"},
"https://infra.spec.whatwg.org/#map-exists": {"export":true,"for_":["map"],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"exist","type":"dfn","url":"https://infra.spec.whatwg.org/#map-exists"},
"https://infra.spec.whatwg.org/#map-getting-the-keys": {"export":true,"for_":["map"],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"keys","type":"dfn","url":"https://infra.spec.whatwg.org/#map-getting-the-keys"},
"https://infra.spec.whatwg.org/#ordered-map": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"map","type":"dfn","url":"https://infra.spec.whatwg.org/#ordered-map"},
"https://infra.spec.whatwg.org/#string": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"string","type":"dfn","url":"https://infra.spec.whatwg.org/#string"},
"https://infra.spec.whatwg.org/#struct": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"struct","type":"dfn","url":"https://infra.spec.whatwg.org/#struct"},
"https://infra.spec.whatwg.org/#struct-item": {"export":true,"for_":["struct","tuple"],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"item","type":"dfn","url":"https://infra.spec.whatwg.org/#struct-item"},
"https://url.spec.whatwg.org/#concept-url": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"url","spec":"url","status":"current","text":"url","type":"dfn","url":"https://url.spec.whatwg.org/#concept-url"},
"https://url.spec.whatwg.org/#concept-url-host": {"export":true,"for_":["url"],"level":"1","normative":true,"shortname":"url","spec":"url","status":"current","text":"host","type":"dfn","url":"https://url.spec.whatwg.org/#concept-url-host"},
"https://url.spec.whatwg.org/#concept-url-password": {"export":true,"for_":["url"],"level":"1","normative":true,"shortname":"url","spec":"url","status":"current","text":"password","type":"dfn","url":"https://url.spec.whatwg.org/#concept-url-password"},
"https://url.spec.whatwg.org/#concept-url-path": {"export":true,"for_":["url"],"level":"1","normative":true,"shortname":"url","spec":"url","status":"current","text":"path","type":"dfn","url":"https://url.spec.whatwg.org/#concept-url-path"},
"https://url.spec.whatwg.org/#concept-url-port": {"export":true,"for_":["url"],"level":"1","normative":true,"shortname":"url","spec":"url","status":"current","text":"port","type":"dfn","url":"https://url.spec.whatwg.org/#concept-url-port"},
"https://url.spec.whatwg.org/#concept-url-query": {"export":true,"for_":["url"],"level":"1","normative":true,"shortname":"url","spec":"url","status":"current","text":"query","type":"dfn","url":"https://url.spec.whatwg.org/#concept-url-query"},
"https://url.spec.whatwg.org/#concept-url-scheme": {"export":true,"for_":["url"],"level":"1","normative":true,"shortname":"url","spec":"url","status":"current","text":"scheme","type":"dfn","url":"https://url.spec.whatwg.org/#concept-url-scheme"},
"https://url.spec.whatwg.org/#concept-url-username": {"export":true,"for_":["url"],"level":"1","normative":true,"shortname":"url","spec":"url","status":"current","text":"username","type":"dfn","url":"https://url.spec.whatwg.org/#concept-url-username"},
"https://url.spec.whatwg.org/#concept-urlencoded": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"url","spec":"url","status":"current","text":"application/x-www-form-urlencoded","type":"dfn","url":"https://url.spec.whatwg.org/#concept-urlencoded"},
"https://url.spec.whatwg.org/#concept-urlencoded-parser": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"url","spec":"url","status":"current","text":"urlencoded parser","type":"dfn","url":"https://url.spec.whatwg.org/#concept-urlencoded-parser"},
"https://url.spec.whatwg.org/#percent-decode": {"export":true,"for_":["byte sequence"],"level":"1","normative":true,"shortname":"url","spec":"url","status":"current","text":"percent-decode","type":"dfn","url":"https://url.spec.whatwg.org/#percent-decode"},
"https://www.rfc-editor.org/rfc/rfc8941.html#name-boolean": {"export":true,"for_":["structured header"],"level":"","normative":true,"shortname":"rfc8941","spec":"rfc8941","status":"anchor-block","text":"boolean","type":"dfn","url":"https://www.rfc-editor.org/rfc/rfc8941.html#name-boolean"},
"https://www.rfc-editor.org/rfc/rfc8941.html#name-dictionaries": {"export":true,"for_":["structured header"],"level":"","normative":true,"shortname":"rfc8941","spec":"rfc8941","status":"anchor-block","text":"dictionary","type":"dfn","url":"https://www.rfc-editor.org/rfc/rfc8941.html#name-dictionaries"},
"https://www.rfc-editor.org/rfc/rfc8941.html#name-inner-lists": {"export":true,"for_":["structured header"],"level":"","normative":true,"shortname":"rfc8941","spec":"rfc8941","status":"anchor-block","text":"inner list","type":"dfn","url":"https://www.rfc-editor.org/rfc/rfc8941.html#name-inner-lists"},
"https://www.rfc-editor.org/rfc/rfc8941.html#section-1": {"export":true,"for_":[],"level":"","normative":true,"shortname":"rfc8941","spec":"rfc8941","status":"anchor-block","text":"structured header","type":"dfn","url":"https://www.rfc-editor.org/rfc/rfc8941.html#section-1"},
"https://www.rfc-editor.org/rfc/rfc8941.html#text-parse": {"export":true,"for_":[],"level":"","normative":true,"shortname":"rfc8941","spec":"rfc8941","status":"anchor-block","text":"parsing structured fields","type":"dfn","url":"https://www.rfc-editor.org/rfc/rfc8941.html#text-parse"},
};

function mkRefHint(link, ref) {
    const linkText = link.textContent;
    let dfnTextElements = '';
    if (ref.text != linkText) {
        dfnTextElements =
            mk.li({},
                mk.b({}, "Term: "),
                mk.span({}, ref.text)
            );
    }
    const forList = ref.for_;
    let forListElements;
    if(forList.length == 0) {
        forListElements = [];
    } else if(forList.length == 1) {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.span({}, forList[0]),
        );
    } else {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.ul({},
                ...forList.map(forItem =>
                    mk.li({},
                        mk.span({}, forItem)
                    ),
                ),
            ),
        );
    }
    const url = ref.url;
    const safeUrl = encodeURIComponent(url);
    const hintPanel = mk.aside({
        class: "ref-hint",
        id: `ref-hint-for-${safeUrl}`,
        "data-for": url,
        "aria-labelled-by": `ref-hint-for-${safeUrl}`,
    },
        mk.ul({},
            dfnTextElements,
            mk.li({},
                mk.b({}, "URL: "),
                mk.a({ href: url, class: "ref" }, url),
            ),
            mk.li({},
                mk.b({}, "Type: "),
                mk.span({}, `${ref.type}`),
            ),
            mk.li({},
                mk.b({}, "Spec: "),
                mk.span({}, `${ref.spec ? ref.spec : ''}`),
            ),
            forListElements
        ),
    );
    hintPanel.forLink = link;
    setupRefHintEventListeners(link, hintPanel);
    return hintPanel;
}

function hideAllRefHints() {
    queryAll(".ref-hint").forEach(el=>hideRefHint(el));
}

function hideRefHint(refHint) {
    const link = refHint.forLink;
    link.setAttribute("aria-expanded", "false");
    if(refHint.teardownEventListeners) {
        refHint.teardownEventListeners();
    }
    refHint.remove();
}

function showRefHint(link) {
    if(link.classList.contains("dfn-link")) return;
    const url = link.getAttribute("href");
    const ref = refsData[url];
    if(!ref) return;

    hideAllRefHints(); // Only display one at this time.

    const refHint = mkRefHint(link, ref);
    append(document.body, refHint);
    link.setAttribute("aria-expanded", "true");
    positionRefHint(refHint);
}

function setupRefHintEventListeners(link, refHint) {
    if (refHint.teardownEventListeners) return;
    // Add event handlers to hide the refHint after the user moves away
    // from both the link and refHint, if not hovering either within one second.
    let timeout = null;
    const startHidingRefHint = (event) => {
        if (timeout) {
            clearTimeout(timeout);
        }
        timeout = setTimeout(() => {
            hideRefHint(refHint);
        }, 1000);
    }
    const resetHidingRefHint = (event) => {
        if (timeout) clearTimeout(timeout);
        timeout = null;
    };
    link.addEventListener("mouseleave", startHidingRefHint);
    link.addEventListener("mouseenter", resetHidingRefHint);
    link.addEventListener("blur", startHidingRefHint);
    link.addEventListener("focus", resetHidingRefHint);
    refHint.addEventListener("mouseleave", startHidingRefHint);
    refHint.addEventListener("mouseenter", resetHidingRefHint);
    refHint.addEventListener("blur", startHidingRefHint);
    refHint.addEventListener("focus", resetHidingRefHint);

    refHint.teardownEventListeners = () => {
        // remove event listeners
        resetHidingRefHint();
        link.removeEventListener("mouseleave", startHidingRefHint);
        link.removeEventListener("mouseenter", resetHidingRefHint);
        link.removeEventListener("blur", startHidingRefHint);
        link.removeEventListener("focus", resetHidingRefHint);
        refHint.removeEventListener("mouseleave", startHidingRefHint);
        refHint.removeEventListener("mouseenter", resetHidingRefHint);
        refHint.removeEventListener("blur", startHidingRefHint);
        refHint.removeEventListener("focus", resetHidingRefHint);
    };
}

function positionRefHint(refHint) {
    const link = refHint.forLink;
    const linkPos = getBounds(link);
    refHint.style.top = linkPos.bottom + "px";
    refHint.style.left = linkPos.left + "px";

    const panelPos = refHint.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, linkPos.left - overflowAmount);
        refHint.style.left = newLeft + "px";
    }
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function showRefHintListener(e) {
    // If the target isn't in a link (or is a link),
    // just ignore it.
    let link = e.target.closest("a");
    if(!link) return;

    // If the target is in a ref-hint panel
    // (aka a link in the already-open one),
    // also just ignore it.
    if(link.closest(".ref-hint")) return;

    // Otherwise, show the panel for the link.
    showRefHint(link);
}

function hideAllHintsListener(e) {
    // If the click is inside a ref-hint panel, ignore it.
    if(e.target.closest(".ref-hint")) return;
    // Otherwise, close all the current panels.
    hideAllRefHints();
}

document.addEventListener("DOMContentLoaded", () => {
    document.body.addEventListener("mousedown", showRefHintListener);
    document.body.addEventListener("focus", showRefHintListener);

    document.body.addEventListener("click", hideAllHintsListener);
});

window.addEventListener("resize", () => {
    // Hide any open ref hint.
    hideAllRefHints();
});
}
</script>
<script>/* Boilerplate: script-var-click-highlighting */
"use strict";
{
/*
Color-choosing design:

* Colors are ordered by goodness.
* On clicking a var, give it the earliest color
    with the lowest usage in the algorithm.
* On re-clicking, re-use the var's most recent color
    if that's not currently being used elsewhere.
*/

const COLOR_COUNT = 7;

document.addEventListener("click", e=>{
    if(e.target.nodeName == "VAR") {
        highlightSameAlgoVars(e.target);
    }
});

function highlightSameAlgoVars(v) {
    // Find the algorithm container.
    let algoContainer = findAlgoContainer(v);

    // Not highlighting document-global vars,
    // too likely to be unrelated.
    if(algoContainer == null) return;

    const varName = nameFromVar(v);
    if(!v.hasAttribute("data-var-color")) {
        const newColor = chooseHighlightColor(algoContainer, v);
        for(const el of algoContainer.querySelectorAll("var")) {
            if(nameFromVar(el) == varName) {
                el.setAttribute("data-var-color", newColor);
                el.setAttribute("data-var-last-color", newColor);
            }
        }
    } else {
        for(const el of algoContainer.querySelectorAll("var")) {
            if(nameFromVar(el) == varName) {
                el.removeAttribute("data-var-color");
            }
        }
    }
}
function findAlgoContainer(el) {
    while(el != document.body) {
        if(el.hasAttribute("data-algorithm")) return el;
        el = el.parentNode;
    }
    return null;
}
function nameFromVar(el) {
    return el.textContent.replace(/(\s|\xa0)+/g, " ").trim();
}
function colorCountsFromContainer(container) {
    const namesFromColor = Array.from({length:COLOR_COUNT}, x=>new Set());
    for(let v of container.querySelectorAll("var[data-var-color]")) {
        let color = +v.getAttribute("data-var-color");
        namesFromColor[color].add(nameFromVar(v));
    }

    return namesFromColor.map(x=>x.size);
}
function leastUsedColor(colors) {
    // Find the earliest color with the lowest count.
    let minCount = Infinity;
    let minColor = null;
    for(var i = 0; i < colors.length; i++) {
        if(colors[i] < minCount) {
            minColor = i;
            minCount = colors[i];
        }
    }
    return minColor;
}
function chooseHighlightColor(container, v) {
    const colorCounts = colorCountsFromContainer(container);
    if(v.hasAttribute("data-var-last-color")) {
        let color = +v.getAttribute("data-var-last-color");
        if(colorCounts[color] == 0) return color;
    }
    return leastUsedColor(colorCounts);
}
}
</script>